--- dev_mode\index.js (old)
+++ dev_mode\index.js (new)
@@ -1,18 +1,34 @@
-/*
- * Copyright (c) Jupyter Development Team.
- * Distributed under the terms of the Modified BSD License.
- */
+/*-----------------------------------------------------------------------------
+| Copyright (c) Jupyter Development Team.
+| Distributed under the terms of the Modified BSD License.
+|----------------------------------------------------------------------------*/
 
 import { PageConfig } from '@jupyterlab/coreutils';
+
+// Promise.allSettled polyfill, until our supported browsers implement it
+// See https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled
+if (Promise.allSettled === undefined) {
+  Promise.allSettled = promises =>
+    Promise.all(
+      promises.map(promise =>
+        promise
+          .then(value => ({
+            status: "fulfilled",
+            value,
+          }), reason => ({
+            status: "rejected",
+            reason,
+          }))
+      )
+    );
+}
 
 import './style.js';
 
 async function createModule(scope, module) {
   try {
     const factory = await window._JUPYTERLAB[scope].get(module);
-    const instance = factory();
-    instance.__scope__ = scope;
-    return instance;
+    return factory();
   } catch(e) {
     console.warn(`Failed to create module: package: ${scope}; module: ${module}`);
     throw e;
@@ -71,6 +87,8 @@
     PageConfig.getOption('federated_extensions')
   );
 
+  var futureSkipStylesForDisabled = (PageConfig.getOption('futureSkipStylesForDisabled') || '').toLowerCase() === 'true';
+
   const queuedFederated = [];
 
   extensions.forEach(data => {
@@ -83,12 +101,10 @@
       federatedMimeExtensionPromises.push(createModule(data.name, data.mimeExtension));
     }
 
-    if (data.style && !PageConfig.Extension.isDisabled(data.name)) {
+    if (data.style && (!futureSkipStylesForDisabled || !PageConfig.Extension.isDisabled(data.name))) {
       federatedStylePromises.push(createModule(data.name, data.style));
     }
   });
-
-  const allPlugins = [];
 
   /**
    * Iterate over active plugins in an extension.
@@ -108,18 +124,7 @@
 
     let plugins = Array.isArray(exports) ? exports : [exports];
     for (let plugin of plugins) {
-      const isDisabled = PageConfig.Extension.isDisabled(plugin.id);
-      allPlugins.push({
-        id: plugin.id,
-        description: plugin.description,
-        requires: plugin.requires ?? [],
-        optional: plugin.optional ?? [],
-        provides: plugin.provides ?? null,
-        autoStart: plugin.autoStart,
-        enabled: !isDisabled,
-        extension: extension.__scope__
-      });
-      if (isDisabled) {
+      if (PageConfig.Extension.isDisabled(plugin.id)) {
         disabled.push(plugin.id);
         continue;
       }
@@ -137,7 +142,6 @@
   if (!queuedFederated.includes('{{@key}}')) {
     try {
       let ext = require('{{@key}}{{#if this}}/{{this}}{{/if}}');
-      ext.__scope__ = '{{@key}}';
       for (let plugin of activePlugins(ext)) {
         mimeExtensions.push(plugin);
       }
@@ -164,7 +168,6 @@
   if (!queuedFederated.includes('{{@key}}')) {
     try {
       let ext = require('{{@key}}{{#if this}}/{{this}}{{/if}}');
-      ext.__scope__ = '{{@key}}';
       for (let plugin of activePlugins(ext)) {
         register.push(plugin);
       }
@@ -203,17 +206,16 @@
       patterns: PageConfig.Extension.deferred
         .map(function (val) { return val.raw; })
     },
-    availablePlugins: allPlugins
   });
   register.forEach(function(item) { lab.registerPluginModule(item); });
-
-  lab.start({ ignorePlugins, bubblingKeydown: true });
+  lab.start({ ignorePlugins });
 
   // Expose global app instance when in dev mode or when toggled explicitly.
   var exposeAppInBrowser = (PageConfig.getOption('exposeAppInBrowser') || '').toLowerCase() === 'true';
   var devMode = (PageConfig.getOption('devMode') || '').toLowerCase() === 'true';
 
   if (exposeAppInBrowser || devMode) {
+    window.jupyterlab = lab;
     window.jupyterapp = lab;
   }
 