--- jupyterlab\labapp.py (old)
+++ jupyterlab\labapp.py (new)
@@ -1,12 +1,13 @@
+# coding: utf-8
 """A tornado based Jupyter lab server."""
 
 # Copyright (c) Jupyter Development Team.
 # Distributed under the terms of the Modified BSD License.
 
-import dataclasses
 import json
 import os
 import sys
+from os.path import join as pjoin
 
 from jupyter_core.application import JupyterApp, NoStart, base_aliases, base_flags
 from jupyter_server._version import version_info as jpserver_version_info
@@ -19,7 +20,7 @@
     WorkspaceImportApp,
     WorkspaceListApp,
 )
-from notebook_shim.shim import NotebookConfigShimMixin
+from nbclassic.shim import NBClassicConfigShimMixin
 from traitlets import Bool, Instance, Type, Unicode, default
 
 from ._version import __version__
@@ -42,9 +43,6 @@
 )
 from .coreconfig import CoreConfig
 from .debuglog import DebugLogFileMixin
-from .extensions import MANAGERS as EXT_MANAGERS
-from .extensions.manager import PluginManager
-from .extensions.readonly import ReadOnlyExtensionManager
 from .handlers.announcements import (
     CheckForUpdate,
     CheckForUpdateABC,
@@ -55,8 +53,11 @@
 )
 from .handlers.build_handler import Builder, BuildHandler, build_path
 from .handlers.error_handler import ErrorHandler
-from .handlers.extension_manager_handler import ExtensionHandler, extensions_handler_path
-from .handlers.plugin_manager_handler import PluginHandler, plugins_handler_path
+from .handlers.extension_manager_handler import (
+    ExtensionHandler,
+    ExtensionManager,
+    extensions_handler_path,
+)
 
 DEV_NOTE = """You're running JupyterLab from source.
 If you're working on the TypeScript sources of JupyterLab, try running
@@ -83,10 +84,7 @@
 
 build_flags = dict(base_flags)
 
-build_flags["dev-build"] = (
-    {"LabBuildApp": {"dev_build": True}},
-    "Build in development mode.",
-)
+build_flags["dev-build"] = ({"LabBuildApp": {"dev_build": True}}, "Build in development mode.")
 build_flags["no-minimize"] = (
     {"LabBuildApp": {"minimize": False}},
     "Do not minimize a production build.",
@@ -100,9 +98,9 @@
 version = __version__
 app_version = get_app_version()
 if version != app_version:
-    version = f"{__version__} (dev), {app_version} (app)"
-
-build_failure_msg = """Build failed.
+    version = "%s (dev), %s (app)" % (__version__, app_version)
+
+buildFailureMsg = """Build failed.
 Troubleshooting: If the build failed due to an out-of-memory error, you
 may be able to fix it by disabling the `dev_build` and/or `minimize` options.
 
@@ -169,9 +167,7 @@
     )
 
     minimize = Bool(
-        True,
-        config=True,
-        help="Whether to minimize a production build (defaults to True).",
+        True, config=True, help="Whether to minimize a production build (defaults to True)."
     )
 
     pre_clean = Bool(
@@ -204,7 +200,7 @@
                     minimize=self.minimize,
                 )
             except Exception as e:
-                self.log.error(build_failure_msg)
+                print(buildFailureMsg)
                 raise e
 
 
@@ -218,14 +214,8 @@
     {"LabCleanApp": {"extensions": True}},
     "Also delete <app-dir>/extensions.\n%s" % ext_warn_msg,
 )
-clean_flags["settings"] = (
-    {"LabCleanApp": {"settings": True}},
-    "Also delete <app-dir>/settings",
-)
-clean_flags["static"] = (
-    {"LabCleanApp": {"static": True}},
-    "Also delete <app-dir>/static",
-)
+clean_flags["settings"] = ({"LabCleanApp": {"settings": True}}, "Also delete <app-dir>/settings")
+clean_flags["static"] = ({"LabCleanApp": {"static": True}}, "Also delete <app-dir>/static")
 clean_flags["all"] = (
     {"LabCleanApp": {"all": True}},
     "Delete the entire contents of the app directory.\n%s" % ext_warn_msg,
@@ -337,7 +327,7 @@
     There are three sub-commands for export, import or listing of workspaces. This app
         should not otherwise do any work.
     """
-    subcommands = {}
+    subcommands = dict()
     subcommands["export"] = (
         LabWorkspaceExportApp,
         LabWorkspaceExportApp.description.splitlines()[0],
@@ -354,7 +344,7 @@
     def start(self):
         try:
             super().start()
-            self.log.error("One of `export`, `import` or `list` must be specified.")
+            print("One of `export`, `import` or `list` must be specified.")
             self.exit(1)
         except NoStart:
             pass
@@ -414,7 +404,7 @@
 )
 
 
-class LabApp(NotebookConfigShimMixin, LabServerApp):
+class LabApp(NBClassicConfigShimMixin, LabServerApp):
     version = version
 
     name = "lab"
@@ -461,17 +451,10 @@
     aliases["app-dir"] = "LabApp.app_dir"
 
     flags = flags
-    flags["core-mode"] = (
-        {"LabApp": {"core_mode": True}},
-        "Start the app in core mode.",
-    )
+    flags["core-mode"] = ({"LabApp": {"core_mode": True}}, "Start the app in core mode.")
     flags["dev-mode"] = (
         {"LabApp": {"dev_mode": True}},
         "Start the app in dev mode for running from source.",
-    )
-    flags["skip-dev-build"] = (
-        {"LabApp": {"skip_dev_build": True}},
-        "Skip the initial install and JS build of the app in dev mode.",
     )
     flags["watch"] = ({"LabApp": {"watch": True}}, "Start the app in watch mode.")
     flags["splice-source"] = (
@@ -480,7 +463,8 @@
     )
     flags["expose-app-in-browser"] = (
         {"LabApp": {"expose_app_in_browser": True}},
-        "Expose the global app instance to browser via window.jupyterapp.",
+        """Expose the global app instance to browser via window.jupyterapp.
+        It is also available via the deprecated window.jupyterlab name.""",
     )
     flags["extensions-in-dev-mode"] = (
         {"LabApp": {"extensions_in_dev_mode": True}},
@@ -488,27 +472,24 @@
     )
     flags["collaborative"] = (
         {"LabApp": {"collaborative": True}},
-        """To enable real-time collaboration, you must install the extension `jupyter_collaboration`.
-        You can install it using pip for example:
-
-            python -m pip install jupyter_collaboration
-
-        This flag is now deprecated and will be removed in JupyterLab v5.""",
-    )
-    flags["custom-css"] = (
-        {"LabApp": {"custom_css": True}},
-        "Load custom CSS in template html files. Default is False",
-    )
-
-    subcommands = {
-        "build": (LabBuildApp, LabBuildApp.description.splitlines()[0]),
-        "clean": (LabCleanApp, LabCleanApp.description.splitlines()[0]),
-        "path": (LabPathApp, LabPathApp.description.splitlines()[0]),
-        "paths": (LabPathApp, LabPathApp.description.splitlines()[0]),
-        "workspace": (LabWorkspaceApp, LabWorkspaceApp.description.splitlines()[0]),
-        "workspaces": (LabWorkspaceApp, LabWorkspaceApp.description.splitlines()[0]),
-        "licenses": (LabLicensesApp, LabLicensesApp.description.splitlines()[0]),
-    }
+        "Whether to enable collaborative mode.",
+    )
+    flags["future-skip-styles-for-disabled"] = (
+        {"LabApp": {"future_skip_styles_for_disabled": True}},
+        """Whether to skip loading styles for disabled prebuilt extensions.
+        This will be the default behavior starting with JupyterLab 4.0
+        (and this flag will be removed).""",
+    )
+
+    subcommands = dict(
+        build=(LabBuildApp, LabBuildApp.description.splitlines()[0]),
+        clean=(LabCleanApp, LabCleanApp.description.splitlines()[0]),
+        path=(LabPathApp, LabPathApp.description.splitlines()[0]),
+        paths=(LabPathApp, LabPathApp.description.splitlines()[0]),
+        workspace=(LabWorkspaceApp, LabWorkspaceApp.description.splitlines()[0]),
+        workspaces=(LabWorkspaceApp, LabWorkspaceApp.description.splitlines()[0]),
+        licenses=(LabLicensesApp, LabLicensesApp.description.splitlines()[0]),
+    )
 
     default_url = Unicode("/lab", config=True, help="The default URL to redirect to from `/`")
 
@@ -517,8 +498,7 @@
     )
 
     override_theme_url = Unicode(
-        config=True,
-        help=("The override url for static lab theme assets, typically a CDN."),
+        config=True, help=("The override url for static lab theme assets, typically a CDN.")
     )
 
     app_dir = Unicode(None, config=True, help="The app directory to launch JupyterLab from.")
@@ -560,60 +540,31 @@
         against published packages may not work correctly.""",
     )
 
-    extension_manager = Unicode(
-        "pypi",
-        config=True,
-        help="""The extension manager factory to use. The default options are:
-        "readonly" for a manager without installation capability or "pypi" for
-        a manager using PyPi.org and pip to install extensions.""",
-    )
-
     watch = Bool(False, config=True, help="Whether to serve the app in watch mode")
-
-    skip_dev_build = Bool(
-        False,
-        config=True,
-        help="Whether to skip the initial install and JS build of the app in dev mode",
-    )
 
     splice_source = Bool(False, config=True, help="Splice source packages into app directory.")
 
     expose_app_in_browser = Bool(
         False,
         config=True,
-        help="Whether to expose the global app instance to browser via window.jupyterapp",
-    )
-
-    custom_css = Bool(
+        help="Whether to expose the global app instance to browser via window.jupyterlab",
+    )
+
+    future_skip_styles_for_disabled = Bool(
         False,
         config=True,
-        help="""Whether custom CSS is loaded on the page.
-    Defaults to False.
-    """,
-    )
-
-    collaborative = Bool(
-        False,
-        config=True,
-        help="""To enable real-time collaboration, you must install the extension `jupyter_collaboration`.
-        You can install it using pip for example:
-
-            python -m pip install jupyter_collaboration
-
-        This flag is now deprecated and will be removed in JupyterLab v5.""",
-    )
+        help="""Whether to skip loading styles for disabled prebuilt extensions.
+        This will be the default behavior starting with JupyterLab 4.0
+        (and this flag will be removed).""",
+    )
+
+    collaborative = Bool(False, config=True, help="Whether to enable collaborative mode.")
 
     news_url = Unicode(
         "https://jupyterlab.github.io/assets/feed.xml",
         allow_none=True,
         help="""URL that serves news Atom feed; by default the JupyterLab organization announcements will be fetched. Set to None to turn off fetching announcements.""",
         config=True,
-    )
-
-    lock_all_plugins = Bool(
-        False,
-        config=True,
-        help="Whether all plugins are locked (cannot be enabled/disabled from the UI)",
     )
 
     check_for_updates_class = Type(
@@ -667,7 +618,7 @@
         if self.override_static_url:
             return self.override_static_url
         else:
-            static_url = f"/static/{self.name}/"
+            static_url = "/static/{name}/".format(name=self.name)
             return ujoin(self.serverapp.base_url, static_url)
 
     @default("theme_url")
@@ -687,11 +638,11 @@
             self.log.info("Running JupyterLab in dev mode")
 
         if self.watch and self.core_mode:
-            self.log.warning("Cannot watch in core mode, did you mean --dev-mode?")
+            self.log.warn("Cannot watch in core mode, did you mean --dev-mode?")
             self.watch = False
 
         if self.core_mode and self.dev_mode:
-            self.log.warning("Conflicting modes, choosing dev_mode over core_mode")
+            self.log.warn("Conflicting modes, choosing dev_mode over core_mode")
             self.core_mode = False
 
         # Set the paths based on JupyterLab's mode.
@@ -700,18 +651,8 @@
             self.static_paths = [dev_static_dir]
             self.template_paths = [dev_static_dir]
             if not self.extensions_in_dev_mode:
-                # Add an exception for @jupyterlab/galata-extension
-                galata_extension = pjoin(HERE, "galata")
-                self.labextensions_path = (
-                    [galata_extension]
-                    if galata_extension in map(os.path.abspath, self.labextensions_path)
-                    else []
-                )
-                self.extra_labextensions_path = (
-                    [galata_extension]
-                    if galata_extension in map(os.path.abspath, self.extra_labextensions_path)
-                    else []
-                )
+                self.labextensions_path = []
+                self.extra_labextensions_path = []
         elif self.core_mode:
             dev_static_dir = ujoin(HERE, "static")
             self.static_paths = [dev_static_dir]
@@ -722,11 +663,11 @@
             self.static_paths = [self.static_dir]
             self.template_paths = [self.templates_dir]
 
-    def _prepare_templates(self):
-        super()._prepare_templates()
-        self.jinja2_env.globals.update(custom_css=self.custom_css)
-
-    def initialize_handlers(self):  # noqa
+    def initialize_settings(self):
+        super().initialize_settings()
+
+    def initialize_handlers(self):
+
         handlers = []
 
         # Set config for Jupyterlab
@@ -734,10 +675,12 @@
         page_config.setdefault("buildAvailable", not self.core_mode and not self.dev_mode)
         page_config.setdefault("buildCheck", not self.core_mode and not self.dev_mode)
         page_config["devMode"] = self.dev_mode
-        page_config["token"] = self.serverapp.identity_provider.token
+        page_config["token"] = self.serverapp.token
         page_config["exposeAppInBrowser"] = self.expose_app_in_browser
         page_config["quitButton"] = self.serverapp.quit_button
+        page_config["collaborative"] = self.collaborative
         page_config["allow_hidden_files"] = self.serverapp.contents_manager.allow_hidden
+        page_config["futureSkipStylesForDisabled"] = self.future_skip_styles_for_disabled
 
         # Client-side code assumes notebookVersion is a JSON-encoded string
         page_config["notebookVersion"] = json.dumps(jpserver_version_info)
@@ -745,25 +688,13 @@
         self.log.info("JupyterLab extension loaded from %s" % HERE)
         self.log.info("JupyterLab application directory is %s" % self.app_dir)
 
-        if self.custom_css:
-            handlers.append(
-                (
-                    r"/custom/(.*)(?<!\.js)$",
-                    self.serverapp.web_app.settings["static_handler_class"],
-                    {
-                        "path": self.serverapp.web_app.settings["static_custom_path"],
-                        "no_cache_paths": ["/"],  # don't cache anything in custom
-                    },
-                )
-            )
-
-        app_options = AppOptions(
+        build_handler_options = AppOptions(
             logger=self.log,
             app_dir=self.app_dir,
             labextensions_path=self.extra_labextensions_path + self.labextensions_path,
             splice_source=self.splice_source,
         )
-        builder = Builder(self.core_mode, app_options=app_options)
+        builder = Builder(self.core_mode, app_options=build_handler_options)
         build_handler = (build_path, BuildHandler, {"builder": builder})
         handlers.append(build_handler)
 
@@ -773,7 +704,7 @@
             self.log.info(CORE_NOTE.strip())
             ensure_core(self.log)
         elif self.dev_mode:
-            if not (self.watch or self.skip_dev_build):
+            if not self.watch:
                 ensure_dev(self.log)
                 self.log.info(DEV_NOTE)
         else:
@@ -791,87 +722,14 @@
             if self.dev_mode:
                 watch_dev(self.log)
             else:
-                watch(app_options=app_options)
+                watch(app_options=build_handler_options)
                 page_config["buildAvailable"] = False
             self.cache_files = False
 
         if not self.core_mode and not errored:
-            # Add extension management handlers
-            provider = self.extension_manager
-            entry_point = EXT_MANAGERS.get(provider)
-            if entry_point is None:
-                self.log.error(f"Extension Manager: No manager defined for provider '{provider}'.")
-                raise NotImplementedError()
-            else:
-                self.log.info(f"Extension Manager is '{provider}'.")
-            manager_factory = entry_point.load()
-            config = self.settings.get("config", {}).get("LabServerApp", {})
-
-            blocked_extensions_uris = config.get("blocked_extensions_uris", "")
-            allowed_extensions_uris = config.get("allowed_extensions_uris", "")
-
-            if (blocked_extensions_uris) and (allowed_extensions_uris):
-                self.log.error(
-                    "Simultaneous LabServerApp.blocked_extensions_uris and LabServerApp.allowed_extensions_uris is not supported. Please define only one of those."
-                )
-                import sys
-
-                sys.exit(-1)
-
-            listings_config = {
-                "blocked_extensions_uris": set(
-                    filter(lambda uri: len(uri) > 0, blocked_extensions_uris.split(","))
-                ),
-                "allowed_extensions_uris": set(
-                    filter(lambda uri: len(uri) > 0, allowed_extensions_uris.split(","))
-                ),
-                "listings_refresh_seconds": config.get("listings_refresh_seconds", 60 * 60),
-                "listings_tornado_options": config.get("listings_tornado_options", {}),
-            }
-            if len(listings_config["blocked_extensions_uris"]) or len(
-                listings_config["allowed_extensions_uris"]
-            ):
-                self.log.debug(f"Extension manager will be constrained by {listings_config}")
-
-            try:
-                ext_manager = manager_factory(app_options, listings_config, self)
-                metadata = dataclasses.asdict(ext_manager.metadata)
-            except Exception as err:
-                self.log.warning(
-                    f"Failed to instantiate the extension manager {provider}. Falling back to read-only manager.",
-                    exc_info=err,
-                )
-                ext_manager = ReadOnlyExtensionManager(app_options, listings_config, self)
-                metadata = dataclasses.asdict(ext_manager.metadata)
-
-            page_config["extensionManager"] = metadata
-            ext_handler = (
-                extensions_handler_path,
-                ExtensionHandler,
-                {"manager": ext_manager},
-            )
+            ext_manager = ExtensionManager(app_options=build_handler_options)
+            ext_handler = (extensions_handler_path, ExtensionHandler, {"manager": ext_manager})
             handlers.append(ext_handler)
-
-            # Add plugin manager handlers
-            lock_rules = frozenset(
-                {rule for rule, value in page_config.get("lockedExtensions", {}).items() if value}
-            )
-            handlers.append(
-                (
-                    plugins_handler_path,
-                    PluginHandler,
-                    {
-                        "manager": PluginManager(
-                            app_options=app_options,
-                            ext_options={
-                                "lock_rules": lock_rules,
-                                "all_locked": self.lock_all_plugins,
-                            },
-                            parent=self,
-                        )
-                    },
-                )
-            )
 
             # Add announcement handlers
             page_config["news"] = {"disabled": self.news_url is None}
@@ -921,22 +779,16 @@
     def initialize(self, argv=None):
         """Subclass because the ExtensionApp.initialize() method does not take arguments"""
         super().initialize()
-        if self.collaborative:
-            try:
-                import jupyter_collaboration  # noqa
-            except ImportError:
-                self.log.critical(
-                    """\
-Jupyter Lab cannot start, because `jupyter_collaboration` was configured but cannot be `import`ed.
-
-To fix this, either:
-
-1) install the extension `jupyter-collaboration`; for example: `python -m pip install jupyter-collaboration`
-
-2) disable collaboration; for example, remove the `--collaborative` flag from the commandline.  To see more ways to adjust the collaborative behavior, see https://jupyterlab-realtime-collaboration.readthedocs.io/en/latest/configuration.html .
-"""
-                )
-                sys.exit(1)
+
+        if self.collaborative and jpserver_version_info < (2, 0, 0):
+            jpserver_version = ".".join(filter(lambda p: len(p) > 0, map(str, jpserver_version_info)))
+            self.log.critical(f"""To enable real-time collaboration, you must install Jupyter Server v2 (current version is {jpserver_version}).
+
+You can install it using pip for example:
+
+  python -m pip install "jupyter_server>=2.0.0"
+""")
+            sys.exit(1)
 
 
 # -----------------------------------------------------------------------------