--- buildutils\src\ensure-repo.ts (old)
+++ buildutils\src\ensure-repo.ts (new)
@@ -24,43 +24,35 @@
 
 type Dict<T> = { [key: string]: T };
 
-type CoreData = Map<string, any>;
-
 // URL config for this branch
 // Source and target branches
 // Target RTD version name
-// For main these will be the same, for other branches the source
+// For master these will be the same, for other branches the source
 // branch is whichever branch it was created from
 // The current release branch should target RTD stable
-// Main should target latest
+// Master should target latest
 // All other release branches should target a specific named version
 const URL_CONFIG = {
-  source: 'main',
-  target: '4.2.x',
-  rtdVersion: 'stable'
+  source: '3.5.x',
+  target: '3.6.x',
+  rtdVersion: '3.6.x'
 };
 
 // Data to ignore.
 const MISSING: Dict<string[]> = {
   '@jupyterlab/coreutils': ['path'],
-  '@jupyterlab/buildutils': [
-    'assert',
-    'child_process',
-    'fs',
-    'path',
-    'webpack'
-  ],
-  '@jupyterlab/builder': ['path'],
-  '@jupyterlab/galata': ['fs', 'path', '@jupyterlab/galata'],
-  '@jupyterlab/markedparser-extension': ['Tokens', 'MarkedOptions'],
-  '@jupyterlab/testing': ['child_process', 'fs', 'path'],
+  '@jupyterlab/buildutils': ['path', 'webpack'],
+  '@jupyterlab/builder': ['path', 'crypto'],
+  '@jupyterlab/galata': ['fs', 'path'],
+  '@jupyterlab/testutils': ['fs', 'path'],
   '@jupyterlab/vega5-extension': ['vega-embed']
 };
 
 const UNUSED: Dict<string[]> = {
   // url is a polyfill for sanitize-html
-  '@jupyterlab/apputils': ['@types/react'],
+  '@jupyterlab/apputils': ['@types/react', 'url'],
   '@jupyterlab/application': ['@fortawesome/fontawesome-free'],
+  '@jupyterlab/apputils-extension': ['es6-promise'],
   '@jupyterlab/builder': [
     '@lumino/algorithm',
     '@lumino/application',
@@ -78,72 +70,42 @@
     // The libraries needed for building other extensions.
     '@babel/core',
     '@babel/preset-env',
+    'babel-loader',
     'css-loader',
+    'file-loader',
     'path-browserify',
     'process',
+    'raw-loader',
     'style-loader',
+    'svg-url-loader',
     'terser-webpack-plugin',
+    'to-string-loader',
+    'url-loader',
     'webpack-cli',
     'worker-loader',
     'source-map-loader'
   ],
-  '@jupyterlab/buildutils': ['inquirer', 'verdaccio'],
-  '@jupyterlab/codemirror': [
-    '@codemirror/lang-cpp',
-    '@codemirror/lang-css',
-    '@codemirror/lang-html',
-    '@codemirror/lang-java',
-    '@codemirror/lang-javascript',
-    '@codemirror/lang-json',
-    '@codemirror/lang-markdown',
-    '@codemirror/lang-php',
-    '@codemirror/lang-python',
-    '@codemirror/lang-rust',
-    '@codemirror/lang-sql',
-    '@codemirror/lang-wast',
-    '@codemirror/lang-xml',
-    '@codemirror/legacy-modes'
-  ],
-  '@jupyterlab/codemirror-extension': [
-    '@codemirror/lang-markdown',
-    '@codemirror/legacy-modes'
-  ],
+  '@jupyterlab/buildutils': ['verdaccio'],
   '@jupyterlab/coreutils': ['path-browserify'],
-  '@jupyterlab/fileeditor': ['regexp-match-indices'],
-  '@jupyterlab/markedparser-extension': [
-    // only (but always) imported asynchronously
-    'marked-gfm-heading-id',
-    'marked-mangle'
-  ],
-  '@jupyterlab/services': ['ws'],
-  '@jupyterlab/testing': [
-    '@babel/core',
-    '@babel/preset-env',
-    'fs-extra',
+  '@jupyterlab/galata': ['node-fetch', 'http-server'],
+  '@jupyterlab/services': ['node-fetch', 'ws'],
+  '@jupyterlab/shared-models': ['@jupyter/ydoc', '@jupyterlab/nbformat'],
+  '@jupyterlab/rendermime': ['@jupyterlab/mathjax2'],
+  '@jupyterlab/testutils': [
+    'node-fetch',
     'identity-obj-proxy',
-    'jest-environment-jsdom',
-    'jest-junit'
-  ],
-  '@jupyterlab/testutils': [
-    '@jupyterlab/application',
-    '@jupyterlab/apputils',
-    '@jupyterlab/notebook',
-    '@jupyterlab/rendermime'
+    'jest-raw-loader',
+    'markdown-loader-jest',
+    'jest-junit',
+    'jest-summary-reporter'
   ],
   '@jupyterlab/test-csvviewer': ['csv-spectrum'],
-  '@jupyterlab/vega5-extension': ['vega', 'vega-lite']
+  '@jupyterlab/vega5-extension': ['vega', 'vega-lite'],
+  '@jupyterlab/ui-components': ['@blueprintjs/icons']
 };
 
 // Packages that are allowed to have differing versions
 const DIFFERENT_VERSIONS: Array<string> = ['vega-lite', 'vega', 'vega-embed'];
-
-// Packages that have backward versions support
-const BACKWARD_VERSIONS: Record<string, Record<string, string>> = {
-  '@jupyterlab/rendermime-interfaces': {
-    '@lumino/coreutils': '^1.11.0',
-    '@lumino/widgets': '^1.37.2'
-  }
-};
 
 const SKIP_CSS: Dict<string[]> = {
   '@jupyterlab/application': ['@jupyterlab/rendermime'],
@@ -162,7 +124,9 @@
     '@lumino/virtualdom',
     '@lumino/widgets'
   ],
+  '@jupyterlab/codemirror-extension': ['codemirror'],
   '@jupyterlab/completer': ['@jupyterlab/codeeditor'],
+  '@jupyterlab/debugger': ['codemirror'],
   '@jupyterlab/docmanager': ['@jupyterlab/statusbar'], // Statusbar styles should not be used by status reporters
   '@jupyterlab/docregistry': [
     '@jupyterlab/codeeditor', // Only used for model
@@ -174,27 +138,12 @@
     '@jupyterlab/codeeditor',
     '@jupyterlab/codemirror',
     '@jupyterlab/fileeditor',
-    '@jupyterlab/notebook'
+    '@jupyterlab/notebook',
+    'codemirror'
   ],
   '@jupyterlab/filebrowser': ['@jupyterlab/statusbar'],
   '@jupyterlab/fileeditor': ['@jupyterlab/statusbar'],
-  '@jupyterlab/galata': [
-    '@jupyterlab/application',
-    '@jupyterlab/apputils',
-    '@jupyterlab/debugger',
-    '@jupyterlab/docmanager',
-    '@jupyterlab/notebook'
-  ],
-  '@jupyterlab/galata-extension': [
-    '@jupyterlab/application',
-    '@jupyterlab/apputils',
-    '@jupyterlab/cells',
-    '@jupyterlab/debugger',
-    '@jupyterlab/docmanager',
-    '@jupyterlab/notebook'
-  ],
   '@jupyterlab/help-extension': ['@jupyterlab/application'],
-  '@jupyterlab/lsp': ['codemirror'],
   '@jupyterlab/metapackage': [
     '@jupyterlab/ui-components',
     '@jupyterlab/apputils',
@@ -217,6 +166,7 @@
     '@jupyterlab/notebook',
     '@jupyterlab/cell-toolbar',
     '@jupyterlab/cell-toolbar-extension',
+    '@jupyterlab/celltags',
     '@jupyterlab/celltags-extension',
     '@jupyterlab/fileeditor',
     '@jupyterlab/codemirror-extension',
@@ -227,10 +177,12 @@
     '@jupyterlab/console-extension',
     '@jupyterlab/csvviewer',
     '@jupyterlab/documentsearch',
+    '@jupyterlab/docprovider',
     '@jupyterlab/csvviewer-extension',
     '@jupyterlab/debugger',
     '@jupyterlab/debugger-extension',
     '@jupyterlab/docmanager-extension',
+    '@jupyterlab/docprovider-extension',
     '@jupyterlab/documentsearch-extension',
     '@jupyterlab/extensionmanager',
     '@jupyterlab/extensionmanager-extension',
@@ -249,22 +201,14 @@
     '@jupyterlab/launcher-extension',
     '@jupyterlab/logconsole',
     '@jupyterlab/logconsole-extension',
-    '@jupyterlab/lsp',
-    '@jupyterlab/lsp-extension',
     '@jupyterlab/mainmenu-extension',
     '@jupyterlab/markdownviewer',
     '@jupyterlab/markdownviewer-extension',
-    '@jupyterlab/markedparser-extension',
-    '@jupyterlab/mathjax-extension',
-    '@jupyterlab/mermaid',
-    '@jupyterlab/mermaid-extension',
-    '@jupyterlab/metadataform',
-    '@jupyterlab/metadataform-extension',
+    '@jupyterlab/mathjax2',
+    '@jupyterlab/mathjax2-extension',
     '@jupyterlab/nbconvert-css',
     '@jupyterlab/notebook-extension',
     '@jupyterlab/pdf-extension',
-    '@jupyterlab/pluginmanager',
-    '@jupyterlab/pluginmanager-extension',
     '@jupyterlab/rendermime-extension',
     '@jupyterlab/running',
     '@jupyterlab/running-extension',
@@ -282,18 +226,22 @@
     '@jupyterlab/tooltip-extension',
     '@jupyterlab/translation-extension',
     '@jupyterlab/ui-components-extension',
-    '@jupyterlab/vega5-extension',
-    '@jupyterlab/workspaces-extension'
+    '@jupyterlab/collaboration',
+    '@jupyterlab/collaboration-extension',
+    '@jupyterlab/vdom',
+    '@jupyterlab/vdom-extension',
+    '@jupyterlab/vega5-extension'
   ],
-  '@jupyterlab/notebook': ['@jupyterlab/application'],
   '@jupyterlab/rendermime-interfaces': ['@lumino/widgets'],
   '@jupyterlab/shortcuts-extension': ['@jupyterlab/application'],
   '@jupyterlab/testutils': [
-    '@jupyterlab/application',
     '@jupyterlab/apputils',
-    '@jupyterlab/notebook',
+    '@jupyterlab/codeeditor',
+    '@jupyterlab/codemirror',
     '@jupyterlab/rendermime',
-    '@jupyterlab/testing'
+    '@jupyterlab/docregistry',
+    '@jupyterlab/cells',
+    '@jupyterlab/notebook'
   ],
   '@jupyterlab/theme-light-extension': [
     '@jupyterlab/application',
@@ -302,7 +250,8 @@
   '@jupyterlab/theme-dark-extension': [
     '@jupyterlab/application',
     '@jupyterlab/apputils'
-  ]
+  ],
+  '@jupyterlab/ui-extension': ['@blueprintjs/icons']
 };
 
 const pkgData: Dict<any> = {};
@@ -342,10 +291,7 @@
     .trim()
     .split(/\r?\n/);
   files = files.filter(filePath => {
-    return (
-      fileTypes.indexOf(path.extname(filePath)) !== -1 &&
-      !filePath.endsWith('_static/switcher.json')
-    );
+    return fileTypes.indexOf(path.extname(filePath)) !== -1;
   });
 
   // Set up string replacements
@@ -431,7 +377,7 @@
     let valid = true;
 
     // Ensure it is a dependency.
-    if (!mpData.dependencies[name] && name !== '@jupyterlab/testing') {
+    if (!mpData.dependencies[name]) {
       valid = false;
       mpData.dependencies[name] = '^' + data.version;
     }
@@ -464,12 +410,27 @@
 }
 
 /**
- * Get the core data for the given core paths.
+ * Ensure the jupyterlab application package.
  */
-function getCoreData(corePaths: string[]): CoreData {
+function ensureJupyterlab(): string[] {
+  const basePath = path.resolve('.');
+  const corePath = path.join(basePath, 'dev_mode', 'package.json');
+  const corePackage = utils.readJSONFile(corePath);
+
+  corePackage.jupyterlab.extensions = {};
+  corePackage.jupyterlab.mimeExtensions = {};
+  corePackage.jupyterlab.linkedPackages = {};
+  // start with known external dependencies
+  corePackage.dependencies = Object.assign(
+    {},
+    corePackage.jupyterlab.externalExtensions
+  );
+  corePackage.resolutions = {};
+
+  const singletonPackages: string[] = corePackage.jupyterlab.singletonPackages;
   const coreData = new Map<string, any>();
 
-  corePaths.forEach(pkgPath => {
+  utils.getCorePaths().forEach(pkgPath => {
     const dataPath = path.join(pkgPath, 'package.json');
     let data: any;
     try {
@@ -479,29 +440,6 @@
     }
 
     coreData.set(data.name, data);
-  });
-
-  return coreData;
-}
-
-/**
- * Ensure a core package.
- */
-function ensureCorePackage(corePackage: any, corePaths: string[]) {
-  corePackage.jupyterlab.extensions = {};
-  corePackage.dependencies = {};
-
-  const singletonPackages: string[] = corePackage.jupyterlab.singletonPackages;
-  const coreData = getCoreData(corePaths);
-
-  corePaths.forEach(pkgPath => {
-    const dataPath = path.join(pkgPath, 'package.json');
-    let data: any;
-    try {
-      data = utils.readJSONFile(dataPath);
-    } catch (e) {
-      return;
-    }
 
     // If the package has a tokens.ts file, make sure it is noted as a singleton
     if (
@@ -548,69 +486,7 @@
       )}`
     );
   }
-}
-
-/**
- * Ensure the federated example core package.
- */
-function ensureFederatedExample(): string[] {
-  const basePath = path.resolve('.');
-  const corePath = path.join(
-    basePath,
-    'examples',
-    'federated',
-    'core_package',
-    'package.json'
-  );
-  const corePackage = utils.readJSONFile(corePath);
-  // the list of dependencies might differ from the main JupyterLab application
-  const dependencies = new Set(Object.keys(corePackage.dependencies));
-
-  const corePaths = utils.getCorePaths().filter(p => {
-    return dependencies.has(`@jupyterlab/${path.basename(p)}`);
-  });
-
-  ensureCorePackage(corePackage, corePaths);
-
-  const coreData = getCoreData(corePaths);
-  corePackage.jupyterlab.extensions = [];
-  coreData.forEach((data, name) => {
-    // Make sure it is included as a dependency.
-    corePackage.dependencies[data.name] = `^${data.version}`;
-
-    const meta = data.jupyterlab;
-    const keep = meta?.extension || meta?.mimeExtension;
-    if (!keep) {
-      return;
-    }
-    corePackage.jupyterlab.extensions.push(name);
-  });
-
-  corePackage.jupyterlab.extensions.sort();
-
-  // Write the package.json back to disk.
-  if (utils.writePackageData(corePath, corePackage)) {
-    return ['Updated federated example'];
-  }
-  return [];
-}
-
-/**
- * Ensure the jupyterlab application package.
- */
-function ensureJupyterlab(): string[] {
-  const basePath = path.resolve('.');
-  const corePath = path.join(basePath, 'dev_mode', 'package.json');
-  const corePackage = utils.readJSONFile(corePath);
-  const corePaths = utils.getCorePaths();
-
-  ensureCorePackage(
-    corePackage,
-    corePaths.filter(p => !/\/packages\/testing$/.test(p))
-  );
-  corePackage.jupyterlab.mimeExtensions = {};
-
-  const coreData = getCoreData(corePaths);
+
   coreData.forEach((data, name) => {
     // Determine if the package wishes to be included in the top-level
     // dependencies.
@@ -628,7 +504,7 @@
 
     // Handle extensions.
     ['extension', 'mimeExtension'].forEach(item => {
-      let ext = data.jupyterlab[item];
+      let ext = meta[item];
       if (ext === true) {
         ext = '';
       }
@@ -639,7 +515,6 @@
     });
   });
 
-  corePackage.jupyterlab.linkedPackages = {};
   utils.getLernaPaths().forEach(pkgPath => {
     const dataPath = path.join(pkgPath, 'package.json');
     let data: any;
@@ -659,10 +534,6 @@
     );
     corePackage.jupyterlab.linkedPackages[data.name] = relativePath;
   });
-
-  // Update the dev mode version.
-  const curr = utils.getPythonVersion();
-  corePackage.jupyterlab.version = curr;
 
   // Write the package.json back to disk.
   if (utils.writePackageData(corePath, corePackage)) {
@@ -695,6 +566,36 @@
 }
 
 /**
+ * Ensure lockfile structure
+ */
+function ensureLockfile(): string[] {
+  const staging = './jupyterlab/staging';
+  const lockFile = path.join(staging, 'yarn.lock');
+  const content = fs.readFileSync(lockFile, { encoding: 'utf-8' });
+  let newContent = content;
+  const messages = [];
+
+  // Verify that all packages have resolved to the correct (default) registry
+  const resolvedPattern = /^\s*resolved "((?!https:\/\/registry\.yarnpkg\.com\/).*)"\s*$/gm;
+  let badRegistry;
+  while ((badRegistry = resolvedPattern.exec(content)) !== null) {
+    messages.push(`Fixing bad npm/yarn registry: ${badRegistry[1]}`);
+    const parsed = new URL(badRegistry[1]);
+    const newUrl = badRegistry[1].replace(
+      parsed.origin,
+      'https://registry.yarnpkg.com'
+    );
+    newContent = newContent.replace(badRegistry[1], newUrl);
+  }
+
+  if (content !== newContent) {
+    // Write the updated lockfile data back
+    fs.writeFileSync(lockFile, newContent, 'utf-8');
+  }
+  return messages;
+}
+
+/**
  * Ensure the repo integrity.
  */
 export async function ensureIntegrity(): Promise<boolean> {
@@ -820,8 +721,7 @@
       locals,
       cssImports: cssImports[name],
       cssModuleImports: cssModuleImports[name],
-      differentVersions: DIFFERENT_VERSIONS,
-      backwardVersions: BACKWARD_VERSIONS
+      differentVersions: DIFFERENT_VERSIONS
     };
 
     if (name === '@jupyterlab/metapackage') {
@@ -844,6 +744,12 @@
     messages[pkgName] = messages[pkgName].concat(pkgMessages);
   }
 
+  // Ensure the staging area lockfile
+  const lockFileMessages = ensureLockfile();
+  if (lockFileMessages.length > 0) {
+    messages['lockfile'] = lockFileMessages;
+  }
+
   // Handle the top level package.
   const corePath = path.resolve('.', 'package.json');
   const coreData: any = utils.readJSONFile(corePath);
@@ -851,13 +757,44 @@
     messages['top'] = ['Update package.json'];
   }
 
+  // Handle the refs in the top level tsconfigdoc.json
+  const tsConfigDocExclude = [
+    'application-extension',
+    'metapackage',
+    'nbconvert-css'
+  ];
+  const tsConfigdocPath = path.resolve('.', 'tsconfigdoc.json');
+  const tsConfigdocData = utils.readJSONFile(tsConfigdocPath);
+  tsConfigdocData.references = utils
+    .getCorePaths()
+    .filter(pth => !tsConfigDocExclude.some(pkg => pth.includes(pkg)))
+    .map(pth => {
+      return { path: './' + path.relative('.', pth).replace(/\\/g, '/') };
+    });
+  utils.writeJSONFile(tsConfigdocPath, tsConfigdocData);
+
   // Handle buildutils
   ensureBuildUtils();
 
-  // Handle the federated example application
-  pkgMessages = ensureFederatedExample();
-  if (pkgMessages.length > 0) {
-    messages['@jupyterlab/example-federated-core'] = pkgMessages;
+  // Handle the pyproject.toml file
+  const pyprojectPath = path.resolve('.', 'pyproject.toml');
+  const curr = utils.getPythonVersion();
+  let tag = 'latest';
+  if (!/\d+\.\d+\.\d+$/.test(curr)) {
+    tag = 'next';
+  }
+  const publishCommand = `npm publish --tag ${tag}`;
+  let pyprojectText = fs.readFileSync(pyprojectPath, { encoding: 'utf8' });
+  if (pyprojectText.indexOf(publishCommand) === -1) {
+    pyprojectText = pyprojectText.replace(
+      /npm publish --tag [a-z]+/,
+      publishCommand
+    );
+    fs.writeFileSync(pyprojectPath, pyprojectText, { encoding: 'utf8' });
+    if (!messages['top']) {
+      messages['top'] = [];
+    }
+    messages['top'].push('Update npm publish command in pyproject.toml');
   }
 
   // Handle the JupyterLab application top package.
@@ -875,13 +812,7 @@
       );
       process.exit(1);
     }
-    try {
-      utils.run('jlpm install');
-    } catch (error) {
-      // Fallback in case this script is called during editable installation
-      utils.run(`node jupyterlab/staging/yarn.js install`);
-    }
-
+    utils.run('jlpm install');
     console.debug('\n\nMade integrity changes!');
     console.debug('Please commit the changes by running:');
     console.debug('git commit -a -m "Package integrity updates"');