--- buildutils\src\update-core-mode.ts (old)
+++ buildutils\src\update-core-mode.ts (new)
@@ -6,7 +6,6 @@
 import * as fs from 'fs-extra';
 import * as path from 'path';
 import * as utils from './utils';
-import { upgradeLock } from './update-staging-lock';
 
 // Run integrity to update the dev_mode package.json
 utils.run('jlpm integrity');
@@ -23,7 +22,7 @@
 const staging = './jupyterlab/staging';
 
 // Ensure a clean staging directory.
-const keep = ['yarn.js', '.yarnrc.yml'];
+const keep = ['yarn.js', '.yarnrc'];
 fs.readdirSync(staging).forEach(name => {
   if (keep.indexOf(name) === -1) {
     fs.removeSync(path.join(staging, name));
@@ -63,15 +62,13 @@
   path.join('.', 'yarn.lock'),
   path.join('.', 'jupyterlab', 'staging', 'yarn.lock')
 );
-process.env.YARN_UNSAFE_HTTP_WHITELIST = '0.0.0.0';
-upgradeLock('@jupyterlab/*', {
-  lock: path.join(staging, 'yarn.lock'),
-  cwd: staging
-});
-utils.run('jlpm dlx yarn-berry-deduplicate --strategy fewerHighest', {
-  cwd: staging
-});
 utils.run('jlpm', { cwd: staging });
+try {
+  utils.run('jlpm yarn-deduplicate -s fewer --fail', { cwd: staging });
+} catch {
+  // re-run install if we deduped packages!
+  utils.run('jlpm', { cwd: staging });
+}
 
 // Build the core assets.
 utils.run('jlpm run build:prod:release', { cwd: staging });