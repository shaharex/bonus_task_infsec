--- buildutils\src\local-repository.ts (old)
+++ buildutils\src\local-repository.ts (new)
@@ -1,11 +1,6 @@
-/*
- * Copyright (c) Jupyter Development Team.
- * Distributed under the terms of the Modified BSD License.
- */
-
-/* eslint-disable camelcase */
 import * as fs from 'fs-extra';
 import * as child_process from 'child_process';
+import * as crypto from 'crypto';
 import * as path from 'path';
 import * as os from 'os';
 import * as ps from 'process';
@@ -32,21 +27,17 @@
 
   // Get current registry values
   let prev_npm = utils.run('npm config get registry', { stdio: 'pipe' }, true);
-  let prev_jlpm = '';
-  try {
-    prev_jlpm = utils.run(
-      'jlpm config get npmRegistryServer',
-      { stdio: 'pipe' },
-      true
-    );
+  let prev_yarn = '';
+  try {
+    prev_yarn = utils.run('yarn config get registry', { stdio: 'pipe' }, true);
   } catch (e) {
     // Do nothing
   }
   if (!prev_npm || prev_npm.indexOf('0.0.0.0') !== -1) {
     prev_npm = 'https://registry.npmjs.org/';
   }
-  if (prev_jlpm.indexOf('0.0.0.0') !== -1) {
-    prev_jlpm = '';
+  if (prev_yarn.indexOf('0.0.0.0') !== -1) {
+    prev_yarn = '';
   }
 
   // write the config file
@@ -126,7 +117,7 @@
   const info_file = path.join(out_dir, 'info.json');
   const data = {
     prev_npm,
-    prev_jlpm,
+    prev_yarn,
     pid: subproc.pid
   };
   utils.writeJSONFile(info_file, data);
@@ -140,21 +131,9 @@
     local_registry
   ]);
   try {
-    child_process.execFileSync('jlpm', [
-      'config',
-      'set',
-      'npmRegistryServer',
-      local_registry
-    ]);
-    child_process.execFileSync('jlpm', [
-      'config',
-      'set',
-      'unsafeHttpWhitelist',
-      '--json',
-      '["0.0.0.0"]'
-    ]);
+    child_process.execSync(`yarn config set registry "${local_registry}"`);
   } catch (e) {
-    // jlpm not available
+    // yarn not available
   }
 
   // Log in using cli and temp credentials
@@ -245,19 +224,44 @@
   } else {
     child_process.execSync(`npm config rm registry`);
   }
-  if (data.prev_jlpm) {
-    child_process.execSync(
-      `jlpm config set npmRegistryServer ${data.prev_jlpm}`
-    );
-    child_process.execSync(`jlpm config unset unsafeHttpWhitelist`);
+  if (data.prev_yarn) {
+    child_process.execSync(`yarn config set registry ${data.prev_yarn}`);
   } else {
     try {
-      child_process.execSync(`jlpm config unset npmRegistryServer`);
-      child_process.execSync(`jlpm config unset unsafeHttpWhitelist`);
+      child_process.execSync(`yarn config delete registry`);
     } catch (e) {
-      // jlpm not available
+      // yarn not available
     }
   }
+}
+
+/**
+ * Fix the yarn lock links in the given directory.
+ */
+function fixLinks(package_dir: string) {
+  let yarn_reg = '';
+  try {
+    yarn_reg = utils.run('yarn config get registry', { stdio: 'pipe' }, true);
+  } catch (e) {
+    // Do nothing
+  }
+  yarn_reg = yarn_reg || 'https://registry.yarnpkg.com';
+  const lock_file = path.join(package_dir, 'yarn.lock');
+  console.log(`Fixing links in ${lock_file}`);
+  const content = fs.readFileSync(lock_file, { encoding: 'utf-8' });
+
+  let shasum = crypto.createHash('sha256');
+  let hash = shasum.update(content);
+  console.log('Prior hash', hash.digest('hex'));
+
+  const regex = /http\:\/\/0\.0\.0\.0\:\d+/g;
+  const new_content = content.replace(regex, yarn_reg);
+
+  shasum = crypto.createHash('sha256');
+  hash = shasum.update(new_content);
+  console.log('After hash', hash.digest('hex'));
+
+  fs.writeFileSync(lock_file, new_content, 'utf8');
 }
 
 /**
@@ -286,7 +290,7 @@
   .option('--port <port>', 'Port to use for the registry')
   .option('--path <path>', 'Path to use for the registry')
   .action(async (options: any) => {
-    utils.exitOnUncaughtException();
+    utils.exitOnUuncaughtException();
     const out_dir = options.path || DEFAULT_OUT_DIR;
     await startLocalRegistry(out_dir, options.port || DEFAULT_PORT);
   });
@@ -295,16 +299,24 @@
   .command('stop')
   .option('--path <path>', 'Path to use for the registry')
   .action(async (options: any) => {
-    utils.exitOnUncaughtException();
+    utils.exitOnUuncaughtException();
     const out_dir = options.path || DEFAULT_OUT_DIR;
     await stopLocalRegistry(out_dir);
+  });
+
+program
+  .command('fix-links')
+  .option('--path <path>', 'Path to the directory with a yarn lock')
+  .action((options: any) => {
+    utils.exitOnUuncaughtException();
+    fixLinks(options.path || process.cwd());
   });
 
 program
   .command('publish-dists')
   .option('--path <path>', 'Path to the directory with npm tar balls')
   .action((options: any) => {
-    utils.exitOnUncaughtException();
+    utils.exitOnUuncaughtException();
     publishPackages(options.path || process.cwd());
   });
 