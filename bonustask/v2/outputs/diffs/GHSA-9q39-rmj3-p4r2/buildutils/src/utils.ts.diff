--- buildutils\src\utils.ts (old)
+++ buildutils\src\utils.ts (new)
@@ -1,17 +1,10 @@
-/*
- * Copyright (c) Jupyter Development Team.
- * Distributed under the terms of the Modified BSD License.
- */
-
-/* global NodeRequire */
 import path from 'path';
 import glob from 'glob';
 import fs from 'fs-extra';
 import childProcess from 'child_process';
 import { DepGraph } from 'dependency-graph';
 import sortPackageJson from 'sort-package-json';
-
-import assert from 'assert';
+import { JSONExt, JSONObject } from '@lumino/coreutils';
 
 type Dict<T> = { [key: string]: T };
 
@@ -20,7 +13,7 @@
 /**
  *  Exit with an error code on uncaught error.
  */
-export function exitOnUncaughtException(): void {
+export function exitOnUuncaughtException(): void {
   process.on('uncaughtException', function (err: any) {
     if (err.status || err.stdout || err.stderr) {
       console.error(`Status: ${err.status}`);
@@ -85,13 +78,13 @@
  *
  * @param data - The package data.
  *
- * @param pkgJsonPath - The path to the package.json file.
+ * @oaram pkgJsonPath - The path to the package.json file.
  *
  * @returns Whether the file has changed.
  */
 export function writePackageData(
   pkgJsonPath: string,
-  data: Record<any, any>
+  data: JSONObject
 ): boolean {
   const text = JSON.stringify(sortPackageJson(data), null, 2) + '\n';
   const orig = fs.readFileSync(pkgJsonPath, 'utf8').split('\r\n').join('\n');
@@ -116,10 +109,7 @@
 /**
  * Write a json file.
  */
-export function writeJSONFile(
-  filePath: string,
-  data: Record<any, any>
-): boolean {
+export function writeJSONFile(filePath: string, data: JSONObject): boolean {
   function sortObjByKey(value: any): any {
     // https://stackoverflow.com/a/35810961
     return typeof value === 'object'
@@ -141,27 +131,23 @@
   } catch (e) {
     // no-op
   }
-
-  // If values do not match, overwrite file.
-  try {
-    assert.deepStrictEqual(data, orig);
-    return false;
-  } catch (error) {
+  if (!JSONExt.deepEqual(data, orig)) {
     fs.writeFileSync(filePath, text, 'utf8');
     return true;
   }
+  return false;
 }
 
 /**
  * Simple template substitution for template vars of the form {{name}}
  *
- * @param templ the template string.
+ * @param templ: the template string.
  * Ex: `This header generated by {{funcName}}`
  *
- * @param subs an object in which the parameter keys are the template
+ * @param subs: an object in which the parameter keys are the template
  * variables and the parameter values are the substitutions.
  *
- * @param options function options.
+ * @param options: function options.
  *
  * @param options.autoindent: default = true. If true, will try to match
  * indentation level of {{var}} in substituted template.
@@ -213,7 +199,7 @@
  * Get the current version of JupyterLab
  */
 export function getPythonVersion(): string {
-  const cmd = 'hatchling version';
+  const cmd = 'python setup.py --version';
   const lines = run(cmd, { stdio: 'pipe' }, true).split('\n');
   return lines[lines.length - 1];
 }
@@ -242,17 +228,11 @@
     encoding: 'utf8'
   });
   if (status.length > 0) {
-    const diff = run('git diff', {
-      stdio: 'pipe',
-      encoding: 'utf8'
-    });
     throw new Error(
       `Must be in a clean git state with no untracked files.
 Run "git status" to see the issues.
 
-${status}
-
-${diff}`
+${status}`
     );
   }
 }
@@ -261,7 +241,14 @@
  * Post-bump.
  */
 export function postbump(commit = true): void {
-  run('jlpm run integrity');
+  // Get the current version.
+  const curr = getPythonVersion();
+
+  // Update the dev mode version.
+  const filePath = path.resolve(path.join('.', 'dev_mode', 'package.json'));
+  const data = readJSONFile(filePath);
+  data.jupyterlab.version = curr;
+  writeJSONFile(filePath, data);
 
   // Commit changes.
   if (commit) {
@@ -347,25 +334,6 @@
   return graph;
 }
 
-function isModuleDir(current: string, moduleDirs: string[]): boolean {
-  return moduleDirs.some(dir => current.endsWith(dir));
-}
-
-function findPackageJson(base: string, moduleDirs: string[]): NodeRequire {
-  const { root } = path.parse(base);
-  let current = base;
-
-  while (current !== root && !isModuleDir(current, moduleDirs)) {
-    const pkgJsonPath = path.join(current, 'package.json');
-    if (fs.existsSync(pkgJsonPath)) {
-      return require(pkgJsonPath);
-    }
-    current = path.resolve(current, '..');
-  }
-  throw new Error(
-    `Unable to find package.json for '${base}', moduleDirs = '${moduleDirs[0]}'`
-  );
-}
 /**
  * Resolve a `package.json` in the `module` starting at resolution from the `parentModule`.
  *
@@ -379,30 +347,12 @@
   try {
     parentModulePath = require.resolve(parentModule);
   } catch {
-    try {
-      return require(packagePath);
-    } catch {
-      return findPackageJson(module, [path.resolve(packagePath, '..')]);
-    }
-  }
-
-  try {
-    // This may fail for package not exporting `package.json` in their exports map
-    // https://github.com/nodejs/node/issues/33460
-    const requirePath = require.resolve(packagePath, {
-      paths: [parentModulePath]
-    });
-    return require(requirePath);
-  } catch {
-    // If it fails, try to find the package.json by going parent to parent
-    // Inspired by https://github.com/rollup/plugins/blob/540767b947cfad0dd06a278b977b8ce05da9593c/packages/node-resolve/src/package/utils.js#L11
-    const base = require.resolve(module, {
-      paths: [parentModulePath]
-    });
-    return findPackageJson(base, [parentModulePath]);
-  }
-
-  throw new Error(`Unable to find package.json for '${module}'.`);
+    return require(packagePath);
+  }
+  const requirePath = require.resolve(packagePath, {
+    paths: [parentModulePath]
+  });
+  return require(requirePath);
 }
 
 /**
@@ -430,9 +380,9 @@
  * Given a 'snake-case', 'snake_case', or 'snake case' string,
  * will return the camel case version: 'snakeCase'.
  *
- * @param str the snake-case input string.
- *
- * @param upper default = false. If true, the first letter of the
+ * @param str: the snake-case input string.
+ *
+ * @param upper: default = false. If true, the first letter of the
  * returned string will be capitalized.
  *
  * @returns the camel case version of the input string.