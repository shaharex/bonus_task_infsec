--- packages\services\test\kernel\ikernel.spec.ts (old)
+++ packages\services\test\kernel\ikernel.spec.ts (new)
@@ -2,7 +2,12 @@
 // Distributed under the terms of the Modified BSD License.
 
 import { PageConfig } from '@jupyterlab/coreutils';
-import { JupyterServer, testEmission } from '@jupyterlab/testing';
+import {
+  expectFailure,
+  flakyIt as it,
+  JupyterServer,
+  testEmission
+} from '@jupyterlab/testutils';
 import { PromiseDelegate, UUID } from '@lumino/coreutils';
 import {
   Kernel,
@@ -13,20 +18,26 @@
 } from '../../src';
 import { FakeKernelManager, handleRequest, KernelTester } from '../utils';
 
+const server = new JupyterServer();
+
+beforeAll(async () => {
+  await server.start();
+});
+
+afterAll(async () => {
+  await server.shutdown();
+});
+
 describe('Kernel.IKernel', () => {
   let defaultKernel: Kernel.IKernelConnection;
   let specs: KernelSpec.ISpecModels;
   let kernelManager: KernelManager;
-  let server: JupyterServer;
-
-  jest.retryTimes(3);
 
   beforeAll(async () => {
-    server = new JupyterServer();
-    await server.start();
+    jest.setTimeout(20000);
     kernelManager = new FakeKernelManager();
     specs = await KernelSpecAPI.getSpecs();
-  }, 30000);
+  });
 
   beforeEach(async () => {
     defaultKernel = await kernelManager.startNew();
@@ -40,7 +51,6 @@
 
   afterAll(async () => {
     await kernelManager.shutdownAll();
-    await server.shutdown();
   });
 
   describe('#disposed', () => {
@@ -111,6 +121,25 @@
       ).done;
       expect(called).toBe(true);
     });
+
+    it('should be a signal following input request without parent header', async () => {
+      let called = false;
+      defaultKernel.pendingInput.connect((sender, args) => {
+        if (!called) {
+          called = true;
+          defaultKernel.sendInputReply({ status: 'ok', value: 'foo' });
+        }
+      });
+      const code = `input("Input something")`;
+      await defaultKernel.requestExecute(
+        {
+          code: code,
+          allow_stdin: true
+        },
+        true
+      ).done;
+      expect(called).toBe(true);
+    });
   });
 
   describe('#iopubMessage', () => {
@@ -141,7 +170,7 @@
       });
       tester.send(msg);
       await emission;
-      await expect(tester.shutdown()).resolves.not.toThrow();
+      await tester.shutdown();
       tester.dispose();
     });
   });
@@ -169,9 +198,9 @@
         msgId,
         content: {}
       });
-      msg.parent_header = { session: kernel.clientId } as any;
+      msg.parent_header = { session: kernel.clientId };
       tester.send(msg);
-      await expect(emission).resolves.not.toThrow();
+      await emission;
     });
 
     it('should not be emitted for an iopub signal', async () => {
@@ -197,7 +226,7 @@
         msgId,
         content: {}
       });
-      msg.parent_header = { session: kernel.clientId } as any;
+      msg.parent_header = { session: kernel.clientId };
       tester.send(msg);
 
       await emission;
@@ -227,7 +256,7 @@
         msgId: 'message from wrong session',
         content: {}
       });
-      msg1.parent_header = { session: 'wrong session' } as any;
+      msg1.parent_header = { session: 'wrong session' };
       tester.send(msg1);
 
       // Send a shell message with the right client (parent) session.
@@ -238,7 +267,7 @@
         msgId: msgId,
         content: {}
       });
-      msg2.parent_header = { session: kernel.clientId } as any;
+      msg2.parent_header = { session: kernel.clientId };
       tester.send(msg2);
 
       await emission;
@@ -274,7 +303,7 @@
         msgId,
         content: {}
       });
-      msg.parent_header = { session: kernel.clientId } as any;
+      msg.parent_header = { session: kernel.clientId };
       tester.send(msg);
       await emission;
     });
@@ -364,7 +393,7 @@
         find: () => defaultKernel.status === 'idle'
       });
       await defaultKernel.requestExecute({ code: 'a=1' }).done;
-      await expect(emission).resolves.not.toThrow();
+      await emission;
     });
 
     it('should get a restarting status', async () => {
@@ -375,17 +404,17 @@
       });
       await kernel.requestKernelInfo();
       await kernel.restart();
-      await expect(emission).resolves.not.toThrow();
+      await emission;
       await kernel.requestKernelInfo();
       await kernel.shutdown();
-    }, 30000);
+    });
 
     it('should get a busy status', async () => {
       const emission = testEmission(defaultKernel.statusChanged, {
         find: () => defaultKernel.status === 'busy'
       });
       await defaultKernel.requestExecute({ code: 'a=1' }, true).done;
-      await expect(emission).resolves.not.toThrow();
+      await emission;
     });
 
     it('should get an unknown status while disconnected', async () => {
@@ -396,7 +425,7 @@
       });
 
       await tester.close();
-      await expect(emission).resolves.not.toThrow();
+      await emission;
       tester.dispose();
     });
 
@@ -408,7 +437,7 @@
         find: () => kernel.status === 'dead'
       });
       tester.sendStatus(UUID.uuid4(), 'dead');
-      await expect(dead).resolves.not.toThrow();
+      await dead;
       tester.dispose();
     });
   });
@@ -557,7 +586,7 @@
       });
       expect(() => {
         kernel.sendShellMessage(msg, true);
-      }).toThrow(/Kernel is dead/);
+      }).toThrowError(/Kernel is dead/);
     });
 
     it('should handle out of order messages', async () => {
@@ -603,14 +632,14 @@
           );
         };
       });
-      await expect(future.done).resolves.not.toThrow();
+      await future.done;
     });
   });
 
   describe('#interrupt()', () => {
     it('should interrupt and resolve with a valid server response', async () => {
       const kernel = await kernelManager.startNew();
-      await expect(kernel.interrupt()).resolves.not.toThrow();
+      await kernel.interrupt();
       await kernel.shutdown();
     });
 
@@ -620,13 +649,13 @@
         name: defaultKernel.name
       });
       const interrupt = defaultKernel.interrupt();
-      await expect(interrupt).rejects.toThrow(/Invalid response: 200/);
+      await expectFailure(interrupt, 'Invalid response: 200 OK');
     });
 
     it('should throw an error for an error response', async () => {
       handleRequest(defaultKernel, 500, {});
       const interrupt = defaultKernel.interrupt();
-      await expect(interrupt).rejects.toThrow();
+      await expectFailure(interrupt, '');
     });
 
     it('should fail if the kernel is dead', async () => {
@@ -639,7 +668,7 @@
       });
       tester.sendStatus(UUID.uuid4(), 'dead');
       await dead;
-      await expect(kernel.interrupt()).rejects.toThrow(/Kernel is dead/);
+      await expectFailure(kernel.interrupt(), 'Kernel is dead');
       tester.dispose();
     });
   });
@@ -654,34 +683,35 @@
       await kernel.info;
       await kernel.requestKernelInfo();
       await kernel.restart();
-      await expect(kernel.requestKernelInfo()).resolves.not.toThrow();
+      await kernel.requestKernelInfo();
       await kernel.shutdown();
     });
 
     it('should fail if the kernel does not restart', async () => {
       handleRequest(defaultKernel, 500, {});
       const restart = defaultKernel.restart();
-      await expect(restart).rejects.toThrow();
+      await expectFailure(restart, '');
     });
 
     it('should throw an error for an invalid response', async () => {
       const { id, name } = defaultKernel;
       handleRequest(defaultKernel, 205, { id, name });
-      await expect(defaultKernel.restart()).rejects.toThrow(
-        /Invalid response: 205/
+      await expectFailure(
+        defaultKernel.restart(),
+        'Invalid response: 205 Reset Content'
       );
     });
 
     it('should throw an error for an error response', async () => {
       handleRequest(defaultKernel, 500, {});
       const restart = defaultKernel.restart();
-      await expect(restart).rejects.toThrow();
+      await expectFailure(restart);
     });
 
     it('should throw an error for an invalid id', async () => {
       handleRequest(defaultKernel, 200, {});
       const restart = defaultKernel.restart();
-      await expect(restart).rejects.toThrow();
+      await expectFailure(restart);
     });
 
     it('should dispose of existing comm and future objects', async () => {
@@ -715,20 +745,26 @@
         }
       });
       await defaultKernel.reconnect();
-      await expect(emission).resolves.not.toThrow();
+      await emission;
     });
 
     it('return promise should reject if the kernel is disposed or disconnected', async () => {
       const connection = defaultKernel.reconnect();
       defaultKernel.dispose();
-      await expect(connection).rejects.toThrow();
+      try {
+        await connection;
+        // If the connection did not reject, so test fails.
+        throw new Error('Reconnection promise did not reject');
+      } catch (e) {
+        /* Connection promise reject - test passes */
+      }
     });
   });
 
   describe('#shutdown()', () => {
     it('should shut down and resolve with a valid server response', async () => {
       const kernel = await kernelManager.startNew();
-      await expect(kernel.shutdown()).resolves.not.toThrow();
+      await kernel.shutdown();
     });
 
     it('should throw an error for an invalid response', async () => {
@@ -737,19 +773,19 @@
         name: 'foo'
       });
       const shutdown = defaultKernel.shutdown();
-      await expect(shutdown).rejects.toThrow(/Invalid response: 200/);
+      await expectFailure(shutdown, 'Invalid response: 200 OK');
     });
 
     it('should handle a 404 error', async () => {
       const kernel = await kernelManager.startNew();
       handleRequest(kernel, 404, {});
-      await expect(kernel.shutdown()).resolves.not.toThrow();
+      await kernel.shutdown();
     });
 
     it('should throw an error for an error response', async () => {
       handleRequest(defaultKernel, 500, {});
       const shutdown = defaultKernel.shutdown();
-      await expect(shutdown).rejects.toThrow();
+      await expectFailure(shutdown, '');
     });
 
     it('should still pass if the kernel is dead', async () => {
@@ -762,7 +798,7 @@
       });
       tester.sendStatus(UUID.uuid4(), 'dead');
       await dead;
-      await expect(kernel.shutdown()).resolves.not.toThrow();
+      await kernel.shutdown();
       tester.dispose();
     });
   });
@@ -784,9 +820,7 @@
         code: 'hello',
         cursor_pos: 4
       };
-      await expect(
-        defaultKernel.requestComplete(options)
-      ).resolves.not.toThrow();
+      await defaultKernel.requestComplete(options);
     });
 
     it('should reject the promise if the kernel is dead', async () => {
@@ -803,9 +837,7 @@
       });
       tester.sendStatus(UUID.uuid4(), 'dead');
       await dead;
-      await expect(kernel.requestComplete(options)).rejects.toThrow(
-        /Kernel is dead/
-      );
+      await expectFailure(kernel.requestComplete(options), 'Kernel is dead');
       tester.dispose();
     });
   });
@@ -817,9 +849,7 @@
         cursor_pos: 4,
         detail_level: 0
       };
-      await expect(
-        defaultKernel.requestInspect(options)
-      ).resolves.not.toThrow();
+      await defaultKernel.requestInspect(options);
     });
   });
 
@@ -828,9 +858,7 @@
       const options: KernelMessage.IIsCompleteRequestMsg['content'] = {
         code: 'hello'
       };
-      await expect(
-        defaultKernel.requestIsComplete(options)
-      ).resolves.not.toThrow();
+      await defaultKernel.requestIsComplete(options);
     });
   });
 
@@ -844,9 +872,7 @@
         start: 1,
         stop: 2
       };
-      await expect(
-        defaultKernel.requestHistory(options)
-      ).resolves.not.toThrow();
+      await defaultKernel.requestHistory(options);
     });
 
     it('tail messages should resolve the promise', async () => {
@@ -856,9 +882,7 @@
         hist_access_type: 'tail',
         n: 1
       };
-      await expect(
-        defaultKernel.requestHistory(options)
-      ).resolves.not.toThrow();
+      await defaultKernel.requestHistory(options);
     });
 
     it('search messages should resolve the promise', async () => {
@@ -870,9 +894,7 @@
         pattern: '*',
         unique: true
       };
-      await expect(
-        defaultKernel.requestHistory(options)
-      ).resolves.not.toThrow();
+      await defaultKernel.requestHistory(options);
     });
   });
 
@@ -923,7 +945,7 @@
             version: ''
           }
         );
-      }).toThrow(/Kernel is dead/);
+      }).toThrowError(/Kernel is dead/);
       tester.dispose();
     });
   });
@@ -961,8 +983,7 @@
               status: 'ok',
               user_expressions: {}
             },
-            parentHeader:
-              msg.header as KernelMessage.IExecuteRequestMsg['header']
+            parentHeader: msg.header as KernelMessage.IExecuteRequestMsg['header']
           })
         );
 