--- packages\notebook-extension\src\index.ts (old)
+++ packages\notebook-extension\src\index.ts (new)
@@ -5,12 +5,9 @@
  * @module notebook-extension
  */
 
-import type { FieldProps } from '@rjsf/utils';
-
 import {
   ILabShell,
   ILayoutRestorer,
-  IRouter,
   JupyterFrontEnd,
   JupyterFrontEndPlugin
 } from '@jupyterlab/application';
@@ -18,84 +15,60 @@
   createToolbarFactory,
   Dialog,
   ICommandPalette,
-  IKernelStatusModel,
   InputDialog,
-  ISanitizer,
-  ISessionContext,
   ISessionContextDialogs,
   IToolbarWidgetRegistry,
   MainAreaWidget,
-  Sanitizer,
-  SessionContextDialogs,
+  sessionContextDialogs,
   showDialog,
   Toolbar,
   WidgetTracker
 } from '@jupyterlab/apputils';
 import { Cell, CodeCell, ICellModel, MarkdownCell } from '@jupyterlab/cells';
-import {
-  CodeEditor,
-  IEditorServices,
-  IPositionModel
-} from '@jupyterlab/codeeditor';
-import { IChangedArgs, PageConfig } from '@jupyterlab/coreutils';
-
-import {
-  IEditorExtensionRegistry,
-  IEditorLanguageRegistry
-} from '@jupyterlab/codemirror';
-import { ICompletionProviderManager } from '@jupyterlab/completer';
+import { IEditorServices } from '@jupyterlab/codeeditor';
+import { PageConfig } from '@jupyterlab/coreutils';
+
 import { IDocumentManager } from '@jupyterlab/docmanager';
 import { ToolbarItems as DocToolbarItems } from '@jupyterlab/docmanager-extension';
 import { DocumentRegistry, IDocumentWidget } from '@jupyterlab/docregistry';
-import { ISearchProviderRegistry } from '@jupyterlab/documentsearch';
-import {
-  IDefaultFileBrowser,
-  IFileBrowserFactory
-} from '@jupyterlab/filebrowser';
+import { IFileBrowserFactory } from '@jupyterlab/filebrowser';
 import { ILauncher } from '@jupyterlab/launcher';
 import {
-  ILSPCodeExtractorsManager,
-  ILSPDocumentConnectionManager,
-  ILSPFeatureManager,
-  IWidgetLSPAdapterTracker,
-  WidgetLSPAdapterTracker
-} from '@jupyterlab/lsp';
-import { IMainMenu } from '@jupyterlab/mainmenu';
-import { IMetadataFormProvider } from '@jupyterlab/metadataform';
+  IEditMenu,
+  IFileMenu,
+  IHelpMenu,
+  IKernelMenu,
+  IMainMenu,
+  IRunMenu,
+  IViewMenu
+} from '@jupyterlab/mainmenu';
 import * as nbformat from '@jupyterlab/nbformat';
 import {
   CommandEditStatus,
   ExecutionIndicator,
-  INotebookCellExecutor,
   INotebookTools,
   INotebookTracker,
   INotebookWidgetFactory,
   Notebook,
   NotebookActions,
-  NotebookAdapter,
   NotebookModelFactory,
   NotebookPanel,
-  NotebookSearchProvider,
-  NotebookToCFactory,
   NotebookTools,
   NotebookTracker,
   NotebookTrustStatus,
   NotebookWidgetFactory,
-  setCellExecutor,
   StaticNotebook,
   ToolbarItems
 } from '@jupyterlab/notebook';
-import { IObservableList } from '@jupyterlab/observables';
+import {
+  IObservableList,
+  IObservableUndoableList
+} from '@jupyterlab/observables';
 import { IPropertyInspectorProvider } from '@jupyterlab/property-inspector';
-import {
-  IMarkdownParser,
-  IRenderMime,
-  IRenderMimeRegistry
-} from '@jupyterlab/rendermime';
+import { IRenderMimeRegistry } from '@jupyterlab/rendermime';
 import { ISettingRegistry } from '@jupyterlab/settingregistry';
 import { IStateDB } from '@jupyterlab/statedb';
 import { IStatusBar } from '@jupyterlab/statusbar';
-import { ITableOfContentsRegistry } from '@jupyterlab/toc';
 import { ITranslator, nullTranslator } from '@jupyterlab/translation';
 import {
   addAboveIcon,
@@ -104,37 +77,25 @@
   copyIcon,
   cutIcon,
   duplicateIcon,
-  fastForwardIcon,
-  IFormRenderer,
-  IFormRendererRegistry,
   moveDownIcon,
   moveUpIcon,
   notebookIcon,
-  pasteIcon,
-  refreshIcon,
-  runIcon,
-  stopIcon,
-  tableRowsIcon
+  pasteIcon
 } from '@jupyterlab/ui-components';
 import { ArrayExt } from '@lumino/algorithm';
 import { CommandRegistry } from '@lumino/commands';
 import {
   JSONExt,
   JSONObject,
+  JSONValue,
   ReadonlyJSONValue,
   ReadonlyPartialJSONObject,
   UUID
 } from '@lumino/coreutils';
 import { DisposableSet, IDisposable } from '@lumino/disposable';
 import { Message, MessageLoop } from '@lumino/messaging';
-import { Menu, Panel, Widget } from '@lumino/widgets';
-import { cellExecutor } from './cellexecutor';
+import { Menu, Panel } from '@lumino/widgets';
 import { logNotebookOutput } from './nboutput';
-import { ActiveCellTool } from './tool-widgets/activeCellToolWidget';
-import {
-  CellMetadataField,
-  NotebookMetadataField
-} from './tool-widgets/metadataEditorFields';
 
 /**
  * The command IDs used by the notebook plugin.
@@ -156,16 +117,12 @@
 
   export const changeKernel = 'notebook:change-kernel';
 
-  export const getKernel = 'notebook:get-kernel';
-
   export const createConsole = 'notebook:create-console';
 
   export const createOutputView = 'notebook:create-output-view';
 
   export const clearAllOutputs = 'notebook:clear-all-cell-outputs';
 
-  export const shutdown = 'notebook:shutdown-kernel';
-
   export const closeAndShutdown = 'notebook:close-and-shutdown';
 
   export const trust = 'notebook:trust';
@@ -222,16 +179,6 @@
 
   export const selectBelow = 'notebook:move-cursor-down';
 
-  export const selectHeadingAboveOrCollapse =
-    'notebook:move-cursor-heading-above-or-collapse';
-
-  export const selectHeadingBelowOrExpand =
-    'notebook:move-cursor-heading-below-or-expand';
-
-  export const insertHeadingAbove = 'notebook:insert-heading-above';
-
-  export const insertHeadingBelow = 'notebook:insert-heading-below';
-
   export const extendAbove = 'notebook:extend-marked-cells-above';
 
   export const extendTop = 'notebook:extend-marked-cells-top';
@@ -261,10 +208,6 @@
   export const undoCellAction = 'notebook:undo-cell-action';
 
   export const redoCellAction = 'notebook:redo-cell-action';
-
-  export const redo = 'notebook:redo';
-
-  export const undo = 'notebook:undo';
 
   export const markdown1 = 'notebook:change-cell-to-heading-1';
 
@@ -309,25 +252,13 @@
 
   export const autoClosingBrackets = 'notebook:toggle-autoclosing-brackets';
 
-  export const toggleCollapseCmd = 'notebook:toggle-heading-collapse';
-
-  export const collapseAllCmd = 'notebook:collapse-all-headings';
-
-  export const expandAllCmd = 'notebook:expand-all-headings';
+  export const toggleCollapseCmd = 'Collapsible_Headings:Toggle_Collapse';
+
+  export const collapseAllCmd = 'Collapsible_Headings:Collapse_All';
+
+  export const expandAllCmd = 'Collapsible_Headings:Expand_All';
 
   export const copyToClipboard = 'notebook:copy-to-clipboard';
-
-  export const invokeCompleter = 'completer:invoke-notebook';
-
-  export const selectCompleter = 'completer:select-notebook';
-
-  export const tocRunCells = 'toc:run-cells';
-
-  export const accessPreviousHistory = 'notebook:access-previous-history-entry';
-
-  export const accessNextHistory = 'notebook:access-next-history-entry';
-
-  export const virtualScrollbar = 'notebook:toggle-virtual-scrollbar';
 }
 
 /**
@@ -356,25 +287,16 @@
  */
 const trackerPlugin: JupyterFrontEndPlugin<INotebookTracker> = {
   id: '@jupyterlab/notebook-extension:tracker',
-  description: 'Provides the notebook widget tracker.',
   provides: INotebookTracker,
-  requires: [
-    INotebookWidgetFactory,
-    IEditorExtensionRegistry,
-    INotebookCellExecutor
-  ],
+  requires: [INotebookWidgetFactory, ITranslator],
   optional: [
     ICommandPalette,
-    IDefaultFileBrowser,
+    IFileBrowserFactory,
     ILauncher,
     ILayoutRestorer,
     IMainMenu,
-    IRouter,
     ISettingRegistry,
-    ISessionContextDialogs,
-    ITranslator,
-    IFormRendererRegistry,
-    IFileBrowserFactory
+    ISessionContextDialogs
   ],
   activate: activateNotebookHandler,
   autoStart: true
@@ -385,7 +307,6 @@
  */
 const factory: JupyterFrontEndPlugin<NotebookPanel.IContentFactory> = {
   id: '@jupyterlab/notebook-extension:factory',
-  description: 'Provides the notebook cell factory.',
   provides: NotebookPanel.IContentFactory,
   requires: [IEditorServices],
   autoStart: true,
@@ -402,15 +323,8 @@
   activate: activateNotebookTools,
   provides: INotebookTools,
   id: '@jupyterlab/notebook-extension:tools',
-  description: 'Provides the notebook tools.',
   autoStart: true,
-  requires: [
-    INotebookTracker,
-    IEditorServices,
-    IEditorLanguageRegistry,
-    IStateDB,
-    ITranslator
-  ],
+  requires: [INotebookTracker, IEditorServices, IStateDB, ITranslator],
   optional: [IPropertyInspectorProvider]
 };
 
@@ -419,7 +333,6 @@
  */
 export const commandEditItem: JupyterFrontEndPlugin<void> = {
   id: '@jupyterlab/notebook-extension:mode-status',
-  description: 'Adds a notebook mode status widget.',
   autoStart: true,
   requires: [INotebookTracker, ITranslator],
   optional: [IStatusBar],
@@ -443,7 +356,6 @@
     });
 
     statusBar.registerStatusItem('@jupyterlab/notebook-extension:mode-status', {
-      priority: 1,
       item,
       align: 'right',
       rank: 4,
@@ -460,7 +372,6 @@
  */
 export const executionIndicator: JupyterFrontEndPlugin<void> = {
   id: '@jupyterlab/notebook-extension:execution-indicator',
-  description: 'Adds a notebook execution status widget.',
   autoStart: true,
   requires: [INotebookTracker, ILabShell, ITranslator],
   optional: [IStatusBar, ISettingRegistry],
@@ -568,7 +479,6 @@
  */
 export const exportPlugin: JupyterFrontEndPlugin<void> = {
   id: '@jupyterlab/notebook-extension:export',
-  description: 'Adds the export notebook commands.',
   autoStart: true,
   requires: [ITranslator, INotebookTracker],
   optional: [IMainMenu, ICommandPalette],
@@ -589,9 +499,6 @@
 
     commands.addCommand(CommandIDs.exportToFormat, {
       label: args => {
-        if (args.label === undefined) {
-          return trans.__('Save and Export Notebook to the given `format`.');
-        }
         const formatLabel = args['label'] as string;
         return args['isPalette']
           ? trans.__('Save and Export Notebook: %1', formatLabel)
@@ -635,61 +542,44 @@
       )?.submenu;
     }
 
-    let formatsInitialized = false;
-
-    /** Request formats only when a notebook might use them. */
-    const maybeInitializeFormats = async () => {
-      if (formatsInitialized) {
-        return;
-      }
-
-      tracker.widgetAdded.disconnect(maybeInitializeFormats);
-
-      formatsInitialized = true;
-
-      const response = await services.nbconvert.getExportFormats(false);
-
-      if (!response) {
-        return;
-      }
-
-      const formatLabels: any = Private.getFormatLabels(translator);
-
-      // Convert export list to palette and menu items.
-      const formatList = Object.keys(response);
-      formatList.forEach(function (key) {
-        const capCaseKey = trans.__(key[0].toUpperCase() + key.substr(1));
-        const labelStr = formatLabels[key] ? formatLabels[key] : capCaseKey;
-        let args = {
-          format: key,
-          label: labelStr,
-          isPalette: false
-        };
-        if (FORMAT_EXCLUDE.indexOf(key) === -1) {
-          if (exportTo) {
-            exportTo.addItem({
-              command: CommandIDs.exportToFormat,
-              args: args
-            });
+    void services.nbconvert.getExportFormats().then(response => {
+      if (response) {
+        const formatLabels: any = Private.getFormatLabels(translator);
+
+        // Convert export list to palette and menu items.
+        const formatList = Object.keys(response);
+        formatList.forEach(function (key) {
+          const capCaseKey = trans.__(key[0].toUpperCase() + key.substr(1));
+          const labelStr = formatLabels[key] ? formatLabels[key] : capCaseKey;
+          let args = {
+            format: key,
+            label: labelStr,
+            isPalette: false
+          };
+          if (FORMAT_EXCLUDE.indexOf(key) === -1) {
+            if (exportTo) {
+              exportTo.addItem({
+                command: CommandIDs.exportToFormat,
+                args: args
+              });
+            }
+            if (palette) {
+              args = {
+                format: key,
+                label: labelStr,
+                isPalette: true
+              };
+              const category = trans.__('Notebook Operations');
+              palette.addItem({
+                command: CommandIDs.exportToFormat,
+                category,
+                args
+              });
+            }
           }
-          if (palette) {
-            args = {
-              format: key,
-              label: labelStr,
-              isPalette: true
-            };
-            const category = trans.__('Notebook Operations');
-            palette.addItem({
-              command: CommandIDs.exportToFormat,
-              category,
-              args
-            });
-          }
-        }
-      });
-    };
-
-    tracker.widgetAdded.connect(maybeInitializeFormats);
+        });
+      }
+    });
   }
 };
 
@@ -698,7 +588,6 @@
  */
 export const notebookTrustItem: JupyterFrontEndPlugin<void> = {
   id: '@jupyterlab/notebook-extension:trust-status',
-  description: 'Adds the notebook trusted status widget.',
   autoStart: true,
   requires: [INotebookTracker, ITranslator],
   optional: [IStatusBar],
@@ -739,28 +628,27 @@
 /**
  * The notebook widget factory provider.
  */
-const widgetFactoryPlugin: JupyterFrontEndPlugin<NotebookWidgetFactory.IFactory> =
-  {
-    id: '@jupyterlab/notebook-extension:widget-factory',
-    description: 'Provides the notebook widget factory.',
-    provides: INotebookWidgetFactory,
-    requires: [
-      NotebookPanel.IContentFactory,
-      IEditorServices,
-      IRenderMimeRegistry,
-      IToolbarWidgetRegistry
-    ],
-    optional: [ISettingRegistry, ISessionContextDialogs, ITranslator],
-    activate: activateWidgetFactory,
-    autoStart: true
-  };
+const widgetFactoryPlugin: JupyterFrontEndPlugin<NotebookWidgetFactory.IFactory> = {
+  id: '@jupyterlab/notebook-extension:widget-factory',
+  provides: INotebookWidgetFactory,
+  requires: [
+    NotebookPanel.IContentFactory,
+    IEditorServices,
+    IRenderMimeRegistry,
+    ISessionContextDialogs,
+    IToolbarWidgetRegistry,
+    ITranslator
+  ],
+  optional: [ISettingRegistry],
+  activate: activateWidgetFactory,
+  autoStart: true
+};
 
 /**
  * The cloned output provider.
  */
 const clonedOutputsPlugin: JupyterFrontEndPlugin<void> = {
   id: '@jupyterlab/notebook-extension:cloned-outputs',
-  description: 'Adds the clone output feature.',
   requires: [IDocumentManager, INotebookTracker, ITranslator],
   optional: [ILayoutRestorer],
   activate: activateClonedOutputs,
@@ -772,7 +660,6 @@
  */
 const codeConsolePlugin: JupyterFrontEndPlugin<void> = {
   id: '@jupyterlab/notebook-extension:code-console',
-  description: 'Adds the notebook code consoles features.',
   requires: [INotebookTracker, ITranslator],
   activate: activateCodeConsole,
   autoStart: true
@@ -782,323 +669,16 @@
  * A plugin to copy CodeCell outputs.
  */
 const copyOutputPlugin: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/notebook-extension:copy-output',
-  description: 'Adds the copy cell outputs feature.',
+  id: '@jupyterlab/notebook-extensions:copy-output',
   activate: activateCopyOutput,
   requires: [ITranslator, INotebookTracker],
   autoStart: true
 };
 
 /**
- * Kernel status indicator.
- */
-const kernelStatus: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/notebook-extension:kernel-status',
-  description: 'Adds the notebook kernel status.',
-  activate: (
-    app: JupyterFrontEnd,
-    tracker: INotebookTracker,
-    kernelStatus: IKernelStatusModel
-  ) => {
-    const provider = (widget: Widget | null) => {
-      let session: ISessionContext | null = null;
-
-      if (widget && tracker.has(widget)) {
-        return (widget as NotebookPanel).sessionContext;
-      }
-
-      return session;
-    };
-
-    kernelStatus.addSessionProvider(provider);
-  },
-  requires: [INotebookTracker, IKernelStatusModel],
-  autoStart: true
-};
-
-/**
- * Cursor position.
- */
-const lineColStatus: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/notebook-extension:cursor-position',
-  description: 'Adds the notebook cursor position status.',
-  activate: (
-    app: JupyterFrontEnd,
-    tracker: INotebookTracker,
-    positionModel: IPositionModel
-  ) => {
-    let previousWidget: NotebookPanel | null = null;
-
-    const provider = async (widget: Widget | null) => {
-      let editor: CodeEditor.IEditor | null = null;
-      if (widget !== previousWidget) {
-        previousWidget?.content.activeCellChanged.disconnect(
-          positionModel.update
-        );
-
-        previousWidget = null;
-        if (widget && tracker.has(widget)) {
-          (widget as NotebookPanel).content.activeCellChanged.connect(
-            positionModel.update
-          );
-          const activeCell = (widget as NotebookPanel).content.activeCell;
-          editor = null;
-          if (activeCell) {
-            await activeCell.ready;
-            editor = activeCell.editor;
-          }
-          previousWidget = widget as NotebookPanel;
-        }
-      } else if (widget) {
-        const activeCell = (widget as NotebookPanel).content.activeCell;
-        editor = null;
-        if (activeCell) {
-          await activeCell.ready;
-          editor = activeCell.editor;
-        }
-      }
-      return editor;
-    };
-
-    positionModel.addEditorProvider(provider);
-  },
-  requires: [INotebookTracker, IPositionModel],
-  autoStart: true
-};
-
-const completerPlugin: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/notebook-extension:completer',
-  description: 'Adds the code completion capability to notebooks.',
-  requires: [INotebookTracker],
-  optional: [ICompletionProviderManager, ITranslator, ISanitizer],
-  activate: activateNotebookCompleterService,
-  autoStart: true
-};
-
-/**
- * A plugin to search notebook documents
- */
-const searchProvider: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/notebook-extension:search',
-  description: 'Adds search capability to notebooks.',
-  requires: [ISearchProviderRegistry],
-  autoStart: true,
-  activate: (app: JupyterFrontEnd, registry: ISearchProviderRegistry) => {
-    registry.add('jp-notebookSearchProvider', NotebookSearchProvider);
-  }
-};
-
-const tocPlugin: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/notebook-extension:toc',
-  description: 'Adds table of content capability to the notebooks',
-  requires: [INotebookTracker, ITableOfContentsRegistry, ISanitizer],
-  optional: [IMarkdownParser, ISettingRegistry],
-  autoStart: true,
-  activate: (
-    app: JupyterFrontEnd,
-    tracker: INotebookTracker,
-    tocRegistry: ITableOfContentsRegistry,
-    sanitizer: IRenderMime.ISanitizer,
-    mdParser: IMarkdownParser | null,
-    settingRegistry: ISettingRegistry | null
-  ): void => {
-    const nbTocFactory = new NotebookToCFactory(tracker, mdParser, sanitizer);
-    tocRegistry.add(nbTocFactory);
-    if (settingRegistry) {
-      Promise.all([app.restored, settingRegistry.load(trackerPlugin.id)])
-        .then(([_, setting]) => {
-          const onSettingsUpdate = () => {
-            nbTocFactory.scrollToTop =
-              (setting.composite['scrollHeadingToTop'] as boolean) ?? true;
-          };
-          onSettingsUpdate();
-          setting.changed.connect(onSettingsUpdate);
-        })
-        .catch(error => {
-          console.error(
-            'Failed to load notebook table of content settings.',
-            error
-          );
-        });
-    }
-  }
-};
-
-const languageServerPlugin: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/notebook-extension:language-server',
-  description: 'Adds language server capability to the notebooks.',
-  requires: [
-    INotebookTracker,
-    ILSPDocumentConnectionManager,
-    ILSPFeatureManager,
-    ILSPCodeExtractorsManager,
-    IWidgetLSPAdapterTracker
-  ],
-  activate: activateNotebookLanguageServer,
-  autoStart: true
-};
-
-/**
- * Metadata editor for the raw cell mimetype.
- */
-const updateRawMimetype: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/notebook-extension:update-raw-mimetype',
-  description: 'Adds metadata form editor for raw cell mimetype.',
-  autoStart: true,
-  requires: [INotebookTracker, IMetadataFormProvider, ITranslator],
-  activate: (
-    app: JupyterFrontEnd,
-    tracker: INotebookTracker,
-    metadataForms: IMetadataFormProvider,
-    translator: ITranslator
-  ) => {
-    const trans = translator.load('jupyterlab');
-    let formatsInitialized = false;
-
-    async function maybeInitializeFormats() {
-      if (formatsInitialized) {
-        return;
-      }
-      if (!metadataForms.get('commonToolsSection')) {
-        return;
-      }
-
-      const properties = metadataForms
-        .get('commonToolsSection')!
-        .getProperties('/raw_mimetype');
-
-      if (!properties) {
-        return;
-      }
-
-      tracker.widgetAdded.disconnect(maybeInitializeFormats);
-
-      formatsInitialized = true;
-
-      const services = app.serviceManager;
-      const response = await services.nbconvert.getExportFormats(false);
-      if (!response) {
-        return;
-      }
-
-      // convert exportList to palette and menu items
-      const formatList = Object.keys(response);
-      const formatLabels = Private.getFormatLabels(translator);
-      type enumeration = {
-        const: string;
-        title: string;
-      };
-      formatList.forEach(function (key) {
-        const mimetypeExists =
-          (properties!.oneOf as Array<enumeration>)?.filter(
-            value => value.const === key
-          ).length > 0;
-        if (!mimetypeExists) {
-          const altOption = trans.__(key[0].toUpperCase() + key.substr(1));
-          const option = formatLabels[key] ? formatLabels[key] : altOption;
-          const mimeTypeValue = response[key].output_mimetype;
-
-          (properties!.oneOf as Array<enumeration>)!.push({
-            const: mimeTypeValue,
-            title: option
-          });
-        }
-      });
-
-      metadataForms
-        .get('commonToolsSection')!
-        .setProperties('/raw_mimetype', properties);
-    }
-    tracker.widgetAdded.connect(maybeInitializeFormats);
-  }
-};
-
-/**
- * Registering metadata editor fields.
- */
-const customMetadataEditorFields: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/notebook-extension:metadata-editor',
-  description: 'Adds metadata form for full metadata editor.',
-  autoStart: true,
-  requires: [INotebookTracker, IEditorServices, IFormRendererRegistry],
-  optional: [ITranslator],
-  activate: (
-    app: JupyterFrontEnd,
-    tracker: INotebookTracker,
-    editorServices: IEditorServices,
-    formRegistry: IFormRendererRegistry,
-    translator?: ITranslator
-  ) => {
-    const editorFactory: CodeEditor.Factory = options =>
-      editorServices.factoryService.newInlineEditor(options);
-    // Register the custom fields.
-    const cellComponent: IFormRenderer = {
-      fieldRenderer: (props: FieldProps) => {
-        return new CellMetadataField({
-          editorFactory,
-          tracker,
-          label: 'Cell metadata',
-          translator: translator
-        }).render(props);
-      }
-    };
-    formRegistry.addRenderer(
-      '@jupyterlab/notebook-extension:metadata-editor.cell-metadata',
-      cellComponent
-    );
-
-    const notebookComponent: IFormRenderer = {
-      fieldRenderer: (props: FieldProps) => {
-        return new NotebookMetadataField({
-          editorFactory,
-          tracker,
-          label: 'Notebook metadata',
-          translator: translator
-        }).render(props);
-      }
-    };
-    formRegistry.addRenderer(
-      '@jupyterlab/notebook-extension:metadata-editor.notebook-metadata',
-      notebookComponent
-    );
-  }
-};
-
-/**
- * Registering active cell field.
- */
-const activeCellTool: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/notebook-extension:active-cell-tool',
-  description: 'Adds active cell field in the metadata editor tab.',
-  autoStart: true,
-  requires: [INotebookTracker, IFormRendererRegistry, IEditorLanguageRegistry],
-  activate: (
-    // Register the custom field.
-    app: JupyterFrontEnd,
-    tracker: INotebookTracker,
-    formRegistry: IFormRendererRegistry,
-    languages: IEditorLanguageRegistry
-  ) => {
-    const component: IFormRenderer = {
-      fieldRenderer: (props: FieldProps) => {
-        return new ActiveCellTool({
-          tracker,
-          languages
-        }).render(props);
-      }
-    };
-    formRegistry.addRenderer(
-      '@jupyterlab/notebook-extension:active-cell-tool.renderer',
-      component
-    );
-  }
-};
-
-/**
  * Export the plugins as default.
  */
 const plugins: JupyterFrontEndPlugin<any>[] = [
-  cellExecutor,
   factory,
   trackerPlugin,
   executionIndicator,
@@ -1110,16 +690,7 @@
   logNotebookOutput,
   clonedOutputsPlugin,
   codeConsolePlugin,
-  copyOutputPlugin,
-  kernelStatus,
-  lineColStatus,
-  completerPlugin,
-  searchProvider,
-  tocPlugin,
-  languageServerPlugin,
-  updateRawMimetype,
-  customMetadataEditorFields,
-  activeCellTool
+  copyOutputPlugin
 ];
 export default plugins;
 
@@ -1130,7 +701,6 @@
   app: JupyterFrontEnd,
   tracker: INotebookTracker,
   editorServices: IEditorServices,
-  languages: IEditorLanguageRegistry,
   state: IStateDB,
   translator: ITranslator,
   inspectorProvider: IPropertyInspectorProvider | null
@@ -1138,6 +708,20 @@
   const trans = translator.load('jupyterlab');
   const id = 'notebook-tools';
   const notebookTools = new NotebookTools({ tracker, translator });
+  const activeCellTool = new NotebookTools.ActiveCellTool();
+  const slideShow = NotebookTools.createSlideShowSelector(translator);
+  const editorFactory = editorServices.factoryService.newInlineEditor;
+  const cellMetadataEditor = new NotebookTools.CellMetadataEditorTool({
+    editorFactory,
+    collapsed: false,
+    translator
+  });
+  const notebookMetadataEditor = new NotebookTools.NotebookMetadataEditorTool({
+    editorFactory,
+    translator
+  });
+
+  const services = app.serviceManager;
 
   // Create message hook for triggers to save to the database.
   const hook = (sender: any, message: Message): boolean => {
@@ -1154,9 +738,64 @@
     }
     return true;
   };
+  const optionsMap: { [key: string]: JSONValue } = {};
+  optionsMap.None = null;
+  void services.nbconvert.getExportFormats().then(response => {
+    if (response) {
+      /**
+       * The excluded Cell Inspector Raw NbConvert Formats
+       * (returned from nbconvert's export list)
+       */
+      const rawFormatExclude = [
+        'pdf',
+        'slides',
+        'script',
+        'notebook',
+        'custom'
+      ];
+      let optionValueArray: any = [
+        [trans.__('PDF'), 'pdf'],
+        [trans.__('Slides'), 'slides'],
+        [trans.__('Script'), 'script'],
+        [trans.__('Notebook'), 'notebook'],
+        [trans.__('Custom'), 'custom']
+      ];
+
+      // convert exportList to palette and menu items
+      const formatList = Object.keys(response);
+      const formatLabels = Private.getFormatLabels(translator);
+      formatList.forEach(function (key) {
+        if (rawFormatExclude.indexOf(key) === -1) {
+          const altOption = trans.__(key[0].toUpperCase() + key.substr(1));
+          const option = formatLabels[key] ? formatLabels[key] : altOption;
+          const mimeTypeValue = response[key].output_mimetype;
+          optionValueArray.push([option, mimeTypeValue]);
+        }
+      });
+      const nbConvert = NotebookTools.createNBConvertSelector(
+        optionValueArray,
+        translator
+      );
+      notebookTools.addItem({ tool: nbConvert, section: 'common', rank: 3 });
+    }
+  });
   notebookTools.title.icon = buildIcon;
   notebookTools.title.caption = trans.__('Notebook Tools');
   notebookTools.id = id;
+
+  notebookTools.addItem({ tool: activeCellTool, section: 'common', rank: 1 });
+  notebookTools.addItem({ tool: slideShow, section: 'common', rank: 2 });
+
+  notebookTools.addItem({
+    tool: cellMetadataEditor,
+    section: 'advanced',
+    rank: 1
+  });
+  notebookTools.addItem({
+    tool: notebookMetadataEditor,
+    section: 'advanced',
+    rank: 2
+  });
 
   MessageLoop.installMessageHook(notebookTools, hook);
 
@@ -1178,14 +817,11 @@
   contentFactory: NotebookPanel.IContentFactory,
   editorServices: IEditorServices,
   rendermime: IRenderMimeRegistry,
+  sessionContextDialogs: ISessionContextDialogs,
   toolbarRegistry: IToolbarWidgetRegistry,
-  settingRegistry: ISettingRegistry | null,
-  sessionContextDialogs_: ISessionContextDialogs | null,
-  translator_: ITranslator | null
+  translator: ITranslator,
+  settingRegistry: ISettingRegistry | null
 ): NotebookWidgetFactory.IFactory {
-  const translator = translator_ ?? nullTranslator;
-  const sessionContextDialogs =
-    sessionContextDialogs_ ?? new SessionContextDialogs({ translator });
   const preferKernelOption = PageConfig.getOption('notebookStartsKernel');
 
   // If the option is not set, assume `true`
@@ -1202,13 +838,13 @@
     | undefined;
 
   // Register notebook toolbar widgets
-  toolbarRegistry.addFactory<NotebookPanel>(FACTORY, 'save', panel =>
+  toolbarRegistry.registerFactory<NotebookPanel>(FACTORY, 'save', panel =>
     DocToolbarItems.createSaveButton(commands, panel.context.fileChanged)
   );
-  toolbarRegistry.addFactory<NotebookPanel>(FACTORY, 'cellType', panel =>
+  toolbarRegistry.registerFactory<NotebookPanel>(FACTORY, 'cellType', panel =>
     ToolbarItems.createCellTypeItem(panel, translator)
   );
-  toolbarRegistry.addFactory<NotebookPanel>(FACTORY, 'kernelName', panel =>
+  toolbarRegistry.registerFactory<NotebookPanel>(FACTORY, 'kernelName', panel =>
     Toolbar.createKernelNameItem(
       panel.sessionContext,
       sessionContextDialogs,
@@ -1216,7 +852,7 @@
     )
   );
 
-  toolbarRegistry.addFactory<NotebookPanel>(
+  toolbarRegistry.registerFactory<NotebookPanel>(
     FACTORY,
     'executionProgress',
     panel => {
@@ -1248,11 +884,8 @@
     );
   }
 
-  const trans = translator.load('jupyterlab');
-
   const factory = new NotebookWidgetFactory({
     name: FACTORY,
-    label: trans.__('Notebook'),
     fileTypes: ['notebook'],
     modelName: 'notebook',
     defaultFor: ['notebook'],
@@ -1263,11 +896,11 @@
     editorConfig: StaticNotebook.defaultEditorConfig,
     notebookConfig: StaticNotebook.defaultNotebookConfig,
     mimeTypeService: editorServices.mimeTypeService,
+    sessionDialogs: sessionContextDialogs,
     toolbarFactory,
-    translator
+    translator: translator
   });
   app.docRegistry.addWidgetFactory(factory);
-
   return factory;
 }
 
@@ -1307,7 +940,7 @@
   };
 
   commands.addCommand(CommandIDs.createOutputView, {
-    label: trans.__('Create New View for Cell Output'),
+    label: trans.__('Create New View for Output'),
     execute: async args => {
       let cell: CodeCell | undefined;
       let current: NotebookPanel | undefined | null;
@@ -1338,8 +971,7 @@
       const widget = new MainAreaWidget({ content });
       current.context.addSibling(widget, {
         ref: current.id,
-        mode: 'split-bottom',
-        type: 'Cloned Output'
+        mode: 'split-bottom'
       });
 
       const updateCloned = () => {
@@ -1408,7 +1040,7 @@
       const { context, content } = current;
 
       const cell = content.activeCell;
-      const metadata = cell?.model.metadata;
+      const metadata = cell?.model.metadata.toJSON();
       const path = context.path;
       // ignore action in non-code cell
       if (!cell || cell.model.type !== 'code') {
@@ -1417,9 +1049,6 @@
 
       let code: string;
       const editor = cell.editor;
-      if (!editor) {
-        return;
-      }
       const selection = editor.getSelection();
       const { start, end } = selection;
       const selected = start.column !== end.column || start.line !== end.line;
@@ -1428,11 +1057,11 @@
         // Get the selected code from the editor.
         const start = editor.getOffsetAt(selection.start);
         const end = editor.getOffsetAt(selection.end);
-        code = editor.model.sharedModel.getSource().substring(start, end);
+        code = editor.model.value.text.substring(start, end);
       } else {
         // no selection, find the complete statement around the current line
         const cursor = editor.getCursorPosition();
-        const srcLines = editor.model.sharedModel.getSource().split('\n');
+        const srcLines = editor.model.value.text.split('\n');
         let curLine = selection.start.line;
         while (
           curLine < editor.lineCount &&
@@ -1447,13 +1076,12 @@
         // eslint-disable-next-line
         while (true) {
           code = srcLines.slice(firstLine, lastLine).join('\n');
-          const reply =
-            await current.context.sessionContext.session?.kernel?.requestIsComplete(
-              {
-                // ipython needs an empty line at the end to correctly identify completeness of indented code
-                code: code + '\n\n'
-              }
-            );
+          const reply = await current.context.sessionContext.session?.kernel?.requestIsComplete(
+            {
+              // ipython needs an empty line at the end to correctly identify completeness of indented code
+              code: code + '\n\n'
+            }
+          );
           if (reply?.content.status === 'complete') {
             if (curLine < lastLine) {
               // we find a block of complete statement containing the current line, great!
@@ -1596,42 +1224,20 @@
 function activateNotebookHandler(
   app: JupyterFrontEnd,
   factory: NotebookWidgetFactory.IFactory,
-  extensions: IEditorExtensionRegistry,
-  executor: INotebookCellExecutor,
+  translator: ITranslator,
   palette: ICommandPalette | null,
-  defaultBrowser: IDefaultFileBrowser | null,
+  browserFactory: IFileBrowserFactory | null,
   launcher: ILauncher | null,
   restorer: ILayoutRestorer | null,
   mainMenu: IMainMenu | null,
-  router: IRouter | null,
   settingRegistry: ISettingRegistry | null,
-  sessionDialogs_: ISessionContextDialogs | null,
-  translator_: ITranslator | null,
-  formRegistry: IFormRendererRegistry | null,
-  filebrowserFactory: IFileBrowserFactory | null
+  sessionDialogs: ISessionContextDialogs | null
 ): INotebookTracker {
-  setCellExecutor(executor);
-
-  const translator = translator_ ?? nullTranslator;
-  const sessionDialogs =
-    sessionDialogs_ ?? new SessionContextDialogs({ translator });
   const trans = translator.load('jupyterlab');
   const services = app.serviceManager;
 
-  const { commands, shell } = app;
+  const { commands } = app;
   const tracker = new NotebookTracker({ namespace: 'notebook' });
-
-  // Use the router to deal with hash navigation
-  function onRouted(router: IRouter, location: IRouter.ILocation): void {
-    if (location.hash && tracker.currentWidget) {
-      tracker.currentWidget.setFragment(location.hash);
-    }
-  }
-  router?.routed.connect(onRouted);
-
-  const isEnabled = (): boolean => {
-    return Private.isEnabled(shell, tracker);
-  };
 
   const setSideBySideOutputRatio = (sideBySideOutputRatio: number) =>
     document.documentElement.style.setProperty(
@@ -1649,53 +1255,7 @@
       updateConfig(settings);
       settings.changed.connect(() => {
         updateConfig(settings);
-        commands.notifyCommandChanged(CommandIDs.virtualScrollbar);
       });
-
-      const updateSessionSettings = (
-        session: ISessionContext,
-        changes: IChangedArgs<ISessionContext.IKernelPreference>
-      ) => {
-        const { newValue, oldValue } = changes;
-        const autoStartDefault = newValue.autoStartDefault;
-
-        if (
-          typeof autoStartDefault === 'boolean' &&
-          autoStartDefault !== oldValue.autoStartDefault
-        ) {
-          // Ensure we break the cycle
-          if (
-            autoStartDefault !==
-            (settings.get('autoStartDefaultKernel').composite as boolean)
-          )
-            // Once the settings is changed `updateConfig` will take care
-            // of the propagation to existing session context.
-            settings
-              .set('autoStartDefaultKernel', autoStartDefault)
-              .catch(reason => {
-                console.error(
-                  `Failed to set ${settings.id}.autoStartDefaultKernel`
-                );
-              });
-        }
-      };
-
-      const sessionContexts = new WeakSet<ISessionContext>();
-      const listenToKernelPreference = (panel: NotebookPanel): void => {
-        const session = panel.context.sessionContext;
-        if (!session.isDisposed && !sessionContexts.has(session)) {
-          sessionContexts.add(session);
-          session.kernelPreferenceChanged.connect(updateSessionSettings);
-          session.disposed.connect(() => {
-            session.kernelPreferenceChanged.disconnect(updateSessionSettings);
-          });
-        }
-      };
-      tracker.forEach(listenToKernelPreference);
-      tracker.widgetAdded.connect((tracker, panel) => {
-        listenToKernelPreference(panel);
-      });
-
       commands.addCommand(CommandIDs.autoClosingBrackets, {
         execute: args => {
           const codeConfig = settings.get('codeCellConfig')
@@ -1723,9 +1283,7 @@
         label: trans.__('Auto Close Brackets for All Notebook Cell Types'),
         isToggled: () =>
           ['codeCellConfig', 'markdownCellConfig', 'rawCellConfig'].some(
-            x =>
-              ((settings.get(x).composite as JSONObject).autoClosingBrackets ??
-                extensions.baseConfiguration['autoClosingBrackets']) === true
+            x => (settings.get(x).composite as JSONObject).autoClosingBrackets
           )
       });
       commands.addCommand(CommandIDs.setSideBySideRatio, {
@@ -1744,45 +1302,15 @@
             .catch(console.error);
         }
       });
-      addCommands(
-        app,
-        tracker,
-        translator,
-        sessionDialogs,
-        settings,
-        isEnabled
-      );
     })
     .catch((reason: Error) => {
       console.warn(reason.message);
       updateTracker({
         editorConfig: factory.editorConfig,
         notebookConfig: factory.notebookConfig,
-        kernelShutdown: factory.shutdownOnClose,
-        autoStartDefault: factory.autoStartDefault
+        kernelShutdown: factory.shutdownOnClose
       });
-      addCommands(app, tracker, translator, sessionDialogs, null, isEnabled);
     });
-
-  if (formRegistry) {
-    const CMRenderer = formRegistry.getRenderer(
-      '@jupyterlab/codemirror-extension:plugin.defaultConfig'
-    );
-    if (CMRenderer) {
-      formRegistry.addRenderer(
-        '@jupyterlab/notebook-extension:tracker.codeCellConfig',
-        CMRenderer
-      );
-      formRegistry.addRenderer(
-        '@jupyterlab/notebook-extension:tracker.markdownCellConfig',
-        CMRenderer
-      );
-      formRegistry.addRenderer(
-        '@jupyterlab/notebook-extension:tracker.rawCellConfig',
-        CMRenderer
-      );
-    }
-  }
 
   // Handle state restoration.
   if (restorer) {
@@ -1802,6 +1330,8 @@
   });
   registry.addModelFactory(modelFactory);
 
+  addCommands(app, tracker, translator, sessionDialogs);
+
   if (palette) {
     populatePalette(palette, translator);
   }
@@ -1834,14 +1364,6 @@
     tracker.forEach(widget => {
       widget.setConfig(options);
     });
-    if (options.notebookConfig.windowingMode !== 'full') {
-      // Disable all virtual scrollbars if any was enabled
-      tracker.forEach(widget => {
-        if (widget.content.scrollbar) {
-          widget.content.scrollbar = false;
-        }
-      });
-    }
   }
 
   /**
@@ -1865,23 +1387,25 @@
 
     factory.editorConfig = { code, markdown, raw };
     factory.notebookConfig = {
-      enableKernelInitNotification: settings.get('enableKernelInitNotification')
-        .composite as boolean,
-      showHiddenCellsButton: settings.get('showHiddenCellsButton')
-        .composite as boolean,
       scrollPastEnd: settings.get('scrollPastEnd').composite as boolean,
       defaultCell: settings.get('defaultCell').composite as nbformat.CellType,
       recordTiming: settings.get('recordTiming').composite as boolean,
-      overscanCount: settings.get('overscanCount').composite as number,
-      inputHistoryScope: settings.get('inputHistoryScope').composite as
-        | 'global'
-        | 'session',
+      numberCellsToRenderDirectly: settings.get('numberCellsToRenderDirectly')
+        .composite as number,
+      remainingTimeBeforeRescheduling: settings.get(
+        'remainingTimeBeforeRescheduling'
+      ).composite as number,
+      renderCellOnIdle: settings.get('renderCellOnIdle').composite as boolean,
+      observedTopMargin: settings.get('observedTopMargin').composite as string,
+      observedBottomMargin: settings.get('observedBottomMargin')
+        .composite as string,
       maxNumberOutputs: settings.get('maxNumberOutputs').composite as number,
       showEditorForReadOnlyMarkdown: settings.get(
         'showEditorForReadOnlyMarkdown'
       ).composite as boolean,
-      disableDocumentWideUndoRedo: !settings.get('documentWideUndoRedo')
-        .composite as boolean,
+      disableDocumentWideUndoRedo: settings.get(
+        'experimentalDisableDocumentWideUndoRedo'
+      ).composite as boolean,
       renderingLayout: settings.get('renderingLayout').composite as
         | 'default'
         | 'side-by-side',
@@ -1891,16 +1415,10 @@
         'sideBySideRightMarginOverride'
       ).composite as string,
       sideBySideOutputRatio: settings.get('sideBySideOutputRatio')
-        .composite as number,
-      windowingMode: settings.get('windowingMode').composite as
-        | 'defer'
-        | 'full'
-        | 'none',
-      accessKernelHistory: settings.get('accessKernelHistory')
-        .composite as boolean
+        .composite as number
     };
     setSideBySideOutputRatio(factory.notebookConfig.sideBySideOutputRatio);
-    const sideBySideMarginStyle = `.jp-mod-sideBySide.jp-Notebook .jp-Notebook-cell {
+    const sideBySideMarginStyle = `.jp-mod-sideBySide.jp-Notebook .jp-Notebook-cell { 
       margin-left: ${factory.notebookConfig.sideBySideLeftMarginOverride} !important;
       margin-right: ${factory.notebookConfig.sideBySideRightMarginOverride} !important;`;
     const sideBySideMarginTag = document.getElementById(SIDE_BY_SIDE_STYLE_ID);
@@ -1912,8 +1430,6 @@
         `<style id="${SIDE_BY_SIDE_STYLE_ID}">${sideBySideMarginStyle}}</style>`
       );
     }
-    factory.autoStartDefault = settings.get('autoStartDefaultKernel')
-      .composite as boolean;
     factory.shutdownOnClose = settings.get('kernelShutdown')
       .composite as boolean;
 
@@ -1924,32 +1440,27 @@
     updateTracker({
       editorConfig: factory.editorConfig,
       notebookConfig: factory.notebookConfig,
-      kernelShutdown: factory.shutdownOnClose,
-      autoStartDefault: factory.autoStartDefault
+      kernelShutdown: factory.shutdownOnClose
     });
   }
 
   // Add main menu notebook menu.
   if (mainMenu) {
-    populateMenus(mainMenu, isEnabled);
+    populateMenus(app, mainMenu, tracker, translator, sessionDialogs);
   }
 
   // Utility function to create a new notebook.
-  const createNew = async (
-    cwd: string,
-    kernelId: string,
-    kernelName: string
-  ) => {
+  const createNew = async (cwd: string, kernelName?: string) => {
     const model = await commands.execute('docmanager:new-untitled', {
       path: cwd,
       type: 'notebook'
     });
-    if (model !== undefined) {
-      const widget = (await commands.execute('docmanager:open', {
+    if (model != undefined) {
+      const widget = ((await commands.execute('docmanager:open', {
         path: model.path,
         factory: FACTORY,
-        kernel: { id: kernelId, name: kernelName }
-      })) as unknown as IDocumentWidget;
+        kernel: { name: kernelName }
+      })) as unknown) as IDocumentWidget;
       widget.isUntitled = true;
       return widget;
     }
@@ -1973,12 +1484,11 @@
     caption: trans.__('Create a new notebook'),
     icon: args => (args['isPalette'] ? undefined : notebookIcon),
     execute: args => {
-      const currentBrowser =
-        filebrowserFactory?.tracker.currentWidget ?? defaultBrowser;
-      const cwd = (args['cwd'] as string) || (currentBrowser?.model.path ?? '');
-      const kernelId = (args['kernelId'] as string) || '';
+      const cwd =
+        (args['cwd'] as string) ||
+        (browserFactory ? browserFactory.defaultBrowser.model.path : '');
       const kernelName = (args['kernelName'] as string) || '';
-      return createNew(cwd, kernelId, kernelName);
+      return createNew(cwd, kernelName);
     }
   });
 
@@ -2026,115 +1536,6 @@
   return tracker;
 }
 
-/**
- * Activate the completer service for notebook.
- */
-function activateNotebookCompleterService(
-  app: JupyterFrontEnd,
-  notebooks: INotebookTracker,
-  manager: ICompletionProviderManager | null,
-  translator: ITranslator | null,
-  appSanitizer: IRenderMime.ISanitizer | null
-): void {
-  if (!manager) {
-    return;
-  }
-  const trans = (translator ?? nullTranslator).load('jupyterlab');
-  const sanitizer = appSanitizer ?? new Sanitizer();
-  app.commands.addCommand(CommandIDs.invokeCompleter, {
-    label: trans.__('Display the completion helper.'),
-    execute: args => {
-      const panel = notebooks.currentWidget;
-      if (panel && panel.content.activeCell?.model.type === 'code') {
-        manager.invoke(panel.id);
-      }
-    }
-  });
-
-  app.commands.addCommand(CommandIDs.selectCompleter, {
-    label: trans.__('Select the completion suggestion.'),
-    execute: () => {
-      const id = notebooks.currentWidget && notebooks.currentWidget.id;
-
-      if (id) {
-        return manager.select(id);
-      }
-    }
-  });
-
-  app.commands.addKeyBinding({
-    command: CommandIDs.selectCompleter,
-    keys: ['Enter'],
-    selector: '.jp-Notebook .jp-mod-completer-active'
-  });
-  const updateCompleter = async (
-    _: INotebookTracker | undefined,
-    notebook: NotebookPanel
-  ) => {
-    const completerContext = {
-      editor: notebook.content.activeCell?.editor ?? null,
-      session: notebook.sessionContext.session,
-      widget: notebook,
-      sanitizer: sanitizer
-    };
-    await manager.updateCompleter(completerContext);
-    notebook.content.activeCellChanged.connect((_, cell) => {
-      // Ensure the editor will exist on the cell before adding the completer
-      cell?.ready
-        .then(() => {
-          const newCompleterContext = {
-            editor: cell.editor,
-            session: notebook.sessionContext.session,
-            widget: notebook,
-            sanitizer: sanitizer
-          };
-          return manager.updateCompleter(newCompleterContext);
-        })
-        .catch(console.error);
-    });
-    notebook.sessionContext.sessionChanged.connect(() => {
-      // Ensure the editor will exist on the cell before adding the completer
-      notebook.content.activeCell?.ready
-        .then(() => {
-          const newCompleterContext = {
-            editor: notebook.content.activeCell?.editor ?? null,
-            session: notebook.sessionContext.session,
-            widget: notebook
-          };
-          return manager.updateCompleter(newCompleterContext);
-        })
-        .catch(console.error);
-    });
-  };
-  notebooks.widgetAdded.connect(updateCompleter);
-  manager.activeProvidersChanged.connect(() => {
-    notebooks.forEach(panel => {
-      updateCompleter(undefined, panel).catch(e => console.error(e));
-    });
-  });
-}
-
-/**
- * Activate the language server for notebook.
- */
-function activateNotebookLanguageServer(
-  app: JupyterFrontEnd,
-  notebooks: INotebookTracker,
-  connectionManager: ILSPDocumentConnectionManager,
-  featureManager: ILSPFeatureManager,
-  codeExtractorManager: ILSPCodeExtractorsManager,
-  adapterTracker: IWidgetLSPAdapterTracker
-): void {
-  notebooks.widgetAdded.connect(async (_, notebook) => {
-    const adapter = new NotebookAdapter(notebook, {
-      connectionManager,
-      featureManager,
-      foreignCodeExtractorsManager: codeExtractorManager
-    });
-    (adapterTracker as WidgetLSPAdapterTracker).add(adapter);
-  });
-}
-
 // Get the current widget and activate unless the args specify otherwise.
 function getCurrent(
   tracker: INotebookTracker,
@@ -2158,12 +1559,16 @@
   app: JupyterFrontEnd,
   tracker: NotebookTracker,
   translator: ITranslator,
-  sessionDialogs: ISessionContextDialogs,
-  settings: ISettingRegistry.ISettings | null,
-  isEnabled: () => boolean
+  sessionDialogs: ISessionContextDialogs | null
 ): void {
   const trans = translator.load('jupyterlab');
   const { commands, shell } = app;
+
+  sessionDialogs = sessionDialogs ?? sessionContextDialogs;
+
+  const isEnabled = (): boolean => {
+    return Private.isEnabled(shell, tracker);
+  };
 
   const isEnabledAndSingleSelected = (): boolean => {
     return Private.isEnabledAndSingleSelected(shell, tracker);
@@ -2191,7 +1596,10 @@
         return;
       }
       panel.content.model.cells.changed.connect(
-        (list: any, args: IObservableList.IChangedArgs<ICellModel>) => {
+        (
+          list: IObservableUndoableList<ICellModel>,
+          args: IObservableList.IChangedArgs<ICellModel>
+        ) => {
           // Might be overkill to refresh this every time, but
           // it helps to keep the collapse state consistent.
           refreshCellCollapsed(panel.content);
@@ -2205,125 +1613,54 @@
     }
   );
 
-  tracker.selectionChanged.connect(() => {
-    commands.notifyCommandChanged(CommandIDs.duplicateBelow);
-    commands.notifyCommandChanged(CommandIDs.deleteCell);
-    commands.notifyCommandChanged(CommandIDs.copy);
-    commands.notifyCommandChanged(CommandIDs.cut);
-    commands.notifyCommandChanged(CommandIDs.pasteBelow);
-    commands.notifyCommandChanged(CommandIDs.pasteAbove);
-    commands.notifyCommandChanged(CommandIDs.pasteAndReplace);
-    commands.notifyCommandChanged(CommandIDs.moveUp);
-    commands.notifyCommandChanged(CommandIDs.moveDown);
-    commands.notifyCommandChanged(CommandIDs.run);
-    commands.notifyCommandChanged(CommandIDs.runAll);
-    commands.notifyCommandChanged(CommandIDs.runAndAdvance);
-    commands.notifyCommandChanged(CommandIDs.runAndInsert);
-  });
-  tracker.activeCellChanged.connect(() => {
-    commands.notifyCommandChanged(CommandIDs.moveUp);
-    commands.notifyCommandChanged(CommandIDs.moveDown);
-  });
-
   commands.addCommand(CommandIDs.runAndAdvance, {
-    label: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Run Selected Cell',
-        'Run Selected Cells',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
-    caption: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Run this cell and advance',
-        'Run these %1 cells and advance',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
+    label: trans.__('Run Selected Cells'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
       if (current) {
         const { context, content } = current;
 
-        return NotebookActions.runAndAdvance(
-          content,
-          context.sessionContext,
-          sessionDialogs,
-          translator
-        );
-      }
-    },
-    isEnabled: args => (args.toolbar ? true : isEnabled()),
-    icon: args => (args.toolbar ? runIcon : undefined)
+        return NotebookActions.runAndAdvance(content, context.sessionContext);
+      }
+    },
+    isEnabled
   });
   commands.addCommand(CommandIDs.run, {
-    label: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Run Selected Cell and Do not Advance',
-        'Run Selected Cells and Do not Advance',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
+    label: trans.__('Run Selected Cells and Do not Advance'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
       if (current) {
         const { context, content } = current;
 
-        return NotebookActions.run(
-          content,
-          context.sessionContext,
-          sessionDialogs,
-          translator
-        );
+        return NotebookActions.run(content, context.sessionContext);
       }
     },
     isEnabled
   });
   commands.addCommand(CommandIDs.runAndInsert, {
-    label: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Run Selected Cell and Insert Below',
-        'Run Selected Cells and Insert Below',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
+    label: trans.__('Run Selected Cells and Insert Below'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
       if (current) {
         const { context, content } = current;
 
-        return NotebookActions.runAndInsert(
-          content,
-          context.sessionContext,
-          sessionDialogs,
-          translator
-        );
+        return NotebookActions.runAndInsert(content, context.sessionContext);
       }
     },
     isEnabled
   });
   commands.addCommand(CommandIDs.runAll, {
     label: trans.__('Run All Cells'),
-    caption: trans.__('Run all cells'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
       if (current) {
         const { context, content } = current;
 
-        return NotebookActions.runAll(
-          content,
-          context.sessionContext,
-          sessionDialogs,
-          translator
-        );
+        return NotebookActions.runAll(content, context.sessionContext);
       }
     },
     isEnabled
@@ -2336,12 +1673,7 @@
       if (current) {
         const { context, content } = current;
 
-        return NotebookActions.runAllAbove(
-          content,
-          context.sessionContext,
-          sessionDialogs,
-          translator
-        );
+        return NotebookActions.runAllAbove(content, context.sessionContext);
       }
     },
     isEnabled: () => {
@@ -2361,12 +1693,7 @@
       if (current) {
         const { context, content } = current;
 
-        return NotebookActions.runAllBelow(
-          content,
-          context.sessionContext,
-          sessionDialogs,
-          translator
-        );
+        return NotebookActions.runAllBelow(content, context.sessionContext);
       }
     },
     isEnabled: () => {
@@ -2384,40 +1711,28 @@
     execute: args => {
       const current = getCurrent(tracker, shell, args);
       if (current) {
-        const { content } = current;
-        return NotebookActions.renderAllMarkdown(content);
+        const { context, content } = current;
+        return NotebookActions.renderAllMarkdown(
+          content,
+          context.sessionContext
+        );
       }
     },
     isEnabled
   });
   commands.addCommand(CommandIDs.restart, {
     label: trans.__('Restart Kernel'),
-    caption: trans.__('Restart the kernel'),
-    execute: args => {
-      const current = getCurrent(tracker, shell, args);
-
-      if (current) {
-        return sessionDialogs.restart(current.sessionContext);
-      }
-    },
-    isEnabled: args => (args.toolbar ? true : isEnabled()),
-    icon: args => (args.toolbar ? refreshIcon : undefined)
-  });
-  commands.addCommand(CommandIDs.shutdown, {
-    label: trans.__('Shut Down Kernel'),
-    execute: args => {
-      const current = getCurrent(tracker, shell, args);
-
-      if (!current) {
-        return;
-      }
-
-      return current.context.sessionContext.shutdown();
+    execute: args => {
+      const current = getCurrent(tracker, shell, args);
+
+      if (current) {
+        return sessionDialogs!.restart(current.sessionContext, translator);
+      }
     },
     isEnabled
   });
   commands.addCommand(CommandIDs.closeAndShutdown, {
-    label: trans.__('Close and Shut Down Notebook'),
+    label: trans.__('Close and Shut Down'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
@@ -2433,11 +1748,9 @@
         buttons: [Dialog.cancelButton(), Dialog.warnButton()]
       }).then(result => {
         if (result.button.accept) {
-          return commands
-            .execute(CommandIDs.shutdown, { activate: false })
-            .then(() => {
-              current.dispose();
-            });
+          return current.context.sessionContext.shutdown().then(() => {
+            current.dispose();
+          });
         }
       });
     },
@@ -2455,102 +1768,94 @@
     isEnabled
   });
   commands.addCommand(CommandIDs.restartClear, {
-    label: trans.__('Restart Kernel and Clear Outputs of All Cells'),
-    caption: trans.__('Restart the kernel and clear all outputs of all cells'),
-    execute: async () => {
-      const restarted: boolean = await commands.execute(CommandIDs.restart, {
-        activate: false
-      });
-      if (restarted) {
-        await commands.execute(CommandIDs.clearAllOutputs);
+    label: trans.__('Restart Kernel and Clear All Outputs'),
+    execute: args => {
+      const current = getCurrent(tracker, shell, args);
+
+      if (current) {
+        const { content, sessionContext } = current;
+
+        return sessionDialogs!.restart(sessionContext, translator).then(() => {
+          NotebookActions.clearAllOutputs(content);
+        });
       }
     },
     isEnabled
   });
   commands.addCommand(CommandIDs.restartAndRunToSelected, {
     label: trans.__('Restart Kernel and Run up to Selected Cell'),
-    execute: async args => {
-      const current = getCurrent(tracker, shell, { activate: false, ...args });
+    execute: args => {
+      const current = getCurrent(tracker, shell, args);
+      if (current) {
+        const { context, content } = current;
+        return sessionDialogs!
+          .restart(current.sessionContext, translator)
+          .then(restarted => {
+            if (restarted) {
+              void NotebookActions.runAllAbove(
+                content,
+                context.sessionContext
+              ).then(executed => {
+                if (executed || content.activeCellIndex === 0) {
+                  void NotebookActions.run(content, context.sessionContext);
+                }
+              });
+            }
+          });
+      }
+    },
+    isEnabled: isEnabledAndSingleSelected
+  });
+  commands.addCommand(CommandIDs.restartRunAll, {
+    label: trans.__('Restart Kernel and Run All Cells'),
+    execute: args => {
+      const current = getCurrent(tracker, shell, args);
+
+      if (current) {
+        const { context, content, sessionContext } = current;
+
+        return sessionDialogs!
+          .restart(sessionContext, translator)
+          .then(restarted => {
+            if (restarted) {
+              void NotebookActions.runAll(content, context.sessionContext);
+            }
+            return restarted;
+          });
+      }
+    },
+    isEnabled
+  });
+  commands.addCommand(CommandIDs.clearAllOutputs, {
+    label: trans.__('Clear All Outputs'),
+    execute: args => {
+      const current = getCurrent(tracker, shell, args);
+
+      if (current) {
+        return NotebookActions.clearAllOutputs(current.content);
+      }
+    },
+    isEnabled
+  });
+  commands.addCommand(CommandIDs.clearOutputs, {
+    label: trans.__('Clear Outputs'),
+    execute: args => {
+      const current = getCurrent(tracker, shell, args);
+
+      if (current) {
+        return NotebookActions.clearOutputs(current.content);
+      }
+    },
+    isEnabled
+  });
+  commands.addCommand(CommandIDs.interrupt, {
+    label: trans.__('Interrupt Kernel'),
+    execute: args => {
+      const current = getCurrent(tracker, shell, args);
+
       if (!current) {
         return;
       }
-      const { context, content } = current;
-
-      const cells = content.widgets.slice(0, content.activeCellIndex + 1);
-      const restarted = await sessionDialogs.restart(current.sessionContext);
-
-      if (restarted) {
-        return NotebookActions.runCells(
-          content,
-          cells,
-          context.sessionContext,
-          sessionDialogs,
-          translator
-        );
-      }
-    },
-    isEnabled: isEnabledAndSingleSelected
-  });
-  commands.addCommand(CommandIDs.restartRunAll, {
-    label: trans.__('Restart Kernel and Run All Cells'),
-    caption: trans.__('Restart the kernel and run all cells'),
-    execute: async args => {
-      const current = getCurrent(tracker, shell, { activate: false, ...args });
-
-      if (!current) {
-        return;
-      }
-      const { context, content } = current;
-
-      const cells = content.widgets;
-      const restarted = await sessionDialogs.restart(current.sessionContext);
-
-      if (restarted) {
-        return NotebookActions.runCells(
-          content,
-          cells,
-          context.sessionContext,
-          sessionDialogs,
-          translator
-        );
-      }
-    },
-    isEnabled: args => (args.toolbar ? true : isEnabled()),
-    icon: args => (args.toolbar ? fastForwardIcon : undefined)
-  });
-  commands.addCommand(CommandIDs.clearAllOutputs, {
-    label: trans.__('Clear Outputs of All Cells'),
-    caption: trans.__('Clear all outputs of all cells'),
-    execute: args => {
-      const current = getCurrent(tracker, shell, args);
-
-      if (current) {
-        return NotebookActions.clearAllOutputs(current.content);
-      }
-    },
-    isEnabled
-  });
-  commands.addCommand(CommandIDs.clearOutputs, {
-    label: trans.__('Clear Cell Output'),
-    caption: trans.__('Clear outputs for the selected cells'),
-    execute: args => {
-      const current = getCurrent(tracker, shell, args);
-
-      if (current) {
-        return NotebookActions.clearOutputs(current.content);
-      }
-    },
-    isEnabled
-  });
-  commands.addCommand(CommandIDs.interrupt, {
-    label: trans.__('Interrupt Kernel'),
-    caption: trans.__('Interrupt the kernel'),
-    execute: args => {
-      const current = getCurrent(tracker, shell, args);
-
-      if (!current) {
-        return;
-      }
 
       const kernel = current.context.sessionContext.session?.kernel;
 
@@ -2558,8 +1863,7 @@
         return kernel.interrupt();
       }
     },
-    isEnabled: args => (args.toolbar ? true : isEnabled()),
-    icon: args => (args.toolbar ? stopIcon : undefined)
+    isEnabled
   });
   commands.addCommand(CommandIDs.toCode, {
     label: trans.__('Change to Code Cell Type'),
@@ -2567,11 +1871,7 @@
       const current = getCurrent(tracker, shell, args);
 
       if (current) {
-        return NotebookActions.changeCellType(
-          current.content,
-          'code',
-          translator
-        );
+        return NotebookActions.changeCellType(current.content, 'code');
       }
     },
     isEnabled
@@ -2582,11 +1882,7 @@
       const current = getCurrent(tracker, shell, args);
 
       if (current) {
-        return NotebookActions.changeCellType(
-          current.content,
-          'markdown',
-          translator
-        );
+        return NotebookActions.changeCellType(current.content, 'markdown');
       }
     },
     isEnabled
@@ -2597,32 +1893,14 @@
       const current = getCurrent(tracker, shell, args);
 
       if (current) {
-        return NotebookActions.changeCellType(
-          current.content,
-          'raw',
-          translator
-        );
+        return NotebookActions.changeCellType(current.content, 'raw');
       }
     },
     isEnabled
   });
   commands.addCommand(CommandIDs.cut, {
-    label: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Cut Cell',
-        'Cut Cells',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
-    caption: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Cut this cell',
-        'Cut these %1 cells',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
+    label: trans.__('Cut Cells'),
+    caption: trans.__('Cut the selected cells'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
@@ -2631,25 +1909,11 @@
       }
     },
     icon: args => (args.toolbar ? cutIcon : undefined),
-    isEnabled: args => (args.toolbar ? true : isEnabled())
+    isEnabled
   });
   commands.addCommand(CommandIDs.copy, {
-    label: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Copy Cell',
-        'Copy Cells',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
-    caption: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Copy this cell',
-        'Copy these %1 cells',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
+    label: trans.__('Copy Cells'),
+    caption: trans.__('Copy the selected cells'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
@@ -2657,26 +1921,12 @@
         return NotebookActions.copy(current.content);
       }
     },
-    icon: args => (args.toolbar ? copyIcon : undefined),
-    isEnabled: args => (args.toolbar ? true : isEnabled())
+    icon: args => (args.toolbar ? copyIcon : ''),
+    isEnabled
   });
   commands.addCommand(CommandIDs.pasteBelow, {
-    label: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Paste Cell Below',
-        'Paste Cells Below',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
-    caption: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Paste this cell from the clipboard',
-        'Paste these %1 cells from the clipboard',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
+    label: trans.__('Paste Cells Below'),
+    caption: trans.__('Paste cells from the clipboard'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
@@ -2685,25 +1935,10 @@
       }
     },
     icon: args => (args.toolbar ? pasteIcon : undefined),
-    isEnabled: args => (args.toolbar ? true : isEnabled())
+    isEnabled
   });
   commands.addCommand(CommandIDs.pasteAbove, {
-    label: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Paste Cell Above',
-        'Paste Cells Above',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
-    caption: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Paste this cell from the clipboard',
-        'Paste these %1 cells from the clipboard',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
+    label: trans.__('Paste Cells Above'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
@@ -2714,22 +1949,10 @@
     isEnabled
   });
   commands.addCommand(CommandIDs.duplicateBelow, {
-    label: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Duplicate Cell Below',
-        'Duplicate Cells Below',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
-    caption: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Create a duplicate of this cell below',
-        'Create duplicates of %1 cells below',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
+    label: trans.__('Duplicate Cells Below'),
+    caption: trans.__(
+      'Copy the selected cells and paste them below the selection'
+    ),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
@@ -2737,18 +1960,11 @@
         NotebookActions.duplicate(current.content, 'belowSelected');
       }
     },
-    icon: args => (args.toolbar ? duplicateIcon : undefined),
-    isEnabled: args => (args.toolbar ? true : isEnabled())
+    icon: args => (args.toolbar ? duplicateIcon : ''),
+    isEnabled
   });
   commands.addCommand(CommandIDs.pasteAndReplace, {
-    label: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Paste Cell and Replace',
-        'Paste Cells and Replace',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
+    label: trans.__('Paste Cells and Replace'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
@@ -2759,23 +1975,7 @@
     isEnabled
   });
   commands.addCommand(CommandIDs.deleteCell, {
-    label: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Delete Cell',
-        'Delete Cells',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
-    caption: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Delete this cell',
-        'Delete these %1 cells',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
-
+    label: trans.__('Delete Cells'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
@@ -2783,7 +1983,7 @@
         return NotebookActions.deleteCells(current.content);
       }
     },
-    isEnabled: args => (args.toolbar ? true : isEnabled())
+    isEnabled
   });
   commands.addCommand(CommandIDs.split, {
     label: trans.__('Split Cell'),
@@ -2831,7 +2031,6 @@
   });
   commands.addCommand(CommandIDs.insertAbove, {
     label: trans.__('Insert Cell Above'),
-    caption: trans.__('Insert a cell above'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
@@ -2840,7 +2039,7 @@
       }
     },
     icon: args => (args.toolbar ? addAboveIcon : undefined),
-    isEnabled: args => (args.toolbar ? true : isEnabled())
+    isEnabled
   });
   commands.addCommand(CommandIDs.insertBelow, {
     label: trans.__('Insert Cell Below'),
@@ -2853,7 +2052,7 @@
       }
     },
     icon: args => (args.toolbar ? addBelowIcon : undefined),
-    isEnabled: args => (args.toolbar ? true : isEnabled())
+    isEnabled
   });
   commands.addCommand(CommandIDs.selectAbove, {
     label: trans.__('Select Cell Above'),
@@ -2870,56 +2069,9 @@
     label: trans.__('Select Cell Below'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
+
       if (current) {
         return NotebookActions.selectBelow(current.content);
-      }
-    },
-    isEnabled
-  });
-  commands.addCommand(CommandIDs.insertHeadingAbove, {
-    label: trans.__('Insert Heading Above Current Heading'),
-    execute: args => {
-      const current = getCurrent(tracker, shell, args);
-
-      if (current) {
-        return NotebookActions.insertSameLevelHeadingAbove(current.content);
-      }
-    },
-    isEnabled
-  });
-  commands.addCommand(CommandIDs.insertHeadingBelow, {
-    label: trans.__('Insert Heading Below Current Heading'),
-    execute: args => {
-      const current = getCurrent(tracker, shell, args);
-
-      if (current) {
-        return NotebookActions.insertSameLevelHeadingBelow(current.content);
-      }
-    },
-    isEnabled
-  });
-  commands.addCommand(CommandIDs.selectHeadingAboveOrCollapse, {
-    label: trans.__('Select Heading Above or Collapse Heading'),
-    execute: args => {
-      const current = getCurrent(tracker, shell, args);
-
-      if (current) {
-        return NotebookActions.selectHeadingAboveOrCollapseHeading(
-          current.content
-        );
-      }
-    },
-    isEnabled
-  });
-  commands.addCommand(CommandIDs.selectHeadingBelowOrExpand, {
-    label: trans.__('Select Heading Below or Expand Heading'),
-    execute: args => {
-      const current = getCurrent(tracker, shell, args);
-
-      if (current) {
-        return NotebookActions.selectHeadingBelowOrExpandHeading(
-          current.content
-        );
       }
     },
     isEnabled
@@ -2991,83 +2143,31 @@
     isEnabled
   });
   commands.addCommand(CommandIDs.moveUp, {
-    label: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Move Cell Up',
-        'Move Cells Up',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
-    caption: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Move this cell up',
-        'Move these %1 cells up',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
-    execute: args => {
-      const current = getCurrent(tracker, shell, args);
-
-      if (current) {
-        NotebookActions.moveUp(current.content);
-        Private.raiseSilentNotification(
-          trans.__('Notebook cell shifted up successfully'),
-          current.node
-        );
-      }
-    },
-    isEnabled: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      if (!current) {
-        return false;
-      }
-      return current.content.activeCellIndex >= 1;
-    },
+    label: trans.__('Move Cells Up'),
+    execute: args => {
+      const current = getCurrent(tracker, shell, args);
+
+      if (current) {
+        return NotebookActions.moveUp(current.content);
+      }
+    },
+    isEnabled,
     icon: args => (args.toolbar ? moveUpIcon : undefined)
   });
   commands.addCommand(CommandIDs.moveDown, {
-    label: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Move Cell Down',
-        'Move Cells Down',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
-    caption: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      return trans._n(
-        'Move this cell down',
-        'Move these %1 cells down',
-        current?.content.selectedCells.length ?? 1
-      );
-    },
-    execute: args => {
-      const current = getCurrent(tracker, shell, args);
-
-      if (current) {
-        NotebookActions.moveDown(current.content);
-        Private.raiseSilentNotification(
-          trans.__('Notebook cell shifted down successfully'),
-          current.node
-        );
-      }
-    },
-    isEnabled: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      if (!current || !current.content.model) {
-        return false;
-      }
-
-      const length = current.content.model.cells.length;
-      return current.content.activeCellIndex < length - 1;
-    },
+    label: trans.__('Move Cells Down'),
+    execute: args => {
+      const current = getCurrent(tracker, shell, args);
+
+      if (current) {
+        return NotebookActions.moveDown(current.content);
+      }
+    },
+    isEnabled,
     icon: args => (args.toolbar ? moveDownIcon : undefined)
   });
   commands.addCommand(CommandIDs.toggleAllLines, {
-    label: trans.__('Show Line Numbers'),
+    label: trans.__('Toggle All Line Numbers'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
@@ -3075,20 +2175,7 @@
         return NotebookActions.toggleAllLineNumbers(current.content);
       }
     },
-    isEnabled,
-    isToggled: args => {
-      const current = getCurrent(tracker, shell, { ...args, activate: false });
-      if (current) {
-        const config = current.content.editorConfig;
-        return !!(
-          config.code.lineNumbers &&
-          config.markdown.lineNumbers &&
-          config.raw.lineNumbers
-        );
-      } else {
-        return false;
-      }
-    }
+    isEnabled
   });
   commands.addCommand(CommandIDs.commandMode, {
     label: trans.__('Enter Command Mode'),
@@ -3134,58 +2221,22 @@
     },
     isEnabled
   });
-  commands.addCommand(CommandIDs.redo, {
-    label: trans.__('Redo'),
-    execute: args => {
-      const current = getCurrent(tracker, shell, args);
-
-      if (current) {
-        const cell = current.content.activeCell;
-        if (cell) {
-          cell.inputHidden = false;
-          return cell.editor?.redo();
-        }
-      }
-    }
-  });
-  commands.addCommand(CommandIDs.undo, {
-    label: trans.__('Undo'),
-    execute: args => {
-      const current = getCurrent(tracker, shell, args);
-
-      if (current) {
-        const cell = current.content.activeCell;
-        if (cell) {
-          cell.inputHidden = false;
-          return cell.editor?.undo();
-        }
-      }
-    }
-  });
   commands.addCommand(CommandIDs.changeKernel, {
     label: trans.__('Change Kernel'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
       if (current) {
-        return sessionDialogs.selectKernel(current.context.sessionContext);
-      }
-    },
-    isEnabled
-  });
-  commands.addCommand(CommandIDs.getKernel, {
-    label: trans.__('Get Kernel'),
-    execute: args => {
-      const current = getCurrent(tracker, shell, { activate: false, ...args });
-
-      if (current) {
-        return current.sessionContext.session?.kernel;
+        return sessionDialogs!.selectKernel(
+          current.context.sessionContext,
+          translator
+        );
       }
     },
     isEnabled
   });
   commands.addCommand(CommandIDs.reconnectToKernel, {
-    label: trans.__('Reconnect to Kernel'),
+    label: trans.__('Reconnect To Kernel'),
     execute: args => {
       const current = getCurrent(tracker, shell, args);
 
@@ -3207,11 +2258,7 @@
       const current = getCurrent(tracker, shell, args);
 
       if (current) {
-        return NotebookActions.setMarkdownHeader(
-          current.content,
-          1,
-          translator
-        );
+        return NotebookActions.setMarkdownHeader(current.content, 1);
       }
     },
     isEnabled
@@ -3222,11 +2269,7 @@
       const current = getCurrent(tracker, shell, args);
 
       if (current) {
-        return NotebookActions.setMarkdownHeader(
-          current.content,
-          2,
-          translator
-        );
+        return NotebookActions.setMarkdownHeader(current.content, 2);
       }
     },
     isEnabled
@@ -3237,11 +2280,7 @@
       const current = getCurrent(tracker, shell, args);
 
       if (current) {
-        return NotebookActions.setMarkdownHeader(
-          current.content,
-          3,
-          translator
-        );
+        return NotebookActions.setMarkdownHeader(current.content, 3);
       }
     },
     isEnabled
@@ -3252,11 +2291,7 @@
       const current = getCurrent(tracker, shell, args);
 
       if (current) {
-        return NotebookActions.setMarkdownHeader(
-          current.content,
-          4,
-          translator
-        );
+        return NotebookActions.setMarkdownHeader(current.content, 4);
       }
     },
     isEnabled
@@ -3267,11 +2302,7 @@
       const current = getCurrent(tracker, shell, args);
 
       if (current) {
-        return NotebookActions.setMarkdownHeader(
-          current.content,
-          5,
-          translator
-        );
+        return NotebookActions.setMarkdownHeader(current.content, 5);
       }
     },
     isEnabled
@@ -3282,11 +2313,7 @@
       const current = getCurrent(tracker, shell, args);
 
       if (current) {
-        return NotebookActions.setMarkdownHeader(
-          current.content,
-          6,
-          translator
-        );
+        return NotebookActions.setMarkdownHeader(current.content, 6);
       }
     },
     isEnabled
@@ -3446,9 +2473,8 @@
     },
     isEnabled
   });
-
   commands.addCommand(CommandIDs.toggleCollapseCmd, {
-    label: trans.__('Toggle Collapse Notebook Heading'),
+    label: 'Toggle Collapse Notebook Heading',
     execute: args => {
       const current = getCurrent(tracker, shell, args);
       if (current) {
@@ -3458,16 +2484,16 @@
     isEnabled: isEnabledAndHeadingSelected
   });
   commands.addCommand(CommandIDs.collapseAllCmd, {
-    label: trans.__('Collapse All Headings'),
-    execute: args => {
-      const current = getCurrent(tracker, shell, args);
-      if (current) {
-        return NotebookActions.collapseAllHeadings(current.content);
+    label: 'Collapse All Cells',
+    execute: args => {
+      const current = getCurrent(tracker, shell, args);
+      if (current) {
+        return NotebookActions.collapseAll(current.content);
       }
     }
   });
   commands.addCommand(CommandIDs.expandAllCmd, {
-    label: trans.__('Expand All Headings'),
+    label: 'Expand All Headings',
     execute: args => {
       const current = getCurrent(tracker, shell, args);
       if (current) {
@@ -3475,103 +2501,6 @@
       }
     }
   });
-  commands.addCommand(CommandIDs.tocRunCells, {
-    label: trans.__('Select and Run Cell(s) for this Heading'),
-    execute: args => {
-      const current = getCurrent(tracker, shell, { activate: false, ...args });
-      if (current === null) {
-        return;
-      }
-
-      const activeCell = current.content.activeCell;
-      let lastIndex = current.content.activeCellIndex;
-
-      if (activeCell instanceof MarkdownCell) {
-        const cells = current.content.widgets;
-        const level = activeCell.headingInfo.level;
-        for (
-          let i = current.content.activeCellIndex + 1;
-          i < cells.length;
-          i++
-        ) {
-          const cell = cells[i];
-          if (
-            cell instanceof MarkdownCell &&
-            // cell.headingInfo.level === -1 if no heading
-            cell.headingInfo.level >= 0 &&
-            cell.headingInfo.level <= level
-          ) {
-            break;
-          }
-          lastIndex = i;
-        }
-      }
-
-      current.content.extendContiguousSelectionTo(lastIndex);
-      void NotebookActions.run(
-        current.content,
-        current.sessionContext,
-        sessionDialogs,
-        translator
-      );
-    }
-  });
-  commands.addCommand(CommandIDs.accessPreviousHistory, {
-    label: trans.__('Access Previous Kernel History Entry'),
-    execute: async args => {
-      const current = getCurrent(tracker, shell, args);
-      if (current) {
-        return await NotebookActions.accessPreviousHistory(current.content);
-      }
-    }
-  });
-  commands.addCommand(CommandIDs.accessNextHistory, {
-    label: trans.__('Access Next Kernel History Entry'),
-    execute: async args => {
-      const current = getCurrent(tracker, shell, args);
-      if (current) {
-        return await NotebookActions.accessNextHistory(current.content);
-      }
-    }
-  });
-
-  commands.addCommand(CommandIDs.virtualScrollbar, {
-    label: trans.__('Virtual Scrollbar'),
-    caption: trans.__(
-      'Toggle virtual scrollbar (enabled with windowing mode: full)'
-    ),
-    execute: args => {
-      const current = getCurrent(tracker, shell, args);
-
-      if (current) {
-        current.content.scrollbar = !current.content.scrollbar;
-      }
-    },
-    icon: args => (args.toolbar ? tableRowsIcon : undefined),
-    isEnabled: args => {
-      const enabled =
-        (args.toolbar ? true : isEnabled()) &&
-        (settings?.composite.windowingMode === 'full' ?? false);
-      return enabled;
-    },
-    isVisible: args => {
-      const visible =
-        (args.toolbar ? true : isEnabled()) &&
-        (settings?.composite.windowingMode === 'full' ?? false);
-      return visible;
-    }
-  });
-
-  // All commands with isEnabled defined directly or in a semantic commands
-  // To simplify here we added all commands as most of them have isEnabled
-  const skip = [CommandIDs.createNew, CommandIDs.createOutputView];
-  const notify = () => {
-    Object.values(CommandIDs)
-      .filter(id => !skip.includes(id) && app.commands.hasCommand(id))
-      .forEach(id => app.commands.notifyCommandChanged(id));
-  };
-  tracker.currentChanged.connect(notify);
-  shell.currentChanged?.connect(notify);
 }
 
 /**
@@ -3607,9 +2536,7 @@
     CommandIDs.trust,
     CommandIDs.toggleCollapseCmd,
     CommandIDs.collapseAllCmd,
-    CommandIDs.expandAllCmd,
-    CommandIDs.accessPreviousHistory,
-    CommandIDs.accessNextHistory
+    CommandIDs.expandAllCmd
   ].forEach(command => {
     palette.addItem({ command, category });
   });
@@ -3644,10 +2571,6 @@
     CommandIDs.insertBelow,
     CommandIDs.selectAbove,
     CommandIDs.selectBelow,
-    CommandIDs.selectHeadingAboveOrCollapse,
-    CommandIDs.selectHeadingBelowOrExpand,
-    CommandIDs.insertHeadingAbove,
-    CommandIDs.insertHeadingBelow,
     CommandIDs.extendAbove,
     CommandIDs.extendTop,
     CommandIDs.extendBelow,
@@ -3682,87 +2605,165 @@
 /**
  * Populates the application menus for the notebook.
  */
-function populateMenus(mainMenu: IMainMenu, isEnabled: () => boolean): void {
+function populateMenus(
+  app: JupyterFrontEnd,
+  mainMenu: IMainMenu,
+  tracker: INotebookTracker,
+  translator: ITranslator,
+  sessionDialogs: ISessionContextDialogs | null
+): void {
+  const trans = translator.load('jupyterlab');
+  const { commands } = app;
+  sessionDialogs = sessionDialogs || sessionContextDialogs;
+
   // Add undo/redo hooks to the edit menu.
-  mainMenu.editMenu.undoers.redo.add({
-    id: CommandIDs.redo,
-    isEnabled
-  });
-  mainMenu.editMenu.undoers.undo.add({
-    id: CommandIDs.undo,
-    isEnabled
-  });
+  mainMenu.editMenu.undoers.add({
+    tracker,
+    undo: widget => {
+      widget.content.activeCell?.editor.undo();
+    },
+    redo: widget => {
+      widget.content.activeCell?.editor.redo();
+    }
+  } as IEditMenu.IUndoer<NotebookPanel>);
 
   // Add a clearer to the edit menu
-  mainMenu.editMenu.clearers.clearAll.add({
-    id: CommandIDs.clearAllOutputs,
-    isEnabled
-  });
-  mainMenu.editMenu.clearers.clearCurrent.add({
-    id: CommandIDs.clearOutputs,
-    isEnabled
-  });
+  mainMenu.editMenu.clearers.add({
+    tracker,
+    clearCurrentLabel: (n: number) => trans.__('Clear Output'),
+    clearAllLabel: (n: number) => {
+      return trans.__('Clear All Outputs');
+    },
+    clearCurrent: (current: NotebookPanel) => {
+      return NotebookActions.clearOutputs(current.content);
+    },
+    clearAll: (current: NotebookPanel) => {
+      return NotebookActions.clearAllOutputs(current.content);
+    }
+  } as IEditMenu.IClearer<NotebookPanel>);
+
+  // Add a close and shutdown command to the file menu.
+  mainMenu.fileMenu.closeAndCleaners.add({
+    tracker,
+    closeAndCleanupLabel: (n: number) =>
+      trans.__('Close and Shutdown Notebook'),
+    closeAndCleanup: (current: NotebookPanel) => {
+      const fileName = current.title.label;
+      return showDialog({
+        title: trans.__('Shut down the Notebook?'),
+        body: trans.__('Are you sure you want to close "%1"?', fileName),
+        buttons: [Dialog.cancelButton(), Dialog.warnButton()]
+      }).then(result => {
+        if (result.button.accept) {
+          return current.context.sessionContext.shutdown().then(() => {
+            current.dispose();
+          });
+        }
+      });
+    }
+  } as IFileMenu.ICloseAndCleaner<NotebookPanel>);
+
+  // Add a kernel user to the Kernel menu
+  mainMenu.kernelMenu.kernelUsers.add({
+    tracker,
+    interruptKernel: current => {
+      const kernel = current.sessionContext.session?.kernel;
+      if (kernel) {
+        return kernel.interrupt();
+      }
+      return Promise.resolve(void 0);
+    },
+    reconnectToKernel: current => {
+      const kernel = current.sessionContext.session?.kernel;
+      if (kernel) {
+        return kernel.reconnect();
+      }
+      return Promise.resolve(void 0);
+    },
+    restartKernelAndClearLabel: (n: number) =>
+      trans.__('Restart Kernel and Clear All Outputs'),
+    restartKernel: current =>
+      sessionDialogs!.restart(current.sessionContext, translator),
+    restartKernelAndClear: current => {
+      return sessionDialogs!
+        .restart(current.sessionContext, translator)
+        .then(restarted => {
+          if (restarted) {
+            NotebookActions.clearAllOutputs(current.content);
+          }
+          return restarted;
+        });
+    },
+    changeKernel: current =>
+      sessionDialogs!.selectKernel(current.sessionContext, translator),
+    shutdownKernel: current => current.sessionContext.shutdown()
+  } as IKernelMenu.IKernelUser<NotebookPanel>);
 
   // Add a console creator the the Kernel menu
   mainMenu.fileMenu.consoleCreators.add({
-    id: CommandIDs.createConsole,
-    isEnabled
-  });
-
-  // Add a close and shutdown command to the file menu.
-  mainMenu.fileMenu.closeAndCleaners.add({
-    id: CommandIDs.closeAndShutdown,
-    isEnabled
-  });
-
-  // Add a kernel user to the Kernel menu
-  mainMenu.kernelMenu.kernelUsers.changeKernel.add({
-    id: CommandIDs.changeKernel,
-    isEnabled
-  });
-  mainMenu.kernelMenu.kernelUsers.clearWidget.add({
-    id: CommandIDs.clearAllOutputs,
-    isEnabled
-  });
-  mainMenu.kernelMenu.kernelUsers.interruptKernel.add({
-    id: CommandIDs.interrupt,
-    isEnabled
-  });
-  mainMenu.kernelMenu.kernelUsers.reconnectToKernel.add({
-    id: CommandIDs.reconnectToKernel,
-    isEnabled
-  });
-  mainMenu.kernelMenu.kernelUsers.restartKernel.add({
-    id: CommandIDs.restart,
-    isEnabled
-  });
-  mainMenu.kernelMenu.kernelUsers.shutdownKernel.add({
-    id: CommandIDs.shutdown,
-    isEnabled
-  });
+    tracker,
+    createConsoleLabel: (n: number) => trans.__('New Console for Notebook'),
+    createConsole: current => Private.createConsole(commands, current, true)
+  } as IFileMenu.IConsoleCreator<NotebookPanel>);
 
   // Add an IEditorViewer to the application view menu
-  mainMenu.viewMenu.editorViewers.toggleLineNumbers.add({
-    id: CommandIDs.toggleAllLines,
-    isEnabled
-  });
+  mainMenu.viewMenu.editorViewers.add({
+    tracker,
+    toggleLineNumbers: widget => {
+      NotebookActions.toggleAllLineNumbers(widget.content);
+    },
+    lineNumbersToggled: widget => {
+      const config = widget.content.editorConfig;
+      return !!(
+        config.code.lineNumbers &&
+        config.markdown.lineNumbers &&
+        config.raw.lineNumbers
+      );
+    }
+  } as IViewMenu.IEditorViewer<NotebookPanel>);
 
   // Add an ICodeRunner to the application run menu
-  mainMenu.runMenu.codeRunners.restart.add({
-    id: CommandIDs.restart,
-    isEnabled
-  });
-  mainMenu.runMenu.codeRunners.run.add({
-    id: CommandIDs.runAndAdvance,
-    isEnabled
-  });
-  mainMenu.runMenu.codeRunners.runAll.add({ id: CommandIDs.runAll, isEnabled });
+  mainMenu.runMenu.codeRunners.add({
+    tracker,
+    runLabel: (n: number) => trans.__('Run Selected Cells'),
+    runCaption: (n: number) => trans.__('Run the selected cells and advance'),
+    runAllLabel: (n: number) => trans.__('Run All Cells'),
+    runAllCaption: (n: number) => trans.__('Run the all notebook cells'),
+    restartAndRunAllLabel: (n: number) =>
+      trans.__('Restart Kernel and Run All Cells'),
+    restartAndRunAllCaption: (n: number) =>
+      trans.__('Restart the kernel, then re-run the whole notebook'),
+    run: current => {
+      const { context, content } = current;
+      return NotebookActions.runAndAdvance(
+        content,
+        context.sessionContext
+      ).then(() => void 0);
+    },
+    runAll: current => {
+      const { context, content } = current;
+      return NotebookActions.runAll(content, context.sessionContext).then(
+        () => void 0
+      );
+    },
+    restartAndRunAll: current => {
+      const { context, content } = current;
+      return sessionDialogs!
+        .restart(context.sessionContext, translator)
+        .then(restarted => {
+          if (restarted) {
+            void NotebookActions.runAll(content, context.sessionContext);
+          }
+          return restarted;
+        });
+    }
+  } as IRunMenu.ICodeRunner<NotebookPanel>);
 
   // Add kernel information to the application help menu.
-  mainMenu.helpMenu.getKernel.add({
-    id: CommandIDs.getKernel,
-    isEnabled
-  });
+  mainMenu.helpMenu.kernelUsers.add({
+    tracker,
+    getKernel: current => current.sessionContext.session?.kernel
+  } as IHelpMenu.IKernelUser<NotebookPanel>);
 }
 
 /**
@@ -3786,8 +2787,7 @@
       preferredLanguage: widget.context.model.defaultKernelLanguage,
       activate: activate,
       ref: widget.id,
-      insertMode: 'split-bottom',
-      type: 'Linked Console'
+      insertMode: 'split-bottom'
     };
 
     return commands.execute('console:create', options);
@@ -3856,7 +2856,9 @@
   /**
    * The default Export To ... formats and their human readable labels.
    */
-  export function getFormatLabels(translator: ITranslator): {
+  export function getFormatLabels(
+    translator: ITranslator
+  ): {
     [k: string]: string;
   } {
     translator = translator || nullTranslator;
@@ -3870,42 +2872,6 @@
       script: trans.__('Executable Script'),
       slides: trans.__('Reveal.js Slides')
     };
-  }
-
-  /**
-   * Raises a silent notification that is read by screen readers
-   *
-   * FIXME: Once a notificatiom API is introduced (https://github.com/jupyterlab/jupyterlab/issues/689),
-   * this can be refactored to use the same.
-   *
-   * More discussion at https://github.com/jupyterlab/jupyterlab/pull/9031#issuecomment-773541469
-   *
-   *
-   * @param message Message to be relayed to screen readers
-   * @param notebookNode DOM node to which the notification container is attached
-   */
-  export function raiseSilentNotification(
-    message: string,
-    notebookNode: HTMLElement
-  ): void {
-    const hiddenAlertContainerId = `sr-message-container-${notebookNode.id}`;
-
-    const hiddenAlertContainer =
-      document.getElementById(hiddenAlertContainerId) ||
-      document.createElement('div');
-
-    // If the container is not available, append the newly created container
-    // to the current notebook panel and set related properties
-    if (hiddenAlertContainer.getAttribute('id') !== hiddenAlertContainerId) {
-      hiddenAlertContainer.classList.add('sr-only');
-      hiddenAlertContainer.setAttribute('id', hiddenAlertContainerId);
-      hiddenAlertContainer.setAttribute('role', 'alert');
-      hiddenAlertContainer.hidden = true;
-      notebookNode.appendChild(hiddenAlertContainer);
-    }
-
-    // Insert/Update alert container with the notification message
-    hiddenAlertContainer.innerText = message;
   }
 
   /**