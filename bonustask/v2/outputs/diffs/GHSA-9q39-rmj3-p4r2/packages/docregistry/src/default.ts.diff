--- packages\docregistry\src\default.ts (old)
+++ packages\docregistry\src\default.ts (new)
@@ -3,33 +3,39 @@
 
 import { MainAreaWidget, setToolbar } from '@jupyterlab/apputils';
 import { CodeEditor } from '@jupyterlab/codeeditor';
+import { Mode } from '@jupyterlab/codemirror';
 import { IChangedArgs, PathExt } from '@jupyterlab/coreutils';
-import { IObservableList } from '@jupyterlab/observables';
+import { IModelDB, IObservableList } from '@jupyterlab/observables';
 import { Contents } from '@jupyterlab/services';
-import { DocumentChange, FileChange, ISharedFile } from '@jupyter/ydoc';
+import * as models from '@jupyterlab/shared-models';
 import { ITranslator, nullTranslator } from '@jupyterlab/translation';
 import { PartialJSONValue } from '@lumino/coreutils';
 import { ISignal, Signal } from '@lumino/signaling';
 import { Title, Widget } from '@lumino/widgets';
 import { DocumentRegistry, IDocumentWidget } from './index';
-import { createReadonlyLabel } from './components';
 
 /**
  * The default implementation of a document model.
  */
 export class DocumentModel
   extends CodeEditor.Model
-  implements DocumentRegistry.ICodeModel
-{
+  implements DocumentRegistry.ICodeModel {
   /**
    * Construct a new document model.
    */
-  constructor(options: DocumentRegistry.IModelOptions<ISharedFile> = {}) {
-    super({ sharedModel: options.sharedModel });
-    this._defaultLang = options.languagePreference ?? '';
-    this._collaborationEnabled = !!options.collaborationEnabled;
+  constructor(
+    languagePreference?: string,
+    modelDB?: IModelDB,
+    collaborationEnabled?: boolean
+  ) {
+    super({ modelDB });
+    this._defaultLang = languagePreference || '';
+    const filemodel = new models.YFile() as models.ISharedFile;
+    this.switchSharedModel(filemodel, true);
+    this.value.changed.connect(this.triggerContentChange, this);
 
     this.sharedModel.changed.connect(this._onStateChanged, this);
+    this._collaborationEnabled = !!collaborationEnabled;
   }
 
   /**
@@ -111,7 +117,7 @@
    * Serialize the model to a string.
    */
   toString(): string {
-    return this.sharedModel.getSource();
+    return this.value.text;
   }
 
   /**
@@ -121,14 +127,14 @@
    * Should emit a [contentChanged] signal.
    */
   fromString(value: string): void {
-    this.sharedModel.setSource(value);
+    this.value.text = value;
   }
 
   /**
    * Serialize the model to JSON.
    */
   toJSON(): PartialJSONValue {
-    return JSON.parse(this.sharedModel.getSource() || 'null');
+    return JSON.parse(this.value.text || 'null');
   }
 
   /**
@@ -163,8 +169,11 @@
     this.dirty = true;
   }
 
-  private _onStateChanged(sender: ISharedFile, changes: DocumentChange): void {
-    if ((changes as FileChange).sourceChange) {
+  private _onStateChanged(
+    sender: models.ISharedFile,
+    changes: models.DocumentChange
+  ): void {
+    if ((changes as models.FileChange).sourceChange) {
       this.triggerContentChange();
     }
     if (changes.stateChange) {
@@ -188,7 +197,7 @@
   /**
    * The shared notebook model.
    */
-  readonly sharedModel: ISharedFile;
+  readonly sharedModel: models.ISharedFile;
   private _defaultLang = '';
   private _dirty = false;
   private _readOnly = false;
@@ -261,25 +270,29 @@
   /**
    * Create a new model.
    *
-   * @param options - Model options.
+   * @param languagePreference - An optional kernel language preference.
+   * @param modelDB - An optional model storage.
+   * @param isInitialized - Whether the model is initialized or not.
+   * @param collaborationEnabled - Whether collaboration is enabled at the application level or not (default `false`).
    *
    * @returns A new document model.
    */
   createNew(
-    options: DocumentRegistry.IModelOptions<ISharedFile> = {}
+    languagePreference?: string,
+    modelDB?: IModelDB,
+    isInitialized?: boolean,
+    collaborationEnabled?: boolean
   ): DocumentRegistry.ICodeModel {
-    const collaborative = options.collaborationEnabled && this.collaborative;
-    return new DocumentModel({
-      ...options,
-      collaborationEnabled: collaborative
-    });
+    const collaborative = collaborationEnabled && this.collaborative;
+    return new DocumentModel(languagePreference, modelDB, collaborative);
   }
 
   /**
    * Get the preferred kernel language given a file path.
    */
   preferredLanguage(path: string): string {
-    return '';
+    const mode = Mode.findByFileName(path);
+    return mode && mode.mode;
   }
 
   private _isDisposed = false;
@@ -326,15 +339,13 @@
 export abstract class ABCWidgetFactory<
   T extends IDocumentWidget,
   U extends DocumentRegistry.IModel = DocumentRegistry.IModel
-> implements DocumentRegistry.IWidgetFactory<T, U>
-{
+> implements DocumentRegistry.IWidgetFactory<T, U> {
   /**
    * Construct a new `ABCWidgetFactory`.
    */
   constructor(options: DocumentRegistry.IWidgetFactoryOptions<T>) {
     this._translator = options.translator || nullTranslator;
     this._name = options.name;
-    this._label = options.label || options.name;
     this._readOnly = options.readOnly === undefined ? false : options.readOnly;
     this._defaultFor = options.defaultFor ? options.defaultFor.slice() : [];
     this._defaultRendered = (options.defaultRendered || []).slice();
@@ -343,7 +354,6 @@
     this._preferKernel = !!options.preferKernel;
     this._canStartKernel = !!options.canStartKernel;
     this._shutdownOnClose = !!options.shutdownOnClose;
-    this._autoStartDefault = !!options.autoStartDefault;
     this._toolbarFactory = options.toolbarFactory;
   }
 
@@ -381,21 +391,13 @@
   }
 
   /**
-   * A unique name identifying of the widget.
+   * The name of the widget to display in dialogs.
    */
   get name(): string {
     return this._name;
   }
 
   /**
-   * The label of the widget to display in dialogs.
-   * If not given, name is used instead.
-   */
-  get label(): string {
-    return this._label;
-  }
-
-  /**
    * The file types the widget can view.
    */
   get fileTypes(): string[] {
@@ -453,16 +455,6 @@
   }
   set shutdownOnClose(value: boolean) {
     this._shutdownOnClose = value;
-  }
-
-  /**
-   * Whether to automatically select the preferred kernel during a kernel start
-   */
-  get autoStartDefault(): boolean {
-    return this._autoStartDefault;
-  }
-  set autoStartDefault(value: boolean) {
-    this._autoStartDefault = value;
   }
 
   /**
@@ -512,8 +504,6 @@
   private _isDisposed = false;
   private _translator: ITranslator;
   private _name: string;
-  private _label: string;
-  private _autoStartDefault: boolean;
   private _readOnly: boolean;
   private _canStartKernel: boolean;
   private _shutdownOnClose: boolean;
@@ -540,13 +530,12 @@
     U extends DocumentRegistry.IModel = DocumentRegistry.IModel
   >
   extends MainAreaWidget<T>
-  implements IDocumentWidget<T, U>
-{
+  implements IDocumentWidget<T, U> {
   constructor(options: DocumentWidget.IOptions<T, U>) {
     // Include the context ready promise in the widget reveal promise
     options.reveal = Promise.all([options.reveal, options.context.ready]);
     super(options);
-    this._trans = (options.translator ?? nullTranslator).load('jupyterlab');
+
     this.context = options.context;
 
     // Handle context path changes
@@ -576,9 +565,7 @@
   private async _onTitleChanged(_sender: Title<this>) {
     const validNameExp = /[\/\\:]/;
     const name = this.title.label;
-    // Use localPath to avoid the drive name
-    const filename =
-      this.context.localPath.split('/').pop() || this.context.localPath;
+    const filename = this.context.path.split('/').pop()!;
 
     if (name === filename) {
       return;
@@ -616,21 +603,6 @@
   ): void {
     if (args.name === 'dirty') {
       this._handleDirtyState();
-    }
-    if (!this.context.model.dirty) {
-      if (!this.context.model.collaborative) {
-        if (!this.context.contentsModel?.writable) {
-          const readOnlyIndicator = createReadonlyLabel(this);
-          let roi = this.toolbar.insertBefore(
-            'kernelName',
-            'read-only-indicator',
-            readOnlyIndicator
-          );
-          if (!roi) {
-            this.toolbar.addItem('read-only-indicator', readOnlyIndicator);
-          }
-        }
-      }
     }
   }
 
@@ -649,7 +621,6 @@
   }
 
   readonly context: DocumentRegistry.IContext<U>;
-  protected readonly _trans;
 
   /**
    * Whether the document has an auto-generated name or not.