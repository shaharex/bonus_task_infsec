--- packages\toc-extension\src\index.ts (old)
+++ packages\toc-extension\src\index.ts (new)
@@ -11,41 +11,32 @@
   JupyterFrontEnd,
   JupyterFrontEndPlugin
 } from '@jupyterlab/application';
+import { IDocumentManager } from '@jupyterlab/docmanager';
+import { IEditorTracker } from '@jupyterlab/fileeditor';
+import { IMarkdownViewerTracker } from '@jupyterlab/markdownviewer';
+import { INotebookTracker } from '@jupyterlab/notebook';
+import { IRenderMimeRegistry } from '@jupyterlab/rendermime';
 import { ISettingRegistry } from '@jupyterlab/settingregistry';
 import {
+  createLatexGenerator,
+  createMarkdownGenerator,
+  createNotebookGenerator,
+  createPythonGenerator,
+  createRenderedMarkdownGenerator,
   ITableOfContentsRegistry,
-  ITableOfContentsTracker,
-  TableOfContents,
-  TableOfContentsPanel,
-  TableOfContentsRegistry,
-  TableOfContentsTracker
+  TableOfContentsRegistry as Registry,
+  TableOfContents
 } from '@jupyterlab/toc';
-import { ITranslator, nullTranslator } from '@jupyterlab/translation';
-import {
-  collapseAllIcon,
-  CommandToolbarButton,
-  ellipsesIcon,
-  expandAllIcon,
-  MenuSvg,
-  numberingIcon,
-  tocIcon,
-  Toolbar,
-  ToolbarButton
-} from '@jupyterlab/ui-components';
-
-/**
- * A namespace for command IDs of table of contents plugin.
+import { ITranslator } from '@jupyterlab/translation';
+import { tocIcon } from '@jupyterlab/ui-components';
+import { INotebookHeading } from '@jupyterlab/toc';
+import { CodeCell, MarkdownCell } from '@jupyterlab/cells';
+
+/**
+ * The command IDs used by TOC item.
  */
 namespace CommandIDs {
-  export const displayNumbering = 'toc:display-numbering';
-
-  export const displayH1Numbering = 'toc:display-h1-numbering';
-
-  export const displayOutputNumbering = 'toc:display-outputs-numbering';
-
-  export const showPanel = 'toc:show-panel';
-
-  export const toggleCollapse = 'toc:toggle-collapse';
+  export const runCells = 'toc:run-cells';
 }
 
 /**
@@ -53,111 +44,90 @@
  *
  * @private
  * @param app - Jupyter application
- * @param tocRegistry - Table of contents registry
+ * @param docmanager - document manager
+ * @param rendermime - rendered MIME registry
  * @param translator - translator
+ * @param editorTracker - editor tracker
  * @param restorer - application layout restorer
  * @param labShell - Jupyter lab shell
+ * @param markdownViewerTracker - Markdown viewer tracker
+ * @param notebookTracker - notebook tracker
  * @param settingRegistry - setting registry
  * @returns table of contents registry
  */
 async function activateTOC(
   app: JupyterFrontEnd,
-  tocRegistry: ITableOfContentsRegistry,
-  translator?: ITranslator | null,
-  restorer?: ILayoutRestorer | null,
-  labShell?: ILabShell | null,
-  settingRegistry?: ISettingRegistry | null
-): Promise<ITableOfContentsTracker> {
-  const trans = (translator ?? nullTranslator).load('jupyterlab');
-  let configuration = { ...TableOfContents.defaultConfig };
-
+  docmanager: IDocumentManager,
+  rendermime: IRenderMimeRegistry,
+  translator: ITranslator,
+  editorTracker?: IEditorTracker,
+  restorer?: ILayoutRestorer,
+  labShell?: ILabShell,
+  markdownViewerTracker?: IMarkdownViewerTracker,
+  notebookTracker?: INotebookTracker,
+  settingRegistry?: ISettingRegistry
+): Promise<ITableOfContentsRegistry> {
+  const trans = translator.load('jupyterlab');
   // Create the ToC widget:
-  const toc = new TableOfContentsPanel(translator ?? undefined);
+  const toc = new TableOfContents({
+    docmanager,
+    rendermime,
+    translator
+  });
+
+  // Create the ToC registry:
+  const registry = new Registry();
+
+  // Add the ToC to the left area:
   toc.title.icon = tocIcon;
   toc.title.caption = trans.__('Table of Contents');
   toc.id = 'table-of-contents';
   toc.node.setAttribute('role', 'region');
   toc.node.setAttribute('aria-label', trans.__('Table of Contents section'));
 
-  app.commands.addCommand(CommandIDs.displayH1Numbering, {
-    label: trans.__('Show first-level heading number'),
-    execute: () => {
-      if (toc.model) {
-        toc.model.setConfiguration({
-          numberingH1: !toc.model.configuration.numberingH1
-        });
+  app.shell.add(toc, 'left', { rank: 400 });
+
+  app.commands.addCommand(CommandIDs.runCells, {
+    execute: args => {
+      if (!notebookTracker) {
+        return null;
+      }
+
+      const panel = notebookTracker.currentWidget;
+      if (panel == null) {
+        return;
+      }
+
+      const cells = panel.content.widgets;
+      if (cells === undefined) {
+        return;
+      }
+
+      const activeCell = (toc.activeEntry as INotebookHeading).cellRef;
+
+      if (activeCell instanceof MarkdownCell) {
+        let level = activeCell.headingInfo.level;
+        for (let i = cells.indexOf(activeCell) + 1; i < cells.length; i++) {
+          const cell = cells[i];
+          if (
+            cell instanceof MarkdownCell &&
+            cell.headingInfo.level <= level &&
+            cell.headingInfo.level > -1
+          ) {
+            break;
+          }
+          if (cell instanceof CodeCell) {
+            void CodeCell.execute(cell, panel.sessionContext);
+          }
+        }
+      } else {
+        if (activeCell instanceof CodeCell) {
+          void CodeCell.execute(activeCell, panel.sessionContext);
+        }
       }
     },
-    isEnabled: () =>
-      toc.model?.supportedOptions.includes('numberingH1') ?? false,
-    isToggled: () => toc.model?.configuration.numberingH1 ?? false
+    label: trans.__('Run Cell(s)')
   });
-
-  app.commands.addCommand(CommandIDs.displayNumbering, {
-    label: trans.__('Show heading number in the document'),
-    icon: args => (args.toolbar ? numberingIcon : undefined),
-    execute: () => {
-      if (toc.model) {
-        toc.model.setConfiguration({
-          numberHeaders: !toc.model.configuration.numberHeaders
-        });
-        app.commands.notifyCommandChanged(CommandIDs.displayNumbering);
-      }
-    },
-    isEnabled: () =>
-      toc.model?.supportedOptions.includes('numberHeaders') ?? false,
-    isToggled: () => toc.model?.configuration.numberHeaders ?? false
-  });
-
-  app.commands.addCommand(CommandIDs.displayOutputNumbering, {
-    label: trans.__('Show output headings'),
-    execute: () => {
-      if (toc.model) {
-        toc.model.setConfiguration({
-          includeOutput: !toc.model.configuration.includeOutput
-        });
-      }
-    },
-    isEnabled: () =>
-      toc.model?.supportedOptions.includes('includeOutput') ?? false,
-    isToggled: () => toc.model?.configuration.includeOutput ?? false
-  });
-
-  app.commands.addCommand(CommandIDs.showPanel, {
-    label: trans.__('Table of Contents'),
-    execute: () => {
-      app.shell.activateById(toc.id);
-    }
-  });
-
-  function someExpanded(model: TableOfContents.Model): boolean {
-    return model.headings.some(h => !(h.collapsed ?? false));
-  }
-
-  app.commands.addCommand(CommandIDs.toggleCollapse, {
-    label: () =>
-      toc.model && !someExpanded(toc.model)
-        ? trans.__('Expand All Headings')
-        : trans.__('Collapse All Headings'),
-    icon: args =>
-      args.toolbar
-        ? toc.model && !someExpanded(toc.model)
-          ? expandAllIcon
-          : collapseAllIcon
-        : undefined,
-    execute: () => {
-      if (toc.model) {
-        if (someExpanded(toc.model)) {
-          toc.model.toggleCollapse({ collapsed: true });
-        } else {
-          toc.model.toggleCollapse({ collapsed: false });
-        }
-      }
-    },
-    isEnabled: () => toc.model !== null
-  });
-
-  const tracker = new TableOfContentsTracker();
 
   if (restorer) {
     // Add the ToC widget to the application restorer:
@@ -168,36 +138,7 @@
   let settings: ISettingRegistry.ISettings | undefined;
   if (settingRegistry) {
     try {
-      settings = await settingRegistry.load(registry.id);
-      const updateSettings = (plugin: ISettingRegistry.ISettings) => {
-        const composite = plugin.composite;
-        for (const key of [...Object.keys(configuration)]) {
-          const value = composite[key] as any;
-          if (value !== undefined) {
-            configuration[key] = value;
-          }
-        }
-
-        if (labShell) {
-          for (const widget of labShell.widgets('main')) {
-            const model = tracker.get(widget);
-            if (model) {
-              model.setConfiguration(configuration);
-            }
-          }
-        } else {
-          if (app.shell.currentWidget) {
-            const model = tracker.get(app.shell.currentWidget);
-            if (model) {
-              model.setConfiguration(configuration);
-            }
-          }
-        }
-      };
-      if (settings) {
-        settings.changed.connect(updateSettings);
-        updateSettings(settings);
-      }
+      settings = await settingRegistry.load('@jupyterlab/toc-extension:plugin');
     } catch (error) {
       console.error(
         `Failed to load settings for the Table of Contents extension.\n\n${error}`
@@ -205,64 +146,56 @@
     }
   }
 
-  // Set up the panel toolbar
-  const numbering = new CommandToolbarButton({
-    commands: app.commands,
-    id: CommandIDs.displayNumbering,
-    args: {
-      toolbar: true
-    },
-    label: ''
-  });
-  numbering.addClass('jp-toc-numberingButton');
-  toc.toolbar.addItem('display-numbering', numbering);
-
-  toc.toolbar.addItem('spacer', Toolbar.createSpacerItem());
-
-  toc.toolbar.addItem(
-    'collapse-all',
-    new CommandToolbarButton({
-      commands: app.commands,
-      id: CommandIDs.toggleCollapse,
-      args: {
-        toolbar: true
-      },
-      label: ''
-    })
-  );
-
-  const toolbarMenu = new MenuSvg({ commands: app.commands });
-  toolbarMenu.addItem({
-    command: CommandIDs.displayH1Numbering
-  });
-  toolbarMenu.addItem({
-    command: CommandIDs.displayOutputNumbering
-  });
-  const menuButton = new ToolbarButton({
-    tooltip: trans.__('More actionsâ€¦'),
-    icon: ellipsesIcon,
-    actualOnClick: true,
-    onClick: () => {
-      const bbox = menuButton.node.getBoundingClientRect();
-      toolbarMenu.open(bbox.x, bbox.bottom);
-    }
-  });
-  toc.toolbar.addItem('submenu', menuButton);
-
-  // Add the ToC to the left area:
-  app.shell.add(toc, 'left', { rank: 400, type: 'Table of Contents' });
+  // Create a notebook generator:
+  if (notebookTracker) {
+    const notebookGenerator = createNotebookGenerator(
+      notebookTracker,
+      toc,
+      rendermime.sanitizer,
+      translator,
+      settings
+    );
+    registry.add(notebookGenerator);
+  }
+
+  // Create a Markdown generator:
+  if (editorTracker) {
+    const markdownGenerator = createMarkdownGenerator(
+      editorTracker,
+      toc,
+      rendermime.sanitizer,
+      translator,
+      settings
+    );
+    registry.add(markdownGenerator);
+
+    // Create a LaTeX generator:
+    const latexGenerator = createLatexGenerator(editorTracker);
+    registry.add(latexGenerator);
+
+    // Create a Python generator:
+    const pythonGenerator = createPythonGenerator(editorTracker);
+    registry.add(pythonGenerator);
+  }
+
+  // Create a rendered Markdown generator:
+  if (markdownViewerTracker) {
+    const renderedMarkdownGenerator = createRenderedMarkdownGenerator(
+      markdownViewerTracker,
+      toc,
+      rendermime.sanitizer,
+      translator,
+      settings
+    );
+    registry.add(renderedMarkdownGenerator);
+  }
 
   // Update the ToC when the active widget changes:
   if (labShell) {
     labShell.currentChanged.connect(onConnect);
   }
 
-  // Connect to current widget
-  void app.restored.then(() => {
-    onConnect();
-  });
-
-  return tracker;
+  return registry;
 
   /**
    * Callback invoked when the active widget changes.
@@ -274,69 +207,41 @@
     if (!widget) {
       return;
     }
-    let model = tracker.get(widget);
-    if (!model) {
-      model = tocRegistry.getModel(widget, configuration) ?? null;
-      if (model) {
-        tracker.add(widget, model);
-      }
-
-      widget.disposed.connect(() => {
-        model?.dispose();
-      });
+    let generator = registry.find(widget);
+    if (!generator) {
+      // If the previously used widget is still available, stick with it.
+      // Otherwise, set the current ToC widget to null.
+      if (toc.current && toc.current.widget.isDisposed) {
+        toc.current = null;
+      }
+      return;
     }
-
-    if (toc.model) {
-      toc.model.headingsChanged.disconnect(onCollapseChange);
-      toc.model.collapseChanged.disconnect(onCollapseChange);
-    }
-
-    toc.model = model;
-    if (toc.model) {
-      toc.model.headingsChanged.connect(onCollapseChange);
-      toc.model.collapseChanged.connect(onCollapseChange);
-    }
-    setToolbarButtonsState();
-  }
-
-  function setToolbarButtonsState() {
-    app.commands.notifyCommandChanged(CommandIDs.displayNumbering);
-    app.commands.notifyCommandChanged(CommandIDs.toggleCollapse);
-  }
-
-  function onCollapseChange() {
-    app.commands.notifyCommandChanged(CommandIDs.toggleCollapse);
+    toc.current = { widget, generator };
   }
 }
 
 /**
- * Table of contents registry plugin.
- */
-const registry: JupyterFrontEndPlugin<ITableOfContentsRegistry> = {
-  id: '@jupyterlab/toc-extension:registry',
-  description: 'Provides the table of contents registry.',
+ * Initialization data for the ToC extension.
+ *
+ * @private
+ */
+const extension: JupyterFrontEndPlugin<ITableOfContentsRegistry> = {
+  id: '@jupyterlab/toc:plugin',
   autoStart: true,
   provides: ITableOfContentsRegistry,
-  activate: (): ITableOfContentsRegistry => {
-    // Create the ToC registry
-    return new TableOfContentsRegistry();
-  }
-};
-
-/**
- * Table of contents tracker plugin.
- */
-const tracker: JupyterFrontEndPlugin<ITableOfContentsTracker> = {
-  id: '@jupyterlab/toc-extension:tracker',
-  description: 'Adds the table of content widget and provides its tracker.',
-  autoStart: true,
-  provides: ITableOfContentsTracker,
-  requires: [ITableOfContentsRegistry],
-  optional: [ITranslator, ILayoutRestorer, ILabShell, ISettingRegistry],
+  requires: [IDocumentManager, IRenderMimeRegistry, ITranslator],
+  optional: [
+    IEditorTracker,
+    ILayoutRestorer,
+    ILabShell,
+    IMarkdownViewerTracker,
+    INotebookTracker,
+    ISettingRegistry
+  ],
   activate: activateTOC
 };
 
 /**
  * Exports.
  */
-export default [registry, tracker];
+export default extension;