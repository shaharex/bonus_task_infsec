--- packages\console-extension\src\index.ts (old)
+++ packages\console-extension\src\index.ts (new)
@@ -14,38 +14,28 @@
 import {
   Dialog,
   ICommandPalette,
-  IKernelStatusModel,
-  ISanitizer,
   ISessionContext,
   ISessionContextDialogs,
-  Sanitizer,
-  SessionContextDialogs,
+  sessionContextDialogs,
   showDialog,
   WidgetTracker
 } from '@jupyterlab/apputils';
+import { CodeEditor, IEditorServices } from '@jupyterlab/codeeditor';
+import { ConsolePanel, IConsoleTracker } from '@jupyterlab/console';
+import { IFileBrowserFactory } from '@jupyterlab/filebrowser';
+import { ILauncher } from '@jupyterlab/launcher';
 import {
-  CodeEditor,
-  IEditorServices,
-  IPositionModel
-} from '@jupyterlab/codeeditor';
-import { ICompletionProviderManager } from '@jupyterlab/completer';
-import {
-  ConsolePanel,
-  IConsoleCellExecutor,
-  IConsoleTracker
-} from '@jupyterlab/console';
-import { IDefaultFileBrowser } from '@jupyterlab/filebrowser';
-import { ILauncher } from '@jupyterlab/launcher';
-import { IMainMenu } from '@jupyterlab/mainmenu';
-import { IRenderMime, IRenderMimeRegistry } from '@jupyterlab/rendermime';
+  IEditMenu,
+  IFileMenu,
+  IHelpMenu,
+  IKernelMenu,
+  IMainMenu,
+  IRunMenu
+} from '@jupyterlab/mainmenu';
+import { IRenderMimeRegistry } from '@jupyterlab/rendermime';
 import { ISettingRegistry } from '@jupyterlab/settingregistry';
-import { ITranslator, nullTranslator } from '@jupyterlab/translation';
-import {
-  consoleIcon,
-  IFormRendererRegistry,
-  redoIcon,
-  undoIcon
-} from '@jupyterlab/ui-components';
+import { ITranslator } from '@jupyterlab/translation';
+import { consoleIcon } from '@jupyterlab/ui-components';
 import { find } from '@lumino/algorithm';
 import {
   JSONExt,
@@ -55,9 +45,8 @@
   UUID
 } from '@lumino/coreutils';
 import { DisposableSet } from '@lumino/disposable';
-import { DockLayout, Widget } from '@lumino/widgets';
+import { DockLayout } from '@lumino/widgets';
 import foreign from './foreign';
-import { cellExecutor } from './cellexecutor';
 
 /**
  * The command IDs used by the console plugin.
@@ -87,21 +76,13 @@
 
   export const changeKernel = 'console:change-kernel';
 
-  export const getKernel = 'console:get-kernel';
+  export const enterToExecute = 'console:enter-to-execute';
+
+  export const shiftEnterToExecute = 'console:shift-enter-to-execute';
 
   export const interactionMode = 'console:interaction-mode';
 
-  export const redo = 'console:redo';
-
   export const replaceSelection = 'console:replace-selection';
-
-  export const shutdown = 'console:shutdown';
-
-  export const undo = 'console:undo';
-
-  export const invokeCompleter = 'completer:invoke-console';
-
-  export const selectCompleter = 'completer:select-console';
 }
 
 /**
@@ -109,25 +90,22 @@
  */
 const tracker: JupyterFrontEndPlugin<IConsoleTracker> = {
   id: '@jupyterlab/console-extension:tracker',
-  description: 'Provides the console widget tracker.',
   provides: IConsoleTracker,
   requires: [
     ConsolePanel.IContentFactory,
     IEditorServices,
-    IConsoleCellExecutor,
     IRenderMimeRegistry,
-    ISettingRegistry
+    ISettingRegistry,
+    ITranslator
   ],
   optional: [
     ILayoutRestorer,
-    IDefaultFileBrowser,
+    IFileBrowserFactory,
     IMainMenu,
     ICommandPalette,
     ILauncher,
     ILabStatus,
-    ISessionContextDialogs,
-    IFormRendererRegistry,
-    ITranslator
+    ISessionContextDialogs
   ],
   activate: activateConsole,
   autoStart: true
@@ -138,7 +116,6 @@
  */
 const factory: JupyterFrontEndPlugin<ConsolePanel.IContentFactory> = {
   id: '@jupyterlab/console-extension:factory',
-  description: 'Provides the console widget content factory.',
   provides: ConsolePanel.IContentFactory,
   requires: [IEditorServices],
   autoStart: true,
@@ -149,103 +126,9 @@
 };
 
 /**
- * Kernel status indicator.
- */
-const kernelStatus: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/console-extension:kernel-status',
-  description: 'Adds the console to the kernel status indicator model.',
-  autoStart: true,
-  requires: [IConsoleTracker, IKernelStatusModel],
-  activate: (
-    app: JupyterFrontEnd,
-    tracker: IConsoleTracker,
-    kernelStatus: IKernelStatusModel
-  ) => {
-    const provider = (widget: Widget | null) => {
-      let session: ISessionContext | null = null;
-
-      if (widget && tracker.has(widget)) {
-        return (widget as ConsolePanel).sessionContext;
-      }
-
-      return session;
-    };
-
-    kernelStatus.addSessionProvider(provider);
-  }
-};
-
-/**
- * Cursor position.
- */
-const lineColStatus: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/console-extension:cursor-position',
-  description: 'Adds the console to the code editor cursor position model.',
-  autoStart: true,
-  requires: [IConsoleTracker, IPositionModel],
-  activate: (
-    app: JupyterFrontEnd,
-    tracker: IConsoleTracker,
-    positionModel: IPositionModel
-  ) => {
-    let previousWidget: ConsolePanel | null = null;
-
-    const provider = async (widget: Widget | null) => {
-      let editor: CodeEditor.IEditor | null = null;
-      if (widget !== previousWidget) {
-        previousWidget?.console.promptCellCreated.disconnect(
-          positionModel.update
-        );
-
-        previousWidget = null;
-        if (widget && tracker.has(widget)) {
-          (widget as ConsolePanel).console.promptCellCreated.connect(
-            positionModel.update
-          );
-          const promptCell = (widget as ConsolePanel).console.promptCell;
-          editor = null;
-          if (promptCell) {
-            await promptCell.ready;
-            editor = promptCell.editor;
-          }
-          previousWidget = widget as ConsolePanel;
-        }
-      } else if (widget) {
-        const promptCell = (widget as ConsolePanel).console.promptCell;
-        editor = null;
-        if (promptCell) {
-          await promptCell.ready;
-          editor = promptCell.editor;
-        }
-      }
-      return editor;
-    };
-
-    positionModel.addEditorProvider(provider);
-  }
-};
-
-const completerPlugin: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/console-extension:completer',
-  description: 'Adds completion to the console.',
-  autoStart: true,
-  requires: [IConsoleTracker],
-  optional: [ICompletionProviderManager, ITranslator, ISanitizer],
-  activate: activateConsoleCompleterService
-};
-
-/**
  * Export the plugins as the default.
  */
-const plugins: JupyterFrontEndPlugin<any>[] = [
-  factory,
-  tracker,
-  foreign,
-  kernelStatus,
-  lineColStatus,
-  completerPlugin,
-  cellExecutor
-];
+const plugins: JupyterFrontEndPlugin<any>[] = [factory, tracker, foreign];
 export default plugins;
 
 /**
@@ -255,26 +138,22 @@
   app: JupyterFrontEnd,
   contentFactory: ConsolePanel.IContentFactory,
   editorServices: IEditorServices,
-  executor: IConsoleCellExecutor,
   rendermime: IRenderMimeRegistry,
   settingRegistry: ISettingRegistry,
+  translator: ITranslator,
   restorer: ILayoutRestorer | null,
-  filebrowser: IDefaultFileBrowser | null,
+  browserFactory: IFileBrowserFactory | null,
   mainMenu: IMainMenu | null,
   palette: ICommandPalette | null,
   launcher: ILauncher | null,
   status: ILabStatus | null,
-  sessionDialogs_: ISessionContextDialogs | null,
-  formRegistry: IFormRendererRegistry | null,
-  translator_: ITranslator | null
+  sessionDialogs: ISessionContextDialogs | null
 ): Promise<IConsoleTracker> {
-  const translator = translator_ ?? nullTranslator;
   const trans = translator.load('jupyterlab');
   const manager = app.serviceManager;
   const { commands, shell } = app;
   const category = trans.__('Console');
-  const sessionDialogs =
-    sessionDialogs_ ?? new SessionContextDialogs({ translator });
+  sessionDialogs = sessionDialogs ?? sessionContextDialogs;
 
   // Create a widget tracker for all console panels.
   const tracker = new WidgetTracker<ConsolePanel>({
@@ -361,15 +240,6 @@
      * to the main area relative to a reference widget.
      */
     insertMode?: DockLayout.InsertMode;
-
-    /**
-     * Type of widget to open
-     *
-     * #### Notes
-     * This is the key used to load user layout customization.
-     * Its typical value is: a factory name or the widget id (if singleton)
-     */
-    type?: string;
   }
 
   /**
@@ -383,8 +253,6 @@
       contentFactory,
       mimeTypeService: editorServices.mimeTypeService,
       rendermime,
-      sessionDialogs,
-      executor,
       translator,
       setBusy: (status && (() => status.setBusy())) ?? undefined,
       ...(options as Partial<ConsolePanel.IOptions>)
@@ -408,15 +276,99 @@
     shell.add(panel, 'main', {
       ref: options.ref,
       mode: options.insertMode,
-      activate: options.activate !== false,
-      type: options.type ?? 'Console'
+      activate: options.activate !== false
     });
     return panel;
   }
 
+  type lineWrap_type = 'off' | 'on' | 'wordWrapColumn' | 'bounded';
+
+  const mapOption = (
+    editor: CodeEditor.IEditor,
+    config: JSONObject,
+    option: string
+  ) => {
+    if (config[option] === undefined) {
+      return;
+    }
+    switch (option) {
+      case 'autoClosingBrackets':
+        editor.setOption(
+          'autoClosingBrackets',
+          config['autoClosingBrackets'] as boolean
+        );
+        break;
+      case 'cursorBlinkRate':
+        editor.setOption(
+          'cursorBlinkRate',
+          config['cursorBlinkRate'] as number
+        );
+        break;
+      case 'fontFamily':
+        editor.setOption('fontFamily', config['fontFamily'] as string | null);
+        break;
+      case 'fontSize':
+        editor.setOption('fontSize', config['fontSize'] as number | null);
+        break;
+      case 'lineHeight':
+        editor.setOption('lineHeight', config['lineHeight'] as number | null);
+        break;
+      case 'lineNumbers':
+        editor.setOption('lineNumbers', config['lineNumbers'] as boolean);
+        break;
+      case 'lineWrap':
+        editor.setOption('lineWrap', config['lineWrap'] as lineWrap_type);
+        break;
+      case 'matchBrackets':
+        editor.setOption('matchBrackets', config['matchBrackets'] as boolean);
+        break;
+      case 'readOnly':
+        editor.setOption('readOnly', config['readOnly'] as boolean);
+        break;
+      case 'insertSpaces':
+        editor.setOption('insertSpaces', config['insertSpaces'] as boolean);
+        break;
+      case 'tabSize':
+        editor.setOption('tabSize', config['tabSize'] as number);
+        break;
+      case 'wordWrapColumn':
+        editor.setOption('wordWrapColumn', config['wordWrapColumn'] as number);
+        break;
+      case 'rulers':
+        editor.setOption('rulers', config['rulers'] as number[]);
+        break;
+      case 'codeFolding':
+        editor.setOption('codeFolding', config['codeFolding'] as boolean);
+        break;
+    }
+  };
+
+  const setOption = (
+    editor: CodeEditor.IEditor | undefined,
+    config: JSONObject
+  ) => {
+    if (editor === undefined) {
+      return;
+    }
+    mapOption(editor, config, 'autoClosingBrackets');
+    mapOption(editor, config, 'cursorBlinkRate');
+    mapOption(editor, config, 'fontFamily');
+    mapOption(editor, config, 'fontSize');
+    mapOption(editor, config, 'lineHeight');
+    mapOption(editor, config, 'lineNumbers');
+    mapOption(editor, config, 'lineWrap');
+    mapOption(editor, config, 'matchBrackets');
+    mapOption(editor, config, 'readOnly');
+    mapOption(editor, config, 'insertSpaces');
+    mapOption(editor, config, 'tabSize');
+    mapOption(editor, config, 'wordWrapColumn');
+    mapOption(editor, config, 'rulers');
+    mapOption(editor, config, 'codeFolding');
+  };
+
   const pluginId = '@jupyterlab/console-extension:tracker';
   let interactionMode: string;
-  let promptCellConfig: JSONObject = {};
+  let promptCellConfig: JSONObject;
 
   /**
    * Update settings for one console or all consoles.
@@ -434,7 +386,7 @@
       // Update future promptCells
       widget.console.editorConfig = promptCellConfig;
       // Update promptCell already on screen
-      widget.console.promptCell?.editor?.setOptions(promptCellConfig);
+      setOption(widget.console.promptCell?.editor, promptCellConfig);
     };
 
     if (panel) {
@@ -450,18 +402,6 @@
     }
   });
   await updateSettings();
-
-  if (formRegistry) {
-    const CMRenderer = formRegistry.getRenderer(
-      '@jupyterlab/codemirror-extension:plugin.defaultConfig'
-    );
-    if (CMRenderer) {
-      formRegistry.addRenderer(
-        '@jupyterlab/console-extension:tracker.promptCellConfig',
-        CMRenderer
-      );
-    }
-  }
 
   // Apply settings when a console is created.
   tracker.widgetAdded.connect((sender, panel) => {
@@ -499,8 +439,8 @@
     activate?: boolean;
   }
 
-  commands.addCommand(CommandIDs.open, {
-    label: trans.__('Open a console for the provided `path`.'),
+  let command = CommandIDs.open;
+  commands.addCommand(command, {
     execute: (args: IOpenOptions) => {
       const path = args['path'];
       const widget = tracker.find(value => {
@@ -525,7 +465,8 @@
     }
   });
 
-  commands.addCommand(CommandIDs.create, {
+  command = CommandIDs.create;
+  commands.addCommand(command, {
     label: args => {
       if (args['isPalette']) {
         return trans.__('New Console');
@@ -546,7 +487,7 @@
       const basePath =
         ((args['basePath'] as string) ||
           (args['cwd'] as string) ||
-          filebrowser?.model.path) ??
+          browserFactory?.defaultBrowser.model.path) ??
         '';
       return createConsole({ basePath, ...args });
     }
@@ -562,74 +503,6 @@
     return widget ?? null;
   }
 
-  /**
-   * Add undo command
-   */
-  commands.addCommand(CommandIDs.undo, {
-    execute: args => {
-      const current = getCurrent(args);
-
-      if (!current) {
-        return;
-      }
-
-      const editor = current.console.promptCell?.editor;
-      if (!editor) {
-        return;
-      }
-      editor.undo();
-    },
-    isEnabled: args => {
-      if (!isEnabled()) {
-        return false;
-      }
-
-      const editor = getCurrent(args)?.console?.promptCell?.editor;
-
-      if (!editor) {
-        return false;
-      }
-
-      return editor.model.sharedModel.canUndo();
-    },
-    icon: undoIcon.bindprops({ stylesheet: 'menuItem' }),
-    label: trans.__('Undo')
-  });
-
-  /**
-   * Add redo command
-   */
-  commands.addCommand(CommandIDs.redo, {
-    execute: args => {
-      const current = getCurrent(args);
-
-      if (!current) {
-        return;
-      }
-
-      const editor = current.console.promptCell?.editor;
-      if (!editor) {
-        return;
-      }
-      editor.redo();
-    },
-    isEnabled: args => {
-      if (!isEnabled()) {
-        return false;
-      }
-
-      const editor = getCurrent(args)?.console?.promptCell?.editor;
-
-      if (!editor) {
-        return false;
-      }
-
-      return editor.model.sharedModel.canRedo();
-    },
-    icon: redoIcon.bindprops({ stylesheet: 'menuItem' }),
-    label: trans.__('Redo')
-  });
-
   commands.addCommand(CommandIDs.clear, {
     label: trans.__('Clear Console Cells'),
     execute: args => {
@@ -713,21 +586,12 @@
       if (!current) {
         return;
       }
-      return sessionDialogs.restart(current.console.sessionContext);
-    },
-    isEnabled
-  });
-
-  commands.addCommand(CommandIDs.shutdown, {
-    label: trans.__('Shut Down'),
-    execute: args => {
-      const current = getCurrent(args);
-      if (!current) {
-        return;
-      }
-
-      return current.console.sessionContext.shutdown();
-    }
+      return sessionDialogs!.restart(
+        current.console.sessionContext,
+        translator
+      );
+    },
+    isEnabled
   });
 
   commands.addCommand(CommandIDs.closeAndShutdown, {
@@ -743,22 +607,13 @@
           'Are you sure you want to close "%1"?',
           current.title.label
         ),
-        buttons: [
-          Dialog.cancelButton({
-            ariaLabel: trans.__('Cancel console Shut Down')
-          }),
-          Dialog.warnButton({
-            ariaLabel: trans.__('Confirm console Shut Down')
-          })
-        ]
+        buttons: [Dialog.cancelButton(), Dialog.warnButton()]
       }).then(result => {
         if (result.button.accept) {
-          return commands
-            .execute(CommandIDs.shutdown, { activate: false })
-            .then(() => {
-              current.dispose();
-              return true;
-            });
+          return current.console.sessionContext.shutdown().then(() => {
+            current.dispose();
+            return true;
+          });
         } else {
           return false;
         }
@@ -768,7 +623,6 @@
   });
 
   commands.addCommand(CommandIDs.inject, {
-    label: trans.__('Inject some code in a console.'),
     execute: args => {
       const path = args['path'];
       tracker.find(widget => {
@@ -795,33 +649,13 @@
       if (!current) {
         return;
       }
-      return sessionDialogs.selectKernel(current.console.sessionContext);
-    },
-    isEnabled
-  });
-
-  commands.addCommand(CommandIDs.getKernel, {
-    label: trans.__('Get Kernel'),
-    execute: args => {
-      const current = getCurrent({ activate: false, ...args });
-      if (!current) {
-        return;
-      }
-      return current.sessionContext.session?.kernel;
-    },
-    isEnabled
-  });
-
-  // All commands with isEnabled defined directly or in a semantic commands
-
-  const skip = [CommandIDs.create];
-  const notify = () => {
-    Object.values(CommandIDs)
-      .filter(id => !skip.includes(id))
-      .forEach(id => app.commands.notifyCommandChanged(id));
-  };
-  tracker.currentChanged.connect(notify);
-  shell.currentChanged?.connect(notify);
+      return sessionDialogs!.selectKernel(
+        current.console.sessionContext,
+        translator
+      );
+    },
+    isEnabled
+  });
 
   if (palette) {
     // Add command palette items
@@ -843,59 +677,75 @@
   if (mainMenu) {
     // Add a close and shutdown command to the file menu.
     mainMenu.fileMenu.closeAndCleaners.add({
-      id: CommandIDs.closeAndShutdown,
-      isEnabled
-    });
+      tracker,
+      closeAndCleanupLabel: (n: number) => trans.__('Shutdown Console'),
+      closeAndCleanup: (current: ConsolePanel) => {
+        return showDialog({
+          title: trans.__('Shut down the Console?'),
+          body: trans.__(
+            'Are you sure you want to close "%1"?',
+            current.title.label
+          ),
+          buttons: [Dialog.cancelButton(), Dialog.warnButton()]
+        }).then(result => {
+          if (result.button.accept) {
+            return current.console.sessionContext.shutdown().then(() => {
+              current.dispose();
+            });
+          } else {
+            return void 0;
+          }
+        });
+      }
+    } as IFileMenu.ICloseAndCleaner<ConsolePanel>);
 
     // Add a kernel user to the Kernel menu
-    mainMenu.kernelMenu.kernelUsers.changeKernel.add({
-      id: CommandIDs.changeKernel,
-      isEnabled
-    });
-    mainMenu.kernelMenu.kernelUsers.clearWidget.add({
-      id: CommandIDs.clear,
-      isEnabled
-    });
-    mainMenu.kernelMenu.kernelUsers.interruptKernel.add({
-      id: CommandIDs.interrupt,
-      isEnabled
-    });
-    mainMenu.kernelMenu.kernelUsers.restartKernel.add({
-      id: CommandIDs.restart,
-      isEnabled
-    });
-    mainMenu.kernelMenu.kernelUsers.shutdownKernel.add({
-      id: CommandIDs.shutdown,
-      isEnabled
-    });
+    mainMenu.kernelMenu.kernelUsers.add({
+      tracker,
+      restartKernelAndClearLabel: n =>
+        trans.__('Restart Kernel and Clear Console'),
+      interruptKernel: current => {
+        const kernel = current.console.sessionContext.session?.kernel;
+        if (kernel) {
+          return kernel.interrupt();
+        }
+        return Promise.resolve(void 0);
+      },
+      restartKernel: current =>
+        sessionDialogs!.restart(current.console.sessionContext, translator),
+      restartKernelAndClear: current => {
+        return sessionDialogs!
+          .restart(current.console.sessionContext)
+          .then(restarted => {
+            if (restarted) {
+              current.console.clear();
+            }
+            return restarted;
+          });
+      },
+      changeKernel: current =>
+        sessionDialogs!.selectKernel(
+          current.console.sessionContext,
+          translator
+        ),
+      shutdownKernel: current => current.console.sessionContext.shutdown()
+    } as IKernelMenu.IKernelUser<ConsolePanel>);
 
     // Add a code runner to the Run menu.
-    mainMenu.runMenu.codeRunners.run.add({
-      id: CommandIDs.runForced,
-      isEnabled
-    });
+    mainMenu.runMenu.codeRunners.add({
+      tracker,
+      runLabel: (n: number) => trans.__('Run Cell'),
+      run: current => current.console.execute(true)
+    } as IRunMenu.ICodeRunner<ConsolePanel>);
 
     // Add a clearer to the edit menu
-    mainMenu.editMenu.clearers.clearCurrent.add({
-      id: CommandIDs.clear,
-      isEnabled
-    });
-
-    // Add undo/redo hooks to the edit menu.
-    mainMenu.editMenu.undoers.redo.add({
-      id: CommandIDs.redo,
-      isEnabled
-    });
-    mainMenu.editMenu.undoers.undo.add({
-      id: CommandIDs.undo,
-      isEnabled
-    });
-
-    // Add kernel information to the application help menu.
-    mainMenu.helpMenu.getKernel.add({
-      id: CommandIDs.getKernel,
-      isEnabled
-    });
+    mainMenu.editMenu.clearers.add({
+      tracker,
+      clearCurrentLabel: (n: number) => trans.__('Clear Console Cell'),
+      clearCurrent: (current: ConsolePanel) => {
+        return current.console.clear();
+      }
+    } as IEditMenu.IClearer<ConsolePanel>);
   }
 
   // For backwards compatibility and clarity, we explicitly label the run
@@ -910,9 +760,7 @@
 
   // Add the execute keystroke setting submenu.
   commands.addCommand(CommandIDs.interactionMode, {
-    label: args =>
-      runShortcutTitles[args['interactionMode'] as string] ??
-      'Set the console interaction mode.',
+    label: args => runShortcutTitles[args['interactionMode'] as string] || '',
     execute: async args => {
       const key = 'keyMap';
       try {
@@ -928,83 +776,13 @@
     isToggled: args => args['interactionMode'] === interactionMode
   });
 
+  if (mainMenu) {
+    // Add kernel information to the application help menu.
+    mainMenu.helpMenu.kernelUsers.add({
+      tracker,
+      getKernel: current => current.sessionContext.session?.kernel
+    } as IHelpMenu.IKernelUser<ConsolePanel>);
+  }
+
   return tracker;
 }
-
-/**
- * Activate the completer service for console.
- */
-function activateConsoleCompleterService(
-  app: JupyterFrontEnd,
-  consoles: IConsoleTracker,
-  manager: ICompletionProviderManager | null,
-  translator: ITranslator | null,
-  appSanitizer: IRenderMime.ISanitizer | null
-): void {
-  if (!manager) {
-    return;
-  }
-
-  const trans = (translator ?? nullTranslator).load('jupyterlab');
-  const sanitizer = appSanitizer ?? new Sanitizer();
-
-  app.commands.addCommand(CommandIDs.invokeCompleter, {
-    label: trans.__('Display the completion helper.'),
-    execute: () => {
-      const id = consoles.currentWidget && consoles.currentWidget.id;
-
-      if (id) {
-        return manager.invoke(id);
-      }
-    }
-  });
-
-  app.commands.addCommand(CommandIDs.selectCompleter, {
-    label: trans.__('Select the completion suggestion.'),
-    execute: () => {
-      const id = consoles.currentWidget && consoles.currentWidget.id;
-
-      if (id) {
-        return manager.select(id);
-      }
-    }
-  });
-
-  app.commands.addKeyBinding({
-    command: CommandIDs.selectCompleter,
-    keys: ['Enter'],
-    selector: '.jp-ConsolePanel .jp-mod-completer-active'
-  });
-  const updateCompleter = async (_: any, consolePanel: ConsolePanel) => {
-    const completerContext = {
-      editor: consolePanel.console.promptCell?.editor ?? null,
-      session: consolePanel.console.sessionContext.session,
-      widget: consolePanel
-    };
-    await manager.updateCompleter(completerContext);
-    consolePanel.console.promptCellCreated.connect((codeConsole, cell) => {
-      const newContext = {
-        editor: cell.editor,
-        session: codeConsole.sessionContext.session,
-        widget: consolePanel,
-        sanitzer: sanitizer
-      };
-      manager.updateCompleter(newContext).catch(console.error);
-    });
-    consolePanel.console.sessionContext.sessionChanged.connect(() => {
-      const newContext = {
-        editor: consolePanel.console.promptCell?.editor ?? null,
-        session: consolePanel.console.sessionContext.session,
-        widget: consolePanel,
-        sanitizer: sanitizer
-      };
-      manager.updateCompleter(newContext).catch(console.error);
-    });
-  };
-  consoles.widgetAdded.connect(updateCompleter);
-  manager.activeProvidersChanged.connect(() => {
-    consoles.forEach(consoleWidget => {
-      updateCompleter(undefined, consoleWidget).catch(e => console.error(e));
-    });
-  });
-}