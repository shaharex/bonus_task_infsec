--- packages\fileeditor-extension\src\index.ts (old)
+++ packages\fileeditor-extension\src\index.ts (new)
@@ -13,63 +13,29 @@
 import {
   createToolbarFactory,
   ICommandPalette,
-  ISanitizer,
   ISessionContextDialogs,
   IToolbarWidgetRegistry,
-  MainAreaWidget,
-  Sanitizer,
-  SessionContextDialogs,
   WidgetTracker
 } from '@jupyterlab/apputils';
-import {
-  CodeViewerWidget,
-  IEditorServices,
-  IPositionModel
-} from '@jupyterlab/codeeditor';
-import {
-  IEditorExtensionRegistry,
-  IEditorLanguageRegistry,
-  IEditorThemeRegistry
-} from '@jupyterlab/codemirror';
-import { ICompletionProviderManager } from '@jupyterlab/completer';
+import { CodeEditor, IEditorServices } from '@jupyterlab/codeeditor';
 import { IConsoleTracker } from '@jupyterlab/console';
 import { DocumentRegistry, IDocumentWidget } from '@jupyterlab/docregistry';
-import { ISearchProviderRegistry } from '@jupyterlab/documentsearch';
-import { IDefaultFileBrowser } from '@jupyterlab/filebrowser';
+import { IFileBrowserFactory } from '@jupyterlab/filebrowser';
 import {
   FileEditor,
-  FileEditorAdapter,
   FileEditorFactory,
-  FileEditorSearchProvider,
   IEditorTracker,
-  LaTeXTableOfContentsFactory,
-  MarkdownTableOfContentsFactory,
-  PythonTableOfContentsFactory,
   TabSpaceStatus
 } from '@jupyterlab/fileeditor';
 import { ILauncher } from '@jupyterlab/launcher';
-import {
-  ILSPCodeExtractorsManager,
-  ILSPDocumentConnectionManager,
-  ILSPFeatureManager,
-  IWidgetLSPAdapterTracker,
-  WidgetLSPAdapterTracker
-} from '@jupyterlab/lsp';
 import { IMainMenu } from '@jupyterlab/mainmenu';
 import { IObservableList } from '@jupyterlab/observables';
-import { IRenderMime } from '@jupyterlab/rendermime-interfaces';
-import { Session } from '@jupyterlab/services';
 import { ISettingRegistry } from '@jupyterlab/settingregistry';
 import { IStatusBar } from '@jupyterlab/statusbar';
-import { ITableOfContentsRegistry } from '@jupyterlab/toc';
-import { ITranslator, nullTranslator } from '@jupyterlab/translation';
-import { IFormRendererRegistry, MenuSvg } from '@jupyterlab/ui-components';
-import { find } from '@lumino/algorithm';
+import { ITranslator } from '@jupyterlab/translation';
 import { JSONObject } from '@lumino/coreutils';
-import { Widget } from '@lumino/widgets';
-
-import { CommandIDs, Commands, FACTORY, IFileTypeData } from './commands';
-import { editorSyntaxStatus } from './syntaxstatus';
+import { Menu } from '@lumino/widgets';
+import { Commands, FACTORY, IFileTypeData } from './commands';
 
 export { Commands } from './commands';
 
@@ -79,14 +45,11 @@
 const plugin: JupyterFrontEndPlugin<IEditorTracker> = {
   activate,
   id: '@jupyterlab/fileeditor-extension:plugin',
-  description: 'Provides the file editor widget tracker.',
   requires: [
     IEditorServices,
-    IEditorExtensionRegistry,
-    IEditorLanguageRegistry,
-    IEditorThemeRegistry,
-    IDefaultFileBrowser,
-    ISettingRegistry
+    IFileBrowserFactory,
+    ISettingRegistry,
+    ITranslator
   ],
   optional: [
     IConsoleTracker,
@@ -95,10 +58,7 @@
     IMainMenu,
     ILayoutRestorer,
     ISessionContextDialogs,
-    ITableOfContentsRegistry,
-    IToolbarWidgetRegistry,
-    ITranslator,
-    IFormRendererRegistry
+    IToolbarWidgetRegistry
   ],
   provides: IEditorTracker,
   autoStart: true
@@ -110,19 +70,12 @@
  */
 export const tabSpaceStatus: JupyterFrontEndPlugin<void> = {
   id: '@jupyterlab/fileeditor-extension:tab-space-status',
-  description: 'Adds a file editor indentation status widget.',
   autoStart: true,
-  requires: [
-    IEditorTracker,
-    IEditorExtensionRegistry,
-    ISettingRegistry,
-    ITranslator
-  ],
+  requires: [IEditorTracker, ISettingRegistry, ITranslator],
   optional: [IStatusBar],
   activate: (
     app: JupyterFrontEnd,
     editorTracker: IEditorTracker,
-    extensions: IEditorExtensionRegistry,
     settingRegistry: ISettingRegistry,
     translator: ITranslator,
     statusBar: IStatusBar | null
@@ -133,18 +86,20 @@
       return;
     }
     // Create a menu for switching tabs vs spaces.
-    const menu = new MenuSvg({ commands: app.commands });
+    const menu = new Menu({ commands: app.commands });
     const command = 'fileeditor:change-tabs';
     const { shell } = app;
     const args: JSONObject = {
+      insertSpaces: false,
+      size: 4,
       name: trans.__('Indent with Tab')
     };
     menu.addItem({ command, args });
-    for (const size of ['1', '2', '4', '8']) {
+    for (const size of [1, 2, 4, 8]) {
       const args: JSONObject = {
+        insertSpaces: true,
         size,
-        // Use a context to differentiate with string set as plural in 3.x
-        name: trans._p('v4', 'Spaces: %1', size)
+        name: trans._n('Spaces: %1', 'Spaces: %1', size)
       };
       menu.addItem({ command, args });
     }
@@ -153,19 +108,18 @@
     const item = new TabSpaceStatus({ menu, translator });
 
     // Keep a reference to the code editor config from the settings system.
-    const updateIndentUnit = (settings: ISettingRegistry.ISettings): void => {
-      item.model!.indentUnit =
-        (settings.get('editorConfig').composite as any)?.indentUnit ??
-        extensions.baseConfiguration.indentUnit ??
-        null;
+    const updateSettings = (settings: ISettingRegistry.ISettings): void => {
+      item.model!.config = {
+        ...CodeEditor.defaultConfig,
+        ...(settings.get('editorConfig').composite as JSONObject)
+      };
     };
-
     void Promise.all([
       settingRegistry.load('@jupyterlab/fileeditor-extension:plugin'),
       app.restored
     ]).then(([settings]) => {
-      updateIndentUnit(settings);
-      settings.changed.connect(updateIndentUnit);
+      updateSettings(settings);
+      settings.changed.connect(updateSettings);
     });
 
     // Add the status item.
@@ -186,76 +140,9 @@
 };
 
 /**
- * Cursor position.
- */
-const lineColStatus: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/fileeditor-extension:cursor-position',
-  description: 'Adds a file editor cursor position status widget.',
-  activate: (
-    app: JupyterFrontEnd,
-    tracker: IEditorTracker,
-    positionModel: IPositionModel
-  ) => {
-    positionModel.addEditorProvider((widget: Widget | null) =>
-      Promise.resolve(
-        widget && tracker.has(widget)
-          ? (widget as IDocumentWidget<FileEditor>).content.editor
-          : null
-      )
-    );
-  },
-  requires: [IEditorTracker, IPositionModel],
-  autoStart: true
-};
-
-const completerPlugin: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/fileeditor-extension:completer',
-  description: 'Adds the completer capability to the file editor.',
-  requires: [IEditorTracker],
-  optional: [ICompletionProviderManager, ITranslator, ISanitizer],
-  activate: activateFileEditorCompleterService,
-  autoStart: true
-};
-
-/**
- * A plugin to search file editors
- */
-const searchProvider: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/fileeditor-extension:search',
-  description: 'Adds search capability to the file editor.',
-  requires: [ISearchProviderRegistry],
-  autoStart: true,
-  activate: (app: JupyterFrontEnd, registry: ISearchProviderRegistry) => {
-    registry.add('jp-fileeditorSearchProvider', FileEditorSearchProvider);
-  }
-};
-
-const languageServerPlugin: JupyterFrontEndPlugin<void> = {
-  id: '@jupyterlab/fileeditor-extension:language-server',
-  description: 'Adds Language Server capability to the file editor.',
-  requires: [
-    IEditorTracker,
-    ILSPDocumentConnectionManager,
-    ILSPFeatureManager,
-    ILSPCodeExtractorsManager,
-    IWidgetLSPAdapterTracker
-  ],
-  activate: activateFileEditorLanguageServer,
-  autoStart: true
-};
-
-/**
  * Export the plugins as default.
  */
-const plugins: JupyterFrontEndPlugin<any>[] = [
-  plugin,
-  lineColStatus,
-  completerPlugin,
-  languageServerPlugin,
-  searchProvider,
-  editorSyntaxStatus,
-  tabSpaceStatus
-];
+const plugins: JupyterFrontEndPlugin<any>[] = [plugin, tabSpaceStatus];
 export default plugins;
 
 /**
@@ -264,26 +151,18 @@
 function activate(
   app: JupyterFrontEnd,
   editorServices: IEditorServices,
-  extensions: IEditorExtensionRegistry,
-  languages: IEditorLanguageRegistry,
-  themes: IEditorThemeRegistry,
-  fileBrowser: IDefaultFileBrowser,
+  browserFactory: IFileBrowserFactory,
   settingRegistry: ISettingRegistry,
+  translator: ITranslator,
   consoleTracker: IConsoleTracker | null,
   palette: ICommandPalette | null,
   launcher: ILauncher | null,
   menu: IMainMenu | null,
   restorer: ILayoutRestorer | null,
-  sessionDialogs_: ISessionContextDialogs | null,
-  tocRegistry: ITableOfContentsRegistry | null,
-  toolbarRegistry: IToolbarWidgetRegistry | null,
-  translator_: ITranslator | null,
-  formRegistry: IFormRendererRegistry | null
+  sessionDialogs: ISessionContextDialogs | null,
+  toolbarRegistry: IToolbarWidgetRegistry | null
 ): IEditorTracker {
   const id = plugin.id;
-  const translator = translator_ ?? nullTranslator;
-  const sessionDialogs =
-    sessionDialogs_ ?? new SessionContextDialogs({ translator });
   const trans = translator.load('jupyterlab');
   const namespace = 'editor';
   let toolbarFactory:
@@ -306,7 +185,6 @@
     editorServices,
     factoryOptions: {
       name: FACTORY,
-      label: trans.__('Editor'),
       fileTypes: ['markdown', '*'], // Explicitly add the markdown fileType so
       defaultFor: ['markdown', '*'], // it outranks the defaultRendered viewer.
       toolbarFactory,
@@ -389,60 +267,6 @@
   // Fetch the initial state of the settings.
   Promise.all([settingRegistry.load(id), restored])
     .then(([settings]) => {
-      // As the menu are defined in the settings we must ensure they are loaded
-      // before updating dynamically the submenu
-      if (menu) {
-        const languageMenu = menu.viewMenu.items.find(
-          item =>
-            item.type === 'submenu' &&
-            item.submenu?.id === 'jp-mainmenu-view-codemirror-language'
-        )?.submenu;
-
-        if (languageMenu) {
-          languages
-            .getLanguages()
-            .sort((a, b) => {
-              const aName = a.name;
-              const bName = b.name;
-              return aName.localeCompare(bName);
-            })
-            .forEach(spec => {
-              // Avoid mode name with a curse word.
-              if (spec.name.toLowerCase().indexOf('brainf') === 0) {
-                return;
-              }
-              languageMenu.addItem({
-                command: CommandIDs.changeLanguage,
-                args: { ...spec } as any // TODO: Casting to `any` until lumino typings are fixed
-              });
-            });
-        }
-        const themeMenu = menu.settingsMenu.items.find(
-          item =>
-            item.type === 'submenu' &&
-            item.submenu?.id === 'jp-mainmenu-settings-codemirror-theme'
-        )?.submenu;
-
-        if (themeMenu) {
-          for (const theme of themes.themes) {
-            themeMenu.addItem({
-              command: CommandIDs.changeTheme,
-              args: {
-                theme: theme.name,
-                displayName: theme.displayName ?? theme.name
-              }
-            });
-          }
-        }
-
-        // Add go to line capabilities to the edit menu.
-        menu.editMenu.goToLiners.add({
-          id: CommandIDs.goToLine,
-          isEnabled: (w: Widget) =>
-            tracker.currentWidget !== null && tracker.has(w)
-        });
-      }
-
       Commands.updateSettings(settings, commands);
       Commands.updateTracker(tracker);
       settings.changed.connect(() => {
@@ -455,18 +279,6 @@
       Commands.updateTracker(tracker);
     });
 
-  if (formRegistry) {
-    const CMRenderer = formRegistry.getRenderer(
-      '@jupyterlab/codemirror-extension:plugin.defaultConfig'
-    );
-    if (CMRenderer) {
-      formRegistry.addRenderer(
-        '@jupyterlab/fileeditor-extension:plugin.editorConfig',
-        CMRenderer
-      );
-    }
-  }
-
   factory.widgetCreated.connect((sender, widget) => {
     // Notify the widget tracker if restore data needs to update.
     widget.context.pathChanged.connect(() => {
@@ -483,45 +295,13 @@
   });
 
   Commands.addCommands(
-    app.commands,
+    commands,
     settingRegistry,
     trans,
     id,
     isEnabled,
     tracker,
-    fileBrowser,
-    extensions,
-    languages,
-    consoleTracker,
-    sessionDialogs,
-    app.shell
-  );
-
-  const codeViewerTracker = new WidgetTracker<MainAreaWidget<CodeViewerWidget>>(
-    {
-      namespace: 'codeviewer'
-    }
-  );
-
-  // Handle state restoration for code viewers
-  if (restorer) {
-    void restorer.restore(codeViewerTracker, {
-      command: CommandIDs.openCodeViewer,
-      args: widget => ({
-        content: widget.content.content,
-        label: widget.content.title.label,
-        mimeType: widget.content.mimeType,
-        widgetId: widget.content.id
-      }),
-      name: widget => widget.content.id
-    });
-  }
-
-  Commands.addOpenCodeViewerCommand(
-    app,
-    editorServices,
-    codeViewerTracker,
-    trans
+    browserFactory
   );
 
   // Add a launcher item if the launcher is available.
@@ -534,7 +314,14 @@
   }
 
   if (menu) {
-    Commands.addMenuItems(menu, tracker, consoleTracker, isEnabled);
+    Commands.addMenuItems(
+      menu,
+      commands,
+      tracker,
+      trans,
+      consoleTracker,
+      sessionDialogs
+    );
   }
 
   getAvailableKernelFileTypes()
@@ -563,122 +350,5 @@
       console.error(reason.message);
     });
 
-  if (tocRegistry) {
-    tocRegistry.add(new LaTeXTableOfContentsFactory(tracker));
-    tocRegistry.add(new MarkdownTableOfContentsFactory(tracker));
-    tocRegistry.add(new PythonTableOfContentsFactory(tracker));
-  }
-
   return tracker;
 }
-
-/**
- * Activate the completer service for file editor.
- */
-function activateFileEditorCompleterService(
-  app: JupyterFrontEnd,
-  editorTracker: IEditorTracker,
-  manager: ICompletionProviderManager | null,
-  translator: ITranslator | null,
-  appSanitizer: IRenderMime.ISanitizer | null
-): void {
-  if (!manager) {
-    return;
-  }
-
-  Commands.addCompleterCommands(
-    app.commands,
-    editorTracker,
-    manager,
-    translator
-  );
-  const sessionManager = app.serviceManager.sessions;
-  const sanitizer = appSanitizer ?? new Sanitizer();
-  const _activeSessions = new Map<string, Session.ISessionConnection>();
-  const updateCompleter = async (
-    _: IEditorTracker,
-    widget: IDocumentWidget<FileEditor>
-  ) => {
-    const completerContext = {
-      editor: widget.content.editor,
-      widget
-    };
-
-    await manager.updateCompleter(completerContext);
-    const onRunningChanged = (
-      _: Session.IManager,
-      models: Session.IModel[]
-    ) => {
-      const oldSession = _activeSessions.get(widget.id);
-      // Search for a matching path.
-      const model = find(models, m => m.path === widget.context.path);
-      if (model) {
-        // If there is a matching path, but it is the same
-        // session as we previously had, do nothing.
-        if (oldSession && oldSession.id === model.id) {
-          return;
-        }
-        // Otherwise, dispose of the old session and reset to
-        // a new CompletionConnector.
-        if (oldSession) {
-          _activeSessions.delete(widget.id);
-          oldSession.dispose();
-        }
-        const session = sessionManager.connectTo({ model });
-        const newCompleterContext = {
-          editor: widget.content.editor,
-          widget,
-          session,
-          sanitizer
-        };
-        manager.updateCompleter(newCompleterContext).catch(console.error);
-        _activeSessions.set(widget.id, session);
-      } else {
-        // If we didn't find a match, make sure
-        // the connector is the contextConnector and
-        // dispose of any previous connection.
-        if (oldSession) {
-          _activeSessions.delete(widget.id);
-          oldSession.dispose();
-        }
-      }
-    };
-
-    onRunningChanged(sessionManager, Array.from(sessionManager.running()));
-    sessionManager.runningChanged.connect(onRunningChanged);
-
-    widget.disposed.connect(() => {
-      sessionManager.runningChanged.disconnect(onRunningChanged);
-      const session = _activeSessions.get(widget.id);
-      if (session) {
-        _activeSessions.delete(widget.id);
-        session.dispose();
-      }
-    });
-  };
-  editorTracker.widgetAdded.connect(updateCompleter);
-  manager.activeProvidersChanged.connect(() => {
-    editorTracker.forEach(editorWidget => {
-      updateCompleter(editorTracker, editorWidget).catch(console.error);
-    });
-  });
-}
-
-function activateFileEditorLanguageServer(
-  app: JupyterFrontEnd,
-  editors: IEditorTracker,
-  connectionManager: ILSPDocumentConnectionManager,
-  featureManager: ILSPFeatureManager,
-  extractorManager: ILSPCodeExtractorsManager,
-  adapterTracker: IWidgetLSPAdapterTracker
-): void {
-  editors.widgetAdded.connect(async (_, editor) => {
-    const adapter = new FileEditorAdapter(editor, {
-      connectionManager,
-      featureManager,
-      foreignCodeExtractorsManager: extractorManager,
-      docRegistry: app.docRegistry
-    });
-    (adapterTracker as WidgetLSPAdapterTracker).add(adapter);
-  });
-}