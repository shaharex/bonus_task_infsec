--- galata\test\jupyterlab\notebook-run-vega.test.ts (old)
+++ galata\test\jupyterlab\notebook-run-vega.test.ts (new)
@@ -1,83 +1,59 @@
 // Copyright (c) Jupyter Development Team.
 // Distributed under the terms of the Modified BSD License.
 
-import {
-  expect,
-  galata,
-  IJupyterLabPageFixture,
-  test
-} from '@jupyterlab/galata';
+import { expect, galata, test } from '@jupyterlab/galata';
 import * as path from 'path';
 
 const fileName = 'vega_notebook.ipynb';
 
-const PNG_MIME_TYPE = 'image/png';
+test.use({ tmpPath: 'notebook-run-vega-test' });
 
-async function nbDiskContent(
-  page: IJupyterLabPageFixture,
-  nbPath: string
-): Promise<string> {
-  await page.notebook.save();
-  // Use the `files` API as figure out the local path is though.
-  const response = await page.request.fetch(`/files/${nbPath}`);
-  if (!response.ok()) {
-    return '';
-  }
-  const buffer = await response.body();
-  return buffer.toString();
-}
-
-test.describe('Notebook Run Vega', () => {
-  test.beforeEach(async ({ page, request, tmpPath }) => {
-    const contents = galata.newContentsHelper(request);
+test.describe.serial('Notebook Run Vega', () => {
+  test.beforeAll(async ({ baseURL, request, tmpPath }) => {
+    const contents = galata.newContentsHelper(baseURL, undefined, request);
     await contents.uploadFile(
       path.resolve(__dirname, `./notebooks/${fileName}`),
       `${tmpPath}/${fileName}`
     );
+  });
 
+  test.beforeEach(async ({ page, tmpPath }) => {
     await page.filebrowser.openDirectory(tmpPath);
+  });
+
+  test.afterAll(async ({ baseURL, request, tmpPath }) => {
+    const contents = galata.newContentsHelper(baseURL, undefined, request);
+    await contents.deleteDirectory(tmpPath);
   });
 
   test('Run notebook with Vega cell in default theme', async ({
     page,
     tmpPath
   }) => {
-    const nbPath = `${tmpPath}/${fileName}`;
-    await page.notebook.openByPath(nbPath);
+    await page.notebook.openByPath(`${tmpPath}/${fileName}`);
     await page.notebook.activate(fileName);
-
-    expect(await nbDiskContent(page, nbPath)).not.toContain(PNG_MIME_TYPE);
 
     const imageName = 'run-cells-vega.png';
 
     await page.notebook.run();
-    await page.locator('.vega-embed').waitFor();
+    const graph = await page.waitForSelector('.vega-embed');
 
-    const nbPanel = await page.notebook.getNotebookInPanelLocator();
-
-    expect(await nbPanel!.screenshot()).toMatchSnapshot(imageName);
-    expect(await nbDiskContent(page, nbPath)).toContain(PNG_MIME_TYPE);
+    expect(await graph.screenshot()).toMatchSnapshot(imageName);
   });
 
   test('Run notebook with Vega cell in dark theme', async ({
     page,
     tmpPath
   }) => {
-    const nbPath = `${tmpPath}/${fileName}`;
-    await page.notebook.openByPath(nbPath);
+    await page.notebook.openByPath(`${tmpPath}/${fileName}`);
     await page.notebook.activate(fileName);
     await page.theme.setDarkTheme();
-
-    expect(await nbDiskContent(page, nbPath)).not.toContain(PNG_MIME_TYPE);
 
     const imageName = 'run-cells-dark-vega.png';
 
     await page.notebook.run();
-    await page.locator('.vega-embed').waitFor();
+    const graph = await page.waitForSelector('.vega-embed');
 
-    const nbPanel = await page.notebook.getNotebookInPanelLocator();
-
-    expect(await nbPanel!.screenshot()).toMatchSnapshot(imageName);
-    expect(await nbDiskContent(page, nbPath)).toContain(PNG_MIME_TYPE);
+    expect(await graph.screenshot()).toMatchSnapshot(imageName);
   });
 });